<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 도징 계산기 (로그 기능 탑재)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .input-group { display: flex; align-items: center; margin-bottom: 1rem; }
        .input-group label { flex: 1; font-weight: 600; color: #4A5568; }
        .input-group input { flex: 2; padding: 0.5rem; border: 1px solid #CBD5E0; border-radius: 0.375rem; text-align: right; }
        .input-group .unit { margin-left: 0.5rem; min-width: 40px; color: #718096; }
        .result-item { padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem; font-weight: 500; }
        .result-good { background-color: #E6FFFA; color: #234E52; border-left: 4px solid #38B2AC; }
        .result-low { background-color: #FFF5F5; color: #C53030; border-left: 4px solid #FC8181; }
        .result-high { background-color: #FAF5FF; color: #6B46C1; border-left: 4px solid #B794F4; }
        .result-action { background-color: #FEFCBF; color: #744210; border-left: 4px solid #F6E05E; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4F46E5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #history-table th, #history-table td { padding: 0.5rem; text-align: center; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-blue-50">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800">해수어항 도징 및 관리 로그</h1>
            <p class="text-gray-600 mt-2">현재 어항의 수치를 입력하고 기록하여 변화를 추적하세요.</p>
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 입력 폼 (lg 화면에서 1/3 차지) -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700 border-b pb-2">어항 정보 입력</h2>
                
                <div class="input-group">
                    <label for="tankVolume">어항 용량</label>
                    <input type="number" id="tankVolume" placeholder="160"><span class="unit">L</span>
                </div>
                <hr class="my-4">
                <div class="input-group"><label for="temp">온도</label><input type="number" step="0.1" id="temp" placeholder="26.0"><span class="unit">°C</span></div>
                <div class="input-group"><label for="salinity">염도</label><input type="number" step="0.1" id="salinity" placeholder="34.5"><span class="unit">ppt</span></div>
                <div class="input-group"><label for="ph">pH</label><input type="number" step="0.1" id="ph" placeholder="8.1"><span class="unit"></span></div>
                <div class="input-group"><label for="ca">칼슘</label><input type="number" id="ca" placeholder="420"><span class="unit">ppm</span></div>
                <div class="input-group"><label for="mg">마그네슘</label><input type="number" id="mg" placeholder="1350"><span class="unit">ppm</span></div>
                <div class="input-group"><label for="kh">알칼리니티</label><input type="number" step="0.1" id="kh" placeholder="8.0"><span class="unit">dKH</span></div>
                <hr class="my-4">
                <div class="input-group"><label for="no2">아질산염</label><input type="number" step="0.01" id="no2" placeholder="0.0"><span class="unit">ppm</span></div>
                <div class="input-group"><label for="no3">질산염</label><input type="number" id="no3" placeholder="1.0"><span class="unit">ppm</span></div>
                <div class="input-group"><label for="po4">인산염</label><input type="number" step="0.01" id="po4" placeholder="0.05"><span class="unit">ppm</span></div>

                <button id="calculate-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">계산하기</button>
                <button id="save-btn" class="w-full mt-2 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 hidden">오늘 기록 저장</button>
            </div>

            <!-- 결과 및 로그 표시 (lg 화면에서 2/3 차지) -->
            <div class="lg:col-span-2 space-y-8">
                <!-- 결과 표시 -->
                <div id="results-container" class="bg-white p-6 rounded-lg shadow-lg hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-blue-700 border-b pb-2">계산 결과 및 권장 사항</h2>
                    <div id="results-output" class="space-y-3"></div>
                    <button id="ai-advisor-btn" class="w-full mt-6 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 hidden">✨ AI 어드바이저에게 물어보기</button>
                    <div id="ai-advisor-result" class="mt-6 hidden">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 border-b pb-2">✨ AI 어드바이저 분석</h3>
                        <div id="ai-loading" class="flex justify-center items-center py-4"><div class="spinner"></div><p class="ml-4 text-gray-600">AI가 어항 상태를 분석중입니다...</p></div>
                        <div id="ai-output" class="p-4 bg-indigo-50 rounded-lg text-gray-800 whitespace-pre-wrap"></div>
                    </div>
                    <div class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-r-lg"><p class="font-bold">⚠️ 중요 주의사항</p><p class="text-sm">본 계산 결과는 일반적인 참고용이며, 사용하는 도징 제품의 설명서를 반드시 우선적으로 확인하세요. 어항의 상태를 지속적으로 관찰하며 소량씩 나누어 안전하게 도징하는 것을 권장합니다.</p></div>
                </div>

                <!-- 관리 로그 -->
                <div id="history-container" class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h2 class="text-2xl font-semibold text-blue-700">어항 관리 로그</h2>
                        <button id="clear-history-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300 text-sm">전체 기록 삭제</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="history-table" class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th>날짜</th><th>온도</th><th>염도</th><th>pH</th><th>Ca</th><th>Mg</th><th>KH</th><th>NO2</th><th>NO3</th><th>PO4</th><th>삭제</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- 로그 데이터가 여기에 동적으로 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase 모듈 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        // 중요: 로그 기능을 사용하려면 아래 firebaseConfig 객체를 자신의 Firebase 프로젝트 정보로 교체해야 합니다.
        const firebaseConfig = {
            apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // --- AI 어드바이저를 위한 별도 API 키 ---
        // 중요: AI 어드바이저 기능을 사용하려면, 아래에 Google AI Studio에서 발급받은 API 키를 입력해야 합니다.
        const GEMINI_API_KEY = "AIzaSyDmNRfLSvkZMWeAmr-bqhXnyVmhY2C75zQ"; // <--- 여기에 AI Studio 키를 붙여넣으세요.


        // DOM 요소
        const calculateBtn = document.getElementById('calculate-btn');
        const saveBtn = document.getElementById('save-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsOutput = document.getElementById('results-output');
        const aiAdvisorBtn = document.getElementById('ai-advisor-btn');
        const aiAdvisorResult = document.getElementById('ai-advisor-result');
        const aiLoading = document.getElementById('ai-loading');
        const aiOutput = document.getElementById('ai-output');
        const historyContainer = document.getElementById('history-container');
        const historyTableBody = document.getElementById('history-table-body');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
 
        let currentInputs = {};
        let currentRecommendations = [];
        
        const targets = {
            temp: { min: 25.5, max: 26.5 }, salinity: { min: 34, max: 35 }, ph: { min: 8.0, max: 8.3 },
            ca: { min: 400, max: 440, target: 420 }, mg: { min: 1250, max: 1440, target: 1350 },
            kh: { min: 7.5, max: 8.5, target: 8.0 }, no2: { max: 0 },
            no3: { min: 0.5, max: 2.0, target: 1.0 }, po4: { min: 0.03, max: 0.08, target: 0.05 }
        };

        const dosingFormulas = {
            ca: (rise, volume) => (rise / 2) * (volume / 100),
            mg: (rise, volume) => rise * (volume / 100),
            kh: (rise, volume) => (rise / 0.1) * (volume / 100),
        };
        
        function getNo3Dose(rise) { if (rise <= 0.2) return 0; if (rise <= 0.4) return 0.3; if (rise <= 0.7) return 0.6; if (rise <= 1.0) return 0.9; return (rise / 1.0) * 0.9; }
        function getPo4Dose(rise) { if (rise <= 0.009) return 0; if (rise <= 0.02) return 0.3; if (rise <= 0.035) return 0.6; return (rise / 0.035) * 0.6; }

        
        function handleCalculate() {
            currentInputs = {
                tankVolume: parseFloat(document.getElementById('tankVolume').value), temp: parseFloat(document.getElementById('temp').value),
                salinity: parseFloat(document.getElementById('salinity').value), ph: parseFloat(document.getElementById('ph').value),
                ca: parseFloat(document.getElementById('ca').value), mg: parseFloat(document.getElementById('mg').value),
                kh: parseFloat(document.getElementById('kh').value), no2: parseFloat(document.getElementById('no2').value),
                no3: parseFloat(document.getElementById('no3').value), po4: parseFloat(document.getElementById('po4').value),
            };

            if (isNaN(currentInputs.tankVolume) || currentInputs.tankVolume <= 0) { alert('어항 용량을 올바르게 입력해주세요.'); return; }

            resultsOutput.innerHTML = '';
            currentRecommendations = [];

            for (const key in targets) {
                if (isNaN(currentInputs[key])) continue;
                const currentVal = currentInputs[key]; const target = targets[key];
                let message = ''; let type = 'result-good';
                switch (key) {
                    case 'ca': case 'mg': case 'kh':
                        if (currentVal < target.min) {
                            const riseAmount = target.target - currentVal; const dose = dosingFormulas[key](riseAmount, currentInputs.tankVolume);
                            const dailyDose = (dose / 7).toFixed(1);
                            message = `${key.toUpperCase()}: 낮음. 목표치(${target.target}ppm)까지 ${riseAmount.toFixed(1)}ppm 올리려면 약 ${dose.toFixed(1)}ml 도징 필요. (매일 약 ${dailyDose}ml 씩 7일간 분할 도징 권장)`;
                            type = 'result-low';
                        } else if (currentVal > target.max) { message = `${key.toUpperCase()}: 높음. 환수 또는 도징 중단으로 조절 필요.`; type = 'result-high';
                        } else { message = `${key.toUpperCase()}: 안정적인 수치입니다.`; }
                        break;
                    case 'no2':
                        if (currentVal > target.max) { message = `${key.toUpperCase()}: 검출됨! 즉시 20% 환수를 권장합니다.`; type = 'result-action';
                        } else { message = `${key.toUpperCase()}: 안정적인 수치입니다. (검출 안됨)`; }
                        break;
                    case 'no3': case 'po4':
                        if (currentVal < target.min) {
                            const riseAmount = target.target - currentVal; const dose = (key === 'no3') ? getNo3Dose(riseAmount) : getPo4Dose(riseAmount);
                            message = `${key.toUpperCase()}: 낮음. 목표치(${target.target})까지 ${riseAmount.toFixed(key === 'no3' ? 2 : 3)} 올리려면 약 ${dose.toFixed(1)}ml 도징 필요. (주의: 소량씩 테스트하며 조절하세요.)`;
                            type = 'result-low';
                        } else if (currentVal > target.max) { message = `${key.toUpperCase()}: 높음. 20% 환수 또는 리무버 사용을 권장합니다.`; type = 'result-high';
                        } else { message = `${key.toUpperCase()}: 안정적인 수치입니다.`; }
                        break;
                    default:
                        if (currentVal < target.min) { message = `${key.toUpperCase()}: 낮음. 목표 범위(${target.min}~${target.max})로 조절해주세요.`; type = 'result-low';
                        } else if (currentVal > target.max) { message = `${key.toUpperCase()}: 높음. 목표 범위(${target.min}~${target.max})로 조절해주세요.`; type = 'result-high';
                        } else { message = `${key.toUpperCase()}: 안정적인 수치입니다.`; }
                        break;
                }
                currentRecommendations.push({text: message, type: type});
            }
            
            if (currentRecommendations.length === 0) { resultsOutput.innerHTML = '<p>분석할 데이터가 없습니다. 수치를 입력해주세요.</p>';
            } else { currentRecommendations.forEach(rec => { const p = document.createElement('p'); p.className = `result-item ${rec.type}`; p.textContent = rec.text; resultsOutput.appendChild(p); }); }

            resultsContainer.classList.remove('hidden');
            aiAdvisorBtn.classList.remove('hidden');
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("AIzaSyXXX")) {
                 saveBtn.classList.remove('hidden');
            }
            aiAdvisorResult.classList.add('hidden');
        }

        async function handleAiAdvisor() {
            // 이 if문은 헷갈리지 않도록 원래대로 되돌렸습니다.
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                aiAdvisorResult.classList.remove('hidden');
                aiLoading.style.display = 'none';
                aiOutput.innerText = "AI 어드바이저 기능이 비활성화되었습니다. 코드를 수정하여 Google AI Studio에서 발급받은 'AI 로봇 전용 열쇠'를 입력해주세요.";
                return;
            }

            aiAdvisorResult.classList.remove('hidden'); aiLoading.style.display = 'flex'; aiOutput.innerHTML = '';
            let prompt = `당신은 세계 최고의 해수어항 관리 전문가입니다. 아래는 한 사용자의 어항 데이터와 1차적인 권장 사항입니다. 이 정보를 바탕으로, 전문가의 입장에서 종합적인 분석과 조언을 친절하고 상세하게 제공해주세요. **사용자 어항 정보:**\n- 어항 용량: ${currentInputs.tankVolume}L\n- 온도: ${currentInputs.temp}°C\n- 염도: ${currentInputs.salinity} ppt\n- pH: ${currentInputs.ph}\n- 칼슘(Ca): ${currentInputs.ca} ppm\n- 마그네슘(Mg): ${currentInputs.mg} ppm\n- 알칼리니티(KH): ${currentInputs.kh} dKH\n- 아질산염(NO2): ${currentInputs.no2} ppm\n- 질산염(NO3): ${currentInputs.no3} ppm\n- 인산염(PO4): ${currentInputs.po4} ppm\n\n**시스템의 1차 권장 사항:**\n${currentRecommendations.map(r => `- ${r.text}`).join('\n')}\n\n**분석 및 조언 요청:**\n1.  **종합 진단:** 현재 어항의 전반적인 상태를 한두 문장으로 요약해주세요.\n2.  **상세 분석:** 각 수치들이 서로에게 어떤 영향을 미치는지, 그리고 현재 수치가 산호나 생물에게 어떤 의미인지 설명해주세요. (예: KH가 낮으면 pH 안정성이 떨어질 수 있습니다.)\n3.  **실행 계획:** 1차 권장 사항을 바탕으로, 사용자가 따라하기 쉬운 단계별 실행 계획을 제시해주세요. 특히 도징 시 주의할 점을 강조해주세요.\n4.  **장기적 관리 팁:** 현재 상태를 바탕으로 앞으로 어항을 더 안정적으로 유지하기 위한 팁을 2~3가지 제안해주세요. (예: 질산염 관리를 위한 조언, 장비 점검 등)\n\n결과는 한국어로, 전문가적이면서도 이해하기 쉽게 작성해주세요.`;
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API 호출 실패: ${response.statusText}`); }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) { aiOutput.innerText = result.candidates[0].content.parts[0].text;
                } else { throw new Error("API로부터 유효한 응답을 받지 못했습니다."); }
            } catch (error) { console.error("Gemini API Error:", error); aiOutput.innerText = `AI 어드바이저를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.\n오류: ${error.message}`;
            } finally { aiLoading.style.display = 'none'; }
        }

        function initializeFirebase() {
            let app, db, auth, userId, recordsCollectionRef;
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase 초기화 오류:", e);
                disableFirebaseFeatures("Firebase 구성 정보가 올바르지 않습니다.");
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    recordsCollectionRef = collection(db, 'users', userId, 'reef-tank-logs');
                    listenForRecords(recordsCollectionRef);
                    attachFirebaseEventListeners(recordsCollectionRef);
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Firebase 익명 로그인 오류:", error);
                        disableFirebaseFeatures("Firebase 인증에 실패했습니다.");
                    }
                }
            });
        }

        function disableFirebaseFeatures(message) {
            historyContainer.innerHTML = `
                <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-r-lg">
                    <p class="font-bold">로그 기능 비활성화됨</p>
                    <p class="text-sm mt-1">${message}</p>
                </div>`;
            saveBtn.style.display = 'none';
        }

        function listenForRecords(recordsRef) {
            const q = query(recordsRef, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                historyTableBody.innerHTML = '';
                if (snapshot.empty) {
                    historyTableBody.innerHTML = `<tr><td colspan="11" class="text-gray-500 py-4">저장된 기록이 없습니다.</td></tr>`;
                } else {
                    snapshot.forEach(doc => {
                        const record = doc.data();
                        const tr = document.createElement('tr');
                        tr.className = "border-b hover:bg-gray-50";
                        tr.innerHTML = `
                            <td>${record.createdAt ? new Date(record.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '날짜 없음'}</td>
                            <td>${record.temp || '-'}</td><td>${record.salinity || '-'}</td><td>${record.ph || '-'}</td>
                            <td>${record.ca || '-'}</td><td>${record.mg || '-'}</td><td>${record.kh || '-'}</td>
                            <td>${record.no2 || '-'}</td><td>${record.no3 || '-'}</td><td>${record.po4 || '-'}</td>
                            <td><button data-id="${doc.id}" class="delete-btn text-red-500 hover:text-red-700 font-bold">X</button></td>
                        `;
                        historyTableBody.appendChild(tr);
                    });
                }
            }, (error) => {
                console.error("기록 수신 오류:", error);
                historyTableBody.innerHTML = `<tr><td colspan="11" class="text-red-500 py-4">기록을 불러오는 데 실패했습니다.</td></tr>`;
            });
        }

        function attachFirebaseEventListeners(recordsCollectionRef) {
            saveBtn.addEventListener('click', async () => {
                const hasValues = Object.values(currentInputs).some(v => !isNaN(v));
                if (!hasValues || isNaN(currentInputs.tankVolume)) { return; }
                const record = { ...currentInputs, createdAt: serverTimestamp() };
                try { await addDoc(recordsCollectionRef, record); } catch (error) { console.error("기록 저장 오류:", error); }
            });

            historyTableBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const docId = e.target.dataset.id;
                    try { await deleteDoc(doc(recordsCollectionRef, docId)); } catch (error) { console.error("기록 삭제 오류:", error); }
                }
            });

            let clearConfirmState = false;
            let clearConfirmTimeout;
            clearHistoryBtn.addEventListener('click', async () => {
                if (!clearConfirmState) {
                    clearConfirmState = true;
                    clearHistoryBtn.textContent = '정말 삭제하시겠습니까?';
                    clearHistoryBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    clearHistoryBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    clearConfirmTimeout = setTimeout(() => {
                        clearConfirmState = false;
                        clearHistoryBtn.textContent = '전체 기록 삭제';
                        clearHistoryBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                        clearHistoryBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    }, 4000);
                    return;
                }
                clearTimeout(clearConfirmTimeout);
                try {
                    const snapshot = await getDocs(recordsCollectionRef);
                    const deletePromises = [];
                    snapshot.forEach(doc => { deletePromises.push(deleteDoc(doc.ref)); });
                    await Promise.all(deletePromises);
                } catch (error) {
                    console.error("전체 기록 삭제 오류:", error);
                } finally {
                    clearConfirmState = false;
                    clearHistoryBtn.textContent = '전체 기록 삭제';
                    clearHistoryBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    clearHistoryBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                }
            });
        }

        calculateBtn.addEventListener('click', handleCalculate);
        aiAdvisorBtn.addEventListener('click', handleAiAdvisor);
        
        if (firebaseConfig.apiKey && !firebaseConfig.apiKey.startsWith("AIzaSyXXX")) {
            initializeFirebase();
        } else {
            disableFirebaseFeatures("로그 기능을 사용하려면 Firebase 설정이 필요합니다.");
        }

    </script>
</body>
</html>
