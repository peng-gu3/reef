<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 관리 일지 Pro</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 및 ReactDOM 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel 로드 (JSX 변환용) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts 의존성 라이브러리 (Prop-Types) 로드 -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <!-- Recharts (그래프 라이브러리) 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
    <style>
        body {
            background-color: #1a202c; /* bg-gray-900 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 설정: 수질 기준치 및 도징 계산 정보 ---
        const TARGET_RANGES = {
          temp: { min: 25.5, max: 26.5, unit: '°C' },
          salinity: { min: 34.0, max: 35.0, unit: 'ppt' },
          ph: { min: 8.0, max: 8.4, unit: '' },
          kh: { min: 7.3, max: 8.0, unit: 'dKH' },
          calcium: { min: 400, max: 430, unit: 'ppm' },
          magnesium: { min: 1350, max: 1440, unit: 'ppm' },
          nitrate: { min: 0.5, max: 2.0, unit: 'ppm' },
          phosphate: { min: 0.03, max: 0.07, unit: 'ppm' },
        };

        // 도징 계산 로직
        const calculateDosing = (log, waterVolume) => {
          const dosing = {};
          if (!log || typeof waterVolume !== 'number' || waterVolume <= 0) return dosing;

          // KH: 1ml/100L 당 0.1dKH 상승 -> (필요량 * 물량) / 10
          if (log.kh < TARGET_RANGES.kh.min) {
            const requiredIncrease = TARGET_RANGES.kh.min - log.kh;
            dosing.kh = ((waterVolume * requiredIncrease) / 10).toFixed(2);
          }
          // Calcium: 1ml/100L 당 2ppm 상승 -> (필요량 * 물량) / 200
          if (log.calcium < TARGET_RANGES.calcium.min) {
            const requiredIncrease = TARGET_RANGES.calcium.min - log.calcium;
            dosing.calcium = ((waterVolume * requiredIncrease) / 200).toFixed(2);
          }
          // Magnesium: 1ml/100L 당 1ppm 상승 -> (필요량 * 물량) / 100
          if (log.magnesium < TARGET_RANGES.magnesium.min) {
            const requiredIncrease = TARGET_RANGES.magnesium.min - log.magnesium;
            dosing.magnesium = ((waterVolume * requiredIncrease) / 100).toFixed(2);
          }
          // Nitrate: 1ml/100L 당 1ppm 상승 -> (필요량 * 물량) / 100
          if (log.nitrate < TARGET_RANGES.nitrate.min) {
              const requiredIncrease = TARGET_RANGES.nitrate.min - log.nitrate;
              dosing.nitrate = ((waterVolume * requiredIncrease) / 100).toFixed(2);
          }
          // Phosphate: 1ml/100L 당 0.1ppm 상승 -> (필요량 * 물량) / 10
          if (log.phosphate < TARGET_RANGES.phosphate.min) {
              const requiredIncrease = TARGET_RANGES.phosphate.min - log.phosphate;
              dosing.phosphate = ((waterVolume * requiredIncrease) / 10).toFixed(2);
          }
          return dosing;
        };


        const App = () => {
          // --- 상태 관리 (useState) ---
          const [waterVolume, setWaterVolume] = useState(200);
          const [logs, setLogs] = useState([]);
          const [dosingStatus, setDosingStatus] = useState({});

          const [newLog, setNewLog] = useState({
            date: new Date().toISOString().slice(0, 10),
            temp: '', salinity: '', ph: '', kh: '',
            calcium: '', magnesium: '', nitrite: '0', nitrate: '', phosphate: '',
            notes: ''
          });

          // --- useEffect ---
          // 컴포넌트 로드 시 초기 데이터 설정
          useEffect(() => {
            const initialLogs = [
                { id: 1, date: '2025-07-30', temp: 26.0, salinity: 35.0, ph: 8.1, kh: 7.0, calcium: 380, magnesium: 1300, nitrite: 0, nitrate: 2.0, phosphate: 0.05, notes: '초기 데이터' },
                { id: 2, date: '2025-08-01', temp: 25.8, salinity: 34.5, ph: 8.2, kh: 7.5, calcium: 410, magnesium: 1350, nitrite: 0, nitrate: 1.5, phosphate: 0.04, notes: '환수 후 안정' }
            ];
            setLogs(initialLogs);
          }, []);


          // --- 이벤트 핸들러 ---
          const handleInputChange = (e) => {
            const { name, value } = e.target;
            setNewLog({ ...newLog, [name]: value });
          };

          const handleAddLog = (e) => {
            e.preventDefault();
            const requiredFields = ['date', 'temp', 'salinity', 'ph', 'kh', 'calcium', 'magnesium', 'nitrite', 'nitrate', 'phosphate'];
            if (requiredFields.some(field => !newLog[field])) {
              alert('모든 수질 항목을 입력해주세요.');
              return;
            }
            
            const logToAdd = {
              id: Date.now(),
              ...newLog,
              temp: parseFloat(newLog.temp),
              salinity: parseFloat(newLog.salinity),
              ph: parseFloat(newLog.ph),
              kh: parseFloat(newLog.kh),
              calcium: parseFloat(newLog.calcium),
              magnesium: parseFloat(newLog.magnesium),
              nitrite: parseFloat(newLog.nitrite),
              nitrate: parseFloat(newLog.nitrate),
              phosphate: parseFloat(newLog.phosphate),
            };

            setLogs([...logs, logToAdd].sort((a, b) => new Date(a.date) - new Date(b.date)));
            setNewLog({
                date: new Date().toISOString().slice(0, 10), temp: '', salinity: '', ph: '', kh: '',
                calcium: '', magnesium: '', nitrite: '0', nitrate: '', phosphate: '', notes: ''
            });
          };

          const handleDeleteLog = (idToDelete) => {
            if (window.confirm('정말로 이 기록을 삭제하시겠습니까?')) {
                setLogs(logs.filter(log => log.id !== idToDelete));
            }
          };
          
          const toggleDosingStatus = (logId, param) => {
            setDosingStatus(prev => ({
                ...prev,
                [`${logId}-${param}`]: !prev[`${logId}-${param}`]
            }));
          };

          // --- 그래프 렌더링 함수 ---
          const renderChart = () => {
            if (!window.Recharts) {
              return (
                <div className="flex items-center justify-center h-full text-yellow-400">
                  그래프 라이브러리 로딩 중...
                </div>
              );
            }

            const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;
            return (
              <ResponsiveContainer width="100%" height={400}>
                <LineChart data={logs} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#4A5568" />
                    <XAxis dataKey="date" stroke="#A0AEC0" />
                    <YAxis yAxisId="left" stroke="#8884d8" domain={['dataMin - 1', 'dataMax + 1']} />
                    <YAxis yAxisId="right" orientation="right" stroke="#82ca9d" domain={['dataMin - 50', 'dataMax + 50']} />
                    <Tooltip contentStyle={{ backgroundColor: '#1A202C', border: '1px solid #4A5568' }} />
                    <Legend wrapperStyle={{ color: '#E2E8F0' }} />
                    <Line yAxisId="left" type="monotone" dataKey="kh" stroke="#8884d8" name="KH" />
                    <Line yAxisId="right" type="monotone" dataKey="calcium" stroke="#82ca9d" name="Calcium (ppm)" />
                    <Line yAxisId="right" type="monotone" dataKey="magnesium" stroke="#ffc658" name="Magnesium (ppm)" />
                    <Line yAxisId="left" type="monotone" dataKey="nitrate" stroke="#ff8042" name="Nitrate (ppm)" />
                    <Line yAxisId="left" type="monotone" dataKey="phosphate" stroke="#d0ed57" name="Phosphate (ppm)" />
                </LineChart>
              </ResponsiveContainer>
            );
          };

          return (
            <div className="bg-gray-900 text-white min-h-screen font-sans p-4 md:p-8">
              <div className="container mx-auto max-w-7xl">
                
                <header className="text-center mb-8">
                  <h1 className="text-4xl font-bold text-cyan-400">해수어항 관리 일지 Pro</h1>
                  <p className="text-gray-400 mt-2">데이터 기반 어항 관리 시스템</p>
                </header>

                <div className="bg-gray-800 p-4 rounded-xl mb-8">
                  <label className="font-bold text-lg mr-4">수조 총 물량 (L):</label>
                  <input 
                    type="number"
                    value={waterVolume}
                    onChange={(e) => setWaterVolume(parseInt(e.target.value, 10) || 0)}
                    className="bg-gray-700 w-32 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  />
                </div>

                <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8 h-[450px]">
                    <h2 className="text-2xl font-semibold mb-4 text-center">수질 변화 그래프</h2>
                    {renderChart()}
                </div>

                <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 mb-8">
                  <h2 className="text-2xl font-semibold mb-4">새 일지 작성</h2>
                  <form onSubmit={handleAddLog} className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <input type="date" name="date" value={newLog.date} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.1" name="temp" placeholder={`온도 (°C)`} value={newLog.temp} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.1" name="salinity" placeholder={`염도 (ppt)`} value={newLog.salinity} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.1" name="ph" placeholder={`pH`} value={newLog.ph} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.1" name="kh" placeholder={`KH (dKH)`} value={newLog.kh} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" name="calcium" placeholder={`칼슘 (ppm)`} value={newLog.calcium} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" name="magnesium" placeholder={`마그네슘 (ppm)`} value={newLog.magnesium} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.01" name="nitrite" placeholder={`아질산 (ppm)`} value={newLog.nitrite} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.01" name="nitrate" placeholder={`질산염 (ppm)`} value={newLog.nitrate} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="number" step="0.01" name="phosphate" placeholder={`인산염 (ppm)`} value={newLog.phosphate} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg" />
                    <input type="text" name="notes" placeholder="특이사항" value={newLog.notes} onChange={handleInputChange} className="bg-gray-700 p-2 rounded-lg col-span-2 lg:col-span-4" />
                    <button type="submit" className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 col-span-2 lg:col-span-1">일지 추가</button>
                  </form>
                </div>

                <main>
                  <h2 className="text-2xl font-semibold mb-4">전체 기록</h2>
                  <div className="space-y-4">
                    {logs.map(log => {
                      const dosings = calculateDosing(log, waterVolume);
                      const isOutOfRange = (param) => log[param] < TARGET_RANGES[param].min || log[param] > TARGET_RANGES[param].max;
                      return (
                        <div key={log.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                          <div className="flex justify-between items-start mb-3">
                            <p className="font-bold text-lg text-cyan-400">{log.date}</p>
                            <button onClick={() => handleDeleteLog(log.id)} className="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded-lg">삭제</button>
                          </div>
                          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-x-4 gap-y-2 text-sm mb-4">
                              <p className={isOutOfRange('temp') ? 'text-red-400' : ''}>🌡️ 온도: {log.temp} °C</p>
                              <p className={isOutOfRange('salinity') ? 'text-red-400' : ''}>💧 염도: {log.salinity} ppt</p>
                              <p className={isOutOfRange('ph') ? 'text-red-400' : ''}>🧪 pH: {log.ph}</p>
                              <p className={isOutOfRange('kh') ? 'text-red-400' : ''}>💎 KH: {log.kh} dKH</p>
                              <p className={isOutOfRange('calcium') ? 'text-red-400' : ''}>🦴 칼슘: {log.calcium} ppm</p>
                              <p className={isOutOfRange('magnesium') ? 'text-red-400' : ''}>🔩 마그네슘: {log.magnesium} ppm</p>
                              <p className={log.nitrite > 0 ? 'text-red-400' : ''}>🚫 아질산: {log.nitrite} ppm</p>
                              <p className={isOutOfRange('nitrate') ? 'text-red-400' : ''}>🌿 질산염: {log.nitrate} ppm</p>
                              <p className={isOutOfRange('phosphate') ? 'text-red-400' : ''}>🦠 인산염: {log.phosphate} ppm</p>
                          </div>
                          <div className="border-t border-gray-700 pt-3">
                              <h4 className="font-semibold text-md mb-2">도징 관리</h4>
                              <div className="flex flex-wrap gap-4">
                                  {Object.keys(dosings).map(param => (
                                      <div key={param}>
                                          <button 
                                              onClick={() => toggleDosingStatus(log.id, param)}
                                              className={`py-1 px-3 rounded-lg text-xs font-bold ${dosingStatus[`${log.id}-${param}`] ? 'bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600'}`}
                                          >
                                              {param.toUpperCase()}: {dosings[param]}ml {dosingStatus[`${log.id}-${param}`] ? '✔️ 도징 완료' : '❓ 도징 예정'}
                                          </button>
                                      </div>
                                  ))}
                                  {Object.keys(dosings).length === 0 && <p className="text-sm text-gray-400">모든 수치가 안정적입니다. (도징 필요 없음)</p>}
                                  <button onClick={() => alert(`박터오리진 도징 완료 처리 (100L당 1방울)`)} className="bg-purple-600 hover:bg-purple-700 py-1 px-3 rounded-lg text-xs font-bold">박터오리진 도징</button>
                              </div>
                          </div>
                          {log.notes && <p className="mt-3 text-gray-300 text-sm"><span className="font-semibold">📝 특이사항:</span> {log.notes}</p>}
                        </div>
                      )
                    })}
                  </div>
                </main>

              </div>
            </div>
          );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
