<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>해수어항 관리 도징 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #F0F4F8; }
    .container { max-width: 800px; margin: auto; padding: 1rem; }
    .input-group { display: flex; align-items: center; margin-bottom: 1rem; }
    .input-group label { flex: 1; font-weight: 600; color: #374151; }
    .input-group input { flex: 2; padding: 0.5rem; border: 1px solid #CBD5E0; border-radius: 0.375rem; text-align: right; }
    .input-unit { margin-left: 0.5rem; color: #6B7280; min-width: 30px; }
    .button { width: 100%; padding: 0.75rem; font-weight: 600; border-radius: 0.375rem; }
    #results { margin-top: 1rem; }
    .result-item { padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; }
    .low { background-color: #FEF2F2; border-left: 4px solid #F56565; }
    .high { background-color: #F5F3FF; border-left: 4px solid #A78BFA; }
    .good { background-color: #ECFFFA; border-left: 4px solid #38B2AC; }
    #log-table th, #log-table td { padding: 0.5rem; text-align: center; font-size: 0.875rem; }
    #graph-modal { display: none; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); }
    .modal-content { background: white; border-radius: 0.5rem; padding: 1rem; max-width: 90%; max-height: 80%; margin: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">해수어항 관리 도징 계산기</h1>
    <div>
      <div class="input-group"><label for="date">날짜</label><input type="date" id="date" class="border" /></div>
      <div class="input-group"><label for="volume">어항 용량</label><input type="number" id="volume"><span class="input-unit">L</span></div>
      <div class="input-group"><label for="temp">온도</label><input type="number" step="0.1" id="temp"><span class="input-unit">°C</span></div>
      <div class="input-group"><label for="salinity">염도</label><input type="number" step="0.1" id="salinity"><span class="input-unit">ppt</span></div>
      <div class="input-group"><label for="ph">pH</label><input type="number" step="0.1" id="ph"></div>
      <div class="input-group"><label for="ca">칼슘 (Ca)</label><input type="number" id="ca"><span class="input-unit">ppm</span></div>
      <div class="input-group"><label for="mg">마그네슘 (Mg)</label><input type="number" id="mg"><span class="input-unit">ppm</span></div>
      <div class="input-group"><label for="kh">알칼리니티 (KH)</label><input type="number" step="0.1" id="kh"><span class="input-unit">dKH</span></div>
      <div class="input-group"><label for="no2">아질산염 (NO₂)</label><input type="number" step="0.01" id="no2"><span class="input-unit">ppm</span></div>
      <div class="input-group"><label for="no3">질산염 (NO₃)</label><input type="number" step="0.01" id="no3"><span class="input-unit">ppm</span></div>
      <div class="input-group"><label for="po4">인산염 (PO₄)</label><input type="number" step="0.01" id="po4"><span class="input-unit">ppm</span></div>
      <button id="calc-btn" class="button bg-blue-600 text-white mb-2">계산하기</button>
      <button id="save-btn" class="button bg-green-500 text-white">기록 저장</button>
      <p id="status" class="text-center mt-2"></p>
    </div>

    <div id="results"></div>

    <h2 class="text-xl font-semibold mt-6 mb-2">저장된 기록</h2>
    <table id="log-table" class="w-full bg-white shadow rounded-lg">
      <thead><tr><th>날짜</th><th>온도</th><th>염도</th><th>pH</th><th>Ca</th><th>Mg</th><th>KH</th><th>NO₂</th><th>NO₃</th><th>PO₄</th><th>삭제</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 그래프 모달 -->
  <div id="graph-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <canvas id="chart"></canvas>
      <button id="close-graph">닫기</button>
    </div>
  </div>

  <script>
    // 초기 데이터와 기준 설정
    const targets = { temp:[25.5,26.5], salinity:[34,35], ph:[8.0,8.3], ca:[400,440,420], mg:[1250,1440,1350], kh:[7.5,8.5,8.0], no2:[0], no3:[0.5,2.0,1.0], po4:[0.03,0.08,0.05] };
    const logs = JSON.parse(localStorage.getItem('reefLogs')||'[]');
    const elems = ['date','volume','temp','salinity','ph','ca','mg','kh','no2','no3','po4'].reduce((o,id)=>{o[id]=document.getElementById(id);return o;},{});
    const resDiv = document.getElementById('results'), logTbody = document.querySelector('#log-table tbody'), statusP=document.getElementById('status');
    document.getElementById('date').valueAsDate=new Date();

    function calcDose(key,val){
      const vol=+elems.volume.value; if(!vol)return null;
      let rise, dose;
      switch(key){case'ca': rise=targets.ca[2]-val; dose=(rise/2)*(vol/100);break;case'mg': rise=targets.mg[2]-val; dose=(rise)*(vol/100);break;case'kh': rise=targets.kh[2]-val; dose=(rise/0.1)*(vol/100);break;case'no3': rise=targets.no3[2]-val; dose=rise<=0.2?0:(rise<=0.4?0.3:(rise<=0.7?0.6:0.9));break;case'po4': rise=targets.po4[2]-val; dose=rise<=0.009?0:(rise<=0.02?0.3:(rise<=0.035?0.6:0.6));break;default: return null;}return dose.toFixed(1);
    }

    function renderResults(){resDiv.innerHTML='';for(const k of['temp','salinity','ph','ca','mg','kh','no2','no3','po4']){const v=+elems[k].value; if(isNaN(v))continue;let cls='good',txt='';const t=targets[k];if(k==='no2'){if(v>t[0]){cls='high';txt=`NO₂: 검출(${v})! 즉시 교체/환수 권장.`;}else txt=`NO₂: 안정적.`;}else if(k==='ca'||k==='mg'||k==='kh'||k==='no3'||k==='po4'){if(v<t[0]){cls='low';const d=calcDose(k,v);txt=`${k.toUpperCase()}: 낮음(${v}). 도징 필요량 ${d}ml.`;}else if(v>t[1]){cls='high';txt=`${k.toUpperCase()}: 높음(${v}). 환수 권장.`;}else txt=`${k.toUpperCase()}: 안정적(${v}).`; }else{ if(v<t[0]){cls='low';txt=`${k.toUpperCase()}: 낮음(${v}). 범위 ${t[0]}~${t[1]}`;}else if(v>t[1]){cls='high';txt=`${k.toUpperCase()}: 높음(${v}). 범위 ${t[0]}~${t[1]}`;}else txt=`${k.toUpperCase()}: 안정적(${v}).`; }const p=document.createElement('div');p.className=`result-item ${cls}`;p.textContent=txt;resDiv.append(p);}resDiv.style.display=resDiv.innerHTML?'block':'none';}
    document.getElementById('calc-btn').onclick=renderResults;

    function saveLog(){const entry={date:elems.date.value,temp:+elems.temp.value,sal:+elems.salinity.value,ph:+elems.ph.value,ca:+elems.ca.value,mg:+elems.mg.value,kh:+elems.kh.value,no2:+elems.no2.value,no3:+elems.no3.value,po4:+elems.po4.value};logs.push(entry);localStorage.setItem('reefLogs',JSON.stringify(logs));statusP.textContent='저장 완료!';setTimeout(()=>statusP.textContent='',2000);renderTable();}
    document.getElementById('save-btn').onclick=saveLog;

    function renderTable(){logTbody.innerHTML='';logs.forEach((l,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${l.date}</td><td>${l.temp}</td><td>${l.sal}</td><td>${l.ph}</td><td>${l.ca}</td><td>${l.mg}</td><td>${l.kh}</td><td>${l.no2}</td><td>${l.no3}</td><td>${l.po4}</td><td><button data-index="${i}">X</button></td>`;logTbody.append(tr);});}
    logTbody.onclick=e=>{if(e.target.dataset.index!==undefined){logs.splice(e.target.dataset.index,1);localStorage.setItem('reefLogs',JSON.stringify(logs));renderTable();}};

    renderTable();
  </script>
</body>
</html>
