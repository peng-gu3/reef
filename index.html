<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ - Pro (Player Stats)</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --red: #ef4444; --red-bg: #fef2f2; --red-text: #b91c1c;
            --blue: #3b82f6; --blue-bg: #eff6ff; --blue-text: #1d4ed8;
            --green: #22c55e; --green-bg: #dcfce7; --green-text: #15803d;
            --gray: #64748b; --bg: #f1f5f9; --surface: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.4; font-size: 14px; }
        .container { max-width: 1600px; margin: 0 auto; background: var(--surface); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .main-title { font-size: 24px; font-weight: 900; margin: 0; display:flex; align-items:center; gap:10px; }
        .util-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 700; color: var(--text-sub); font-size: 13px; transition: 0.2s; display:flex; align-items:center; gap:5px; }
        .util-btn:hover { background: #f8fafc; color: var(--text-main); }
        .util-btn.active { background: #1e293b; color: white; border-color: #1e293b; }
        
        body.privacy-mode .summary-grid, body.privacy-mode .charts-row, body.privacy-mode .range-analysis-box { display: none !important; }

        /* ê¸°ê°„ ë¶„ì„ ë°•ìŠ¤ */
        .range-analysis-box { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .range-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .range-inputs input[type="date"] { padding: 8px; border: 1px solid var(--border); border-radius: 6px; outline: none; font-family: inherit; }
        .range-result { display: none; margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 15px; }
        .range-stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .r-stat-item { background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .r-stat-label { font-size: 11px; color: var(--text-sub); font-weight: 700; margin-bottom: 4px; }
        .r-stat-val { font-size: 16px; font-weight: 800; }

        /* í†µê³„ ì¹´ë“œ */
        .summary-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-bottom: 20px; }
        @media (max-width: 1200px) { .summary-grid { grid-template-columns: repeat(4, 1fr); } }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .stat-card h3 { margin: 0; font-size: 11px; color: var(--text-sub); font-weight: 700; }
        .stat-card p { margin: 5px 0 0 0; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        .sub-stat { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .text-up { color: var(--red-text); } .text-down { color: var(--blue-text); }

        /* ì°¨íŠ¸ ë° í¬íŠ¸í´ë¦¬ì˜¤ ì˜ì—­ */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 20px; height: 350px; }
        @media (max-width: 1200px) { .charts-row { grid-template-columns: 1fr; height: auto; } }
        
        .chart-card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border); height: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
        .chart-title { font-size: 14px; font-weight: 800; margin-bottom: 10px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        
        /* í¬íŠ¸í´ë¦¬ì˜¤ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .pf-container { overflow-y: auto; flex: 1; }
        .pf-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .pf-table th { position: sticky; top: 0; background: #f8fafc; text-align: left; padding: 8px; color: var(--text-sub); font-weight: 700; border-bottom: 1px solid var(--border); z-index: 10; }
        .pf-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .pf-input { width: 70px; padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; text-align: right; font-weight: bold; font-size: 12px; }
        .pf-val { font-weight: 700; }
        .pf-summary-mini { font-size: 11px; color: var(--text-sub); font-weight: 400; }
        .pf-summary-mini span { font-weight: 800; color: var(--text-main); margin-left: 2px; }

        .calendar-header { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 15px; background: var(--bg); padding: 12px; border-radius: 12px; }
        .calendar-header h2 { margin: 0; font-size: 20px; font-weight: 800; min-width: 150px; text-align: center; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
        .day { background: white; min-height: 120px; padding: 8px; cursor: pointer; position: relative; }
        .day:hover { background: #fcfdfe; }
        .day-num { font-weight: 700; font-size: 12px; color: var(--text-sub); }
        
        .badge { font-size: 10px; padding: 4px 6px; border-radius: 4px; margin-bottom: 3px; font-weight: 600; display: flex; justify-content: space-between; }
        .badge-buy { background: var(--red-bg); color: var(--red-text); }
        .badge-sell { background: var(--blue-bg); border: 1px solid rgba(59,130,246,0.2); }
        .badge-other { background: var(--green-bg); color: var(--green-text); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: white; border-radius: 12px; width: 450px; max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; outline: none; }
        .calc-box { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 15px; background: #f8fafc; padding: 10px; }
        .calc-row { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-main { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 15px; }
        
        .item-card { border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .item-clickable:hover { text-decoration: underline; color: var(--blue-text); cursor: pointer; }
        .sm-btn { padding: 4px 8px; font-size: 11px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-weight: 600; color: var(--text-sub); }
        .sm-btn-blue { color: var(--blue-text); border-color: #bfdbfe; background: #eff6ff; }
        .sm-btn-red { color: var(--red-text); border-color: #fecaca; background: #fef2f2; }

        .calc-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:320px; background:var(--surface); padding:20px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:3000; border:1px solid var(--border); }
        #receiptView { width: 300px; background: white; padding: 40px 20px; font-family: 'Courier New', monospace; color: #333; }
        .receipt-line { border-top: 1px dashed #000; margin: 10px 0; }

        #reportView { width: 350px; background: #fff; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid #1e293b; color: #1e293b; }
        .report-rank { font-size: 40px; margin: 10px 0; }
        .report-stat { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 700; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="container" id="captureTarget">
    <div class="main-header">
        <h1 class="main-title">ğŸš€ í•˜ë£¨20ë§Œì› ëª©í‘œ+_+ ğŸš€  <span id="userTier" style="font-size:14px; background:#eee; padding:2px 8px; border-radius:10px;">ì•„ì´ì–¸ ğŸ§Š</span></h1>
        <div style="display:flex; gap:5px;">
            <button class="util-btn" onclick="captureScreen()">ğŸ“· ìŠ¤í¬ë¦°ìƒ·</button>
            <button class="util-btn" onclick="openCalc()">ğŸ§® ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°</button>
            <button class="util-btn" id="togglePrivacyBtn" onclick="togglePrivacy()">ğŸ”’ ë‹¬ë ¥ë§Œ ë³´ê¸°</button>
            <button class="util-btn" onclick="exportCSV()">ğŸ“Š ì—‘ì…€</button>
            <button class="util-btn" onclick="exportData()">ğŸ’¾ ë°±ì—…</button>
            <button class="util-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ë³µêµ¬</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
        </div>
    </div>

    <div class="range-analysis-box">
        <div style="font-size:14px; font-weight:800; margin-bottom:8px; display:flex; align-items:center; gap:5px;">
            ğŸ“… ê¸°ê°„ë³„ ì„±ì  ì¡°íšŒ <span style="font-size:11px; font-weight:400; color:#64748b;">(ì˜ˆìˆ˜ê¸ˆ/ë°°ë‹¹ ë“± 'ê¸°íƒ€' í•­ëª©ë„ ìˆ˜ìµì— í¬í•¨ë¨)</span>
        </div>
        <div class="range-inputs">
            <input type="date" id="rangeStart">
            <span style="font-weight:700; color:#cbd5e1;">~</span>
            <input type="date" id="rangeEnd">
            <button class="util-btn" style="background:var(--text-main); color:white; border:none;" onclick="analyzeDateRange()">ğŸ” ì¡°íšŒí•˜ê¸°</button>
        </div>

        <div id="rangeResult" class="range-result">
            <div class="range-stat-row">
                <div class="r-stat-item"><div class="r-stat-label">ê¸°ê°„ ì´ ì†ìµ</div><div class="r-stat-val" id="r_profit">0ì›</div></div>
                <div class="r-stat-item"><div class="r-stat-label">ìŠ¹ë¥  (ë§¤ë§¤ë§Œ)</div><div class="r-stat-val" id="r_rate">0%</div></div>
                <div class="r-stat-item"><div class="r-stat-label">ì „ì  (ë§¤ë§¤ë§Œ)</div><div class="r-stat-val" id="r_record">0ìŠ¹ 0íŒ¨</div></div>
                <div class="r-stat-item"><div class="r-stat-label">ê±°ë˜ íšŸìˆ˜</div><div class="r-stat-val" id="r_count">0íšŒ</div></div>
            </div>
            <div style="font-size:12px; font-weight:800; color:var(--text-sub); margin-bottom:8px;">ğŸ“œ í•´ë‹¹ ê¸°ê°„ ê±°ë˜ ë‚´ì—­</div>
            <div id="rangeList" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:10px; background:white;"></div>
        </div>
    </div>

    <div class="summary-grid">
        <div class="stat-card"><h3>ğŸ’° ì´ ëˆ„ì  ì†ìµ</h3><p id="totalProfit">0ì›</p></div>
        <div class="stat-card" onclick="showMonthlyReport()" style="cursor:pointer;"><h3>ğŸ“‰ ì´ë²ˆ ë‹¬ ìˆ˜ìµ (Click ì„±ì í‘œ)</h3><p id="monthProfit">0ì›</p></div>
        <div class="stat-card"><h3>ğŸŒ ê¸ˆì¼ ìˆ˜ìµ</h3><p id="todayProfit">0ì›</p></div>
        <div class="stat-card"><h3>ğŸ¯ ìŠ¹ë¥  (WIN RATE)</h3><p id="winRate">0%</p><div class="sub-stat" id="winLossCnt">0ìŠ¹ 0íŒ¨</div></div>
        <div class="stat-card"><h3>ğŸ§® PROFIT FACTOR</h3><p id="profitFactor">0.0</p><div class="sub-stat">ì´ìˆ˜ìµ/ì´ì†ì‹¤</div></div>
        <div class="stat-card"><h3âš–ï¸ í‰ê·  ì†ìµë¹„</h3><p id="avgRatio">0:0</p><div class="sub-stat">í‰ê· ìµ:í‰ê· ì†</div></div>
        <div class="stat-card"><h3>â±ï¸ í‰ê·  ë³´ìœ ì¼</h3><p id="avgHold">0ì¼</p></div>
    </div>

    <div class="charts-row">
        <div class="chart-card">
            <div class="chart-title">
                ğŸ’¼ ë³´ìœ  í˜„í™© (ìˆ˜ìµë¥ )
                <div class="pf-summary-mini">í‰ê°€ì†: <span id="pfTotalProfit">0ì›</span></div>
            </div>
            <div class="pf-container">
                <table class="pf-table">
                    <thead>
                        <tr>
                            <th>ì¢…ëª©</th>
                            <th style="text-align:right">ë³´ìœ /í‰ë‹¨</th>
                            <th style="text-align:right">í˜„ì¬ê°€</th>
                            <th style="text-align:right">ìˆ˜ìµë¥ </th>
                            <th style="text-align:right">í‰ê°€ì†ìµ</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioList">
                        </tbody>
                </table>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">âš¾ ë‚˜ì˜ íˆ¬ì ìŠ¤íƒ¯ (ëŠ¥ë ¥ì¹˜)</div>
            <div style="flex:1; position:relative;"><canvas id="radarChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">ğŸ° ë³´ìœ  ë¹„ì¤‘</div>
            <div style="flex:1; position:relative;"><canvas id="portfolioChart"></canvas></div>
        </div>
    </div>

    <div class="calendar-header">
        <button class="util-btn" onclick="changeMonth(-1)">â—€ ì´ì „</button>
        <h2 id="currentMonthLabel"></h2>
        <button class="util-btn" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
    </div>
    <div class="calendar" id="calendarGrid"></div>
</div>

<div id="calcModal" class="calc-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; font-size:16px;">ğŸ§® í‰ë‹¨ê°€ ê³„ì‚°</h3><span onclick="closeCalc()" style="cursor:pointer; font-size:20px;">&times;</span></div>
    <input type="number" id="c_curPrice" placeholder="í˜„ì¬ ë‹¨ê°€" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:6px;">
    <input type="number" id="c_curQty" placeholder="í˜„ì¬ ìˆ˜ëŸ‰" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:6px;">
    <input type="number" id="c_addPrice" placeholder="ì¶”ê°€ ë‹¨ê°€" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:6px;">
    <input type="number" id="c_addQty" placeholder="ì¶”ê°€ ìˆ˜ëŸ‰" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ddd; border-radius:6px;">
    <button class="btn-main" style="background:var(--blue); color:white; width:100%; margin-top:10px;" onclick="runCalc()">ê³„ì‚°í•˜ê¸°</button>
    <div id="c_resultAvg" style="text-align:center; font-size:18px; font-weight:800; color:var(--blue-text); margin-top:15px;">-ì›</div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin:0; font-size:16px; font-weight:800;">ê±°ë˜ ì…ë ¥</h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="util-btn" onclick="showReceipt()" style="padding:4px 8px; font-size:11px;">ğŸ§¾ ì˜ìˆ˜ì¦</button>
                <span onclick="closeModal()" style="cursor:pointer; font-size:20px; color:#999;">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div id="sellInfoBox" style="background:#eff6ff; border:1px solid #dbeafe; padding:10px; border-radius:8px; font-size:12px; margin-bottom:15px; display:none;">
                <strong>â„¹ï¸ í†µí•© ë³´ìœ :</strong> í‰ë‹¨ <span id="infoBuyPrice">0</span>ì› / ì´ ì”ì—¬ <span id="infoRemQty">0</span>ì£¼
            </div>
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="inputDate"></div>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                <div class="form-group"><label>êµ¬ë¶„</label>
                    <select id="inputType" onchange="handleTypeChange()">
                        <option value="buy">ë§¤ìˆ˜ (Buy)</option><option value="sell">ë§¤ë„ (Sell)</option><option value="other">ê¸°íƒ€ (ì˜ˆìˆ˜ê¸ˆ/ë°°ë‹¹)</option>
                    </select>
                </div>
                <div class="form-group"><label>ì¢…ëª©ëª…</label><input type="text" id="inputName" placeholder="ì¢…ëª©ëª… ì…ë ¥"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label id="priceLabel">ë§¤ìˆ˜ ë‹¨ê°€</label><input type="number" id="inputPrice" oninput="calc()"></div>
                <div class="form-group"><label>ìˆ˜ëŸ‰</label><input type="number" id="inputQty" value="1" oninput="calc()"></div>
            </div>
            <div class="form-group"><label>ğŸ“ ë§¤ë§¤ ë©”ëª¨ (ë³µê¸°)</label><textarea id="inputMemo" rows="2" placeholder="ì§„ì…/ì²­ì‚° ì´ìœ ..."></textarea></div>
            
            <div class="calc-box">
                <div class="calc-row"><span>ê±°ë˜ ê¸ˆì•¡:</span><span id="c_base">0ì›</span></div>
                <div class="calc-row"><span>ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ (26ë…„ í•œíˆ¬/ì •ë¶€):</span><span id="c_fee">0ì›</span></div>
                <div style="border-top:1px solid var(--border); margin:5px 0;"></div>
                <div style="display:flex; justify-content:space-between; padding:5px 10px; font-weight:800;"><span>ìµœì¢… ì •ì‚°:</span><span id="calcTotal" style="font-size:16px;">0ì›</span></div>
            </div>

            <div class="btn-group">
                <button class="btn-main" onclick="closeModal()" style="background:#e2e8f0; color:var(--text-sub);">ì·¨ì†Œ</button>
                <button class="btn-main" onclick="save()" style="background:#1e293b; color:white;">ì €ì¥</button>
            </div>
            
            <div style="font-size:12px; font-weight:800; color:var(--text-sub); margin-bottom:10px;">ğŸ“… ë‹¹ì¼ ê¸°ë¡ (ì¢…ëª©ëª… í´ë¦­ì‹œ ì „ì ì¡°íšŒ)</div>
            <div id="dayLogList"></div>
            
            <div style="font-size:12px; font-weight:800; color:var(--blue-text); margin:15px 0 10px 0;">ğŸ“¦ í†µí•© ë³´ìœ  ëª©ë¡ (í‰ë‹¨ê°€ ì ìš©)</div>
            <div id="holdingsList"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="holdEditModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal" style="width:350px;">
        <div class="modal-header">
            <h2 style="margin:0; font-size:16px; font-weight:800; color:var(--red-text);">ğŸ› ï¸ ë³´ìœ  ì”ê³  ê°•ì œ ìˆ˜ì •</h2>
            <span onclick="document.getElementById('holdEditModal').style.display='none'" style="cursor:pointer;font-size:20px">&times;</span>
        </div>
        <div class="modal-body">
            <div style="background:#fff7ed; color:#9a3412; padding:10px; border-radius:8px; font-size:12px; margin-bottom:15px; border:1px solid #ffedd5;">
                âš ï¸ <b>ì£¼ì˜:</b> ì´ ê¸°ëŠ¥ì€ ê³„ì‚°ëœ í‰ë‹¨ê°€/ìˆ˜ëŸ‰ì´ ì‹¤ì œì™€ ë‹¤ë¥¼ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
                ìˆ˜ì • ì‹œ, í•´ë‹¹ ì¢…ëª©ì˜ <b>ê¸°ì¡´ ë§¤ìˆ˜ ì”ì—¬ëŸ‰ì´ ëª¨ë‘ ì´ˆê¸°í™”</b>ë˜ë©° ì…ë ¥í•œ ê°’ìœ¼ë¡œ ìƒˆë¡œìš´ 'ë³´ìœ  ì •ì •' ê¸°ë¡ì´ ìƒì„±ë©ë‹ˆë‹¤.
            </div>
            <div class="form-group"><label>ì¢…ëª©ëª…</label><input type="text" id="he_name" readonly style="background:#f1f5f9; color:#64748b;"></div>
            <div class="form-group"><label>ì‹¤ì œ í‰ë‹¨ê°€</label><input type="number" id="he_price" placeholder="ì‹¤ì œ í‰ë‹¨ê°€ ì…ë ¥"></div>
            <div class="form-group"><label>ì‹¤ì œ ë³´ìœ ìˆ˜ëŸ‰</label><input type="number" id="he_qty" placeholder="ì‹¤ì œ ë³´ìœ ìˆ˜ëŸ‰ ì…ë ¥"></div>
            <div class="form-group"><label>ê¸°ì¤€ ë‚ ì§œ (ì •ì • ê¸°ë¡ ë‚ ì§œ)</label><input type="date" id="he_date"></div>
            <button class="btn-main" onclick="applyHoldCorrection()" style="background:var(--red); color:white; width:100%;">ìˆ˜ì • ì‚¬í•­ ì ìš©</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="receiptOverlay" onclick="if(event.target===this) this.style.display='none'">
    <div style="background:white; padding:10px; border-radius:10px;">
        <div id="receiptView">
            <div style="text-align:center;"><h2 style="margin:0; font-size:18px;">TRADING RECEIPT</h2><p id="receiptDate" style="font-size:12px;"></p></div>
            <div class="receipt-line"></div><div id="receiptItems"></div><div class="receipt-line"></div>
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:16px;"><span>TOTAL PROFIT</span><span id="receiptTotal">0</span></div>
            <div class="receipt-line" style="border-top-style: double; height: 3px;"></div>
            <div style="text-align:center; font-size:10px; color:#666; margin-top:10px;">KEEP YOUR DISCIPLINE</div>
        </div>
        <button class="btn-main" onclick="downloadReceipt()" style="width:100%; background:#1e293b; color:white; margin-top:10px;">ğŸ“· ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
    </div>
</div>

<div class="modal-overlay" id="historyModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal">
        <div class="modal-header"><h3 id="histTitle" style="margin:0">ì¢…ëª© íˆìŠ¤í† ë¦¬</h3><span onclick="document.getElementById('historyModal').style.display='none'" style="cursor:pointer;font-size:20px">&times;</span></div>
        <div class="modal-body">
            <div class="summary-grid" style="grid-template-columns:1fr 1fr; margin-bottom:10px;">
                <div class="stat-card" style="padding:10px;"><h3 style="margin:0">ì´ ì†ìµ</h3><p id="histProfit">0ì›</p></div>
                <div class="stat-card" style="padding:10px;"><h3 style="margin:0">ìŠ¹ë¥ </h3><p id="histWinRate">0%</p></div>
            </div>
            <div id="histList" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reportOverlay" onclick="if(event.target===this) this.style.display='none'">
    <div style="background:transparent;">
        <div id="reportView">
            <div style="font-size:20px; font-weight:900;">MONTHLY REPORT</div>
            <div id="reportDate" style="font-size:14px; margin-bottom:15px; color:#64748b;"></div>
            <div class="report-rank" id="reportRank">S</div>
            <div class="report-stat"><span>ì›” ìˆ˜ìµ</span><span id="repProfit">0</span></div>
            <div class="report-stat"><span>ì›” ìŠ¹ë¥ </span><span id="repWinRate">0%</span></div>
            <div class="report-stat"><span>BEST ì¢…ëª©</span><span id="repBest">-</span></div>
            <div class="report-stat"><span>WORST ì¢…ëª©</span><span id="repWorst">-</span></div>
            <div style="margin-top:20px; font-size:12px; color:#94a3b8;">Trading Journal V7.3</div>
        </div>
        <button class="btn-main" onclick="downloadReport()" style="width:100%; background:#1e293b; color:white; margin-top:10px;">ğŸ“· ì„±ì í‘œ ì €ì¥</button>
    </div>
</div>

<script>
    let currentDate = new Date(), transactions = JSON.parse(localStorage.getItem('stockData_v40')) || [];
    let savedPrices = JSON.parse(localStorage.getItem('savedPrices_v1')) || {}; 
    let radarChart=null, portfolioChart=null, editingId=null;

    // 2026 ê¸°ì¤€ ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì ìš© (í•œíˆ¬ + ìœ ê´€ê¸°ê´€ + ê±°ë˜ì„¸/ë†íŠ¹ì„¸)
    // ë§¤ìˆ˜: í•œíˆ¬(0.0130527) + ìœ ê´€(0.0031833) = 0.016236% -> 0.00016236
    // ë§¤ë„: ë§¤ìˆ˜ìˆ˜ìˆ˜ë£Œ + ì„¸ê¸ˆ(0.20%) = 0.016236% + 0.2% = 0.216236% -> 0.00216236
    const BUY_FEE_RATE = 0.00016236; 
    const SELL_FEE_RATE = 0.00016236; // ë§¤ë„ ìˆ˜ìˆ˜ë£Œ
    const SELL_TAX_RATE = 0.0020;     // ë§¤ë„ ì„¸ê¸ˆ (0.20%)

    function init() { 
        renderCalendar(); 
        updateSummary();
        renderPortfolioTable(); 
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rangeStart').value = today;
        document.getElementById('rangeEnd').value = today;
    }

    function getTier(profit) {
        if (profit < 0) return { label: 'ì•„ì´ì–¸ ğŸ§Š', color: '#94a3b8' };
        if (profit < 1000000) return { label: 'ë¸Œë¡ ì¦ˆ ğŸ¥‰', color: '#92400e' };
        if (profit < 5000000) return { label: 'ì‹¤ë²„ ğŸ¥ˆ', color: '#94a3b8' };
        if (profit < 20000000) return { label: 'ê³¨ë“œ ğŸ¥‡', color: '#eab308' };
        if (profit < 100000000) return { label: 'í”Œë˜í‹°ë„˜ ğŸ’', color: '#2dd4bf' };
        if (profit < 500000000) return { label: 'ë‹¤ì´ì•„ â„ï¸', color: '#3b82f6' };
        return { label: 'ì±Œë¦°ì € ğŸ”¥', color: '#1e293b' };
    }

    function updateSummary() {
        let tp=0, mp=0, dp=0, sc=0, lc=0, winSum=0, lossSum=0, totalHoldDays=0, holdCount=0;
        let todayStr = new Date().toISOString().split('T')[0], cmStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
        let holdings = {};
        
        // ì°¨íŠ¸ìš© ë³€ìˆ˜
        let wins=0, losses=0, totalTrades=0;

        [...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(t => {
            if(t.type === 'sell' || t.type === 'other') {
                let p = t.profit || t.price;
                tp += p;
                if(t.date.startsWith(cmStr)) mp += p;
                if(t.date === todayStr) dp += p;
            }

            if(t.type === 'sell') {
                totalTrades++;
                if(t.profit >= 0) { sc++; wins++; winSum += t.profit; } 
                else { lc++; losses++; lossSum += Math.abs(t.profit); }
                
                if(t.holdDays !== undefined) { totalHoldDays += t.holdDays; holdCount++; }
            } else if(t.type === 'buy' && t.remainingQty > 0) {
                holdings[t.name] = (holdings[t.name] || 0) + (t.remainingQty * t.price);
            }
        });

        const tier = getTier(tp);
        const tEl = document.getElementById('userTier');
        tEl.innerText = tier.label; tEl.style.backgroundColor = tier.color; tEl.style.color = 'white';

        document.getElementById('totalProfit').innerText = tp.toLocaleString() + 'ì›';
        document.getElementById('totalProfit').className = tp >= 0 ? 'text-up' : 'text-down';
        document.getElementById('monthProfit').innerText = mp.toLocaleString() + 'ì›';
        document.getElementById('todayProfit').innerText = dp.toLocaleString() + 'ì›';
        document.getElementById('winRate').innerText = (sc+lc > 0 ? (sc/(sc+lc)*100).toFixed(1) : 0) + '%';
        document.getElementById('winLossCnt').innerText = `${sc}ìŠ¹ ${lc}íŒ¨`;
        document.getElementById('profitFactor').innerText = lossSum > 0 ? (winSum/lossSum).toFixed(2) : (winSum>0?'âˆ':'0.0');
        let avgWin = sc > 0 ? winSum/sc : 0, avgLoss = lc > 0 ? lossSum/lc : 0;
        document.getElementById('avgRatio').innerText = `${(avgWin/10000).toFixed(1)} : ${(avgLoss/10000).toFixed(1)}`;
        let avgHold = holdCount > 0 ? totalHoldDays/holdCount : 0;
        document.getElementById('avgHold').innerText = Math.round(avgHold) + 'ì¼';

        renderCharts({wins, losses, totalTrades, winSum, lossSum, avgHold}, holdings);
    }

    function renderCharts(stats, holdings) {
        // --- íƒ€ì ìŠ¤íƒ¯ (ë ˆì´ë”) ë°ì´í„° ê³„ì‚° ---
        let contact = stats.totalTrades > 0 ? (stats.wins / stats.totalTrades) * 100 : 0; // ì»¨íƒ(ìŠ¹ë¥ )
        
        let avgWin = stats.wins > 0 ? stats.winSum / stats.wins : 0;
        let avgLoss = stats.losses > 0 ? stats.lossSum / stats.losses : 0;

        // ì¥íƒ€ë ¥: í‰ê· ìˆ˜ìµê¸ˆ (10ë§Œì›ì„ 100ì ìœ¼ë¡œ ê¸°ì¤€ ì¡ìŒ)
        let power = Math.min(100, (avgWin / 100000) * 100); 

        // ì„ êµ¬ì•ˆ: ì†ìµë¹„ (PF 3.0 ì´ìƒì´ë©´ 100ì )
        let ratio = avgLoss > 0 ? avgWin / avgLoss : (avgWin>0?3:0);
        let eye = Math.min(100, (ratio / 3) * 100);

        // ìˆ˜ë¹„: ë°©ì–´ìœ¨ (í‰ê· ì†ì‹¤ì´ ì ì„ìˆ˜ë¡ ì ìˆ˜ ë†’ìŒ. 0ì›ì´ë©´ 100ì , 10ë§Œì› ìƒìœ¼ë©´ 0ì )
        let defense = Math.max(0, 100 - (avgLoss / 100000 * 100));

        // ì£¼ë£¨: íšŒì „ìœ¨ (ë³´ìœ ì¼ ì§§ì„ìˆ˜ë¡ ì ìˆ˜ ë†’ìŒ. 1ì¼=100ì , 10ì¼=10ì )
        let speed = stats.avgHold <= 0 ? 0 : Math.max(10, 110 - (stats.avgHold * 10));
        if(stats.totalTrades === 0) speed = 0;

        if(radarChart) radarChart.destroy();
        radarChart = new Chart(document.getElementById('radarChart'), { 
            type:'radar', 
            data:{
                labels: ['ì»¨íƒ(ìŠ¹ë¥ )', 'ì¥íƒ€ë ¥(ìˆ˜ìµê¸ˆ)', 'ì„ êµ¬ì•ˆ(ì†ìµë¹„)', 'ìˆ˜ë¹„(ì†ì‹¤ë°©ì–´)', 'ì£¼ë£¨(íšŒì „ìœ¨)'],
                datasets:[{
                    label: 'My Stats',
                    data: [contact, power, eye, defense, speed],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: '#3b82f6',
                    pointBackgroundColor: '#1e293b',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#3b82f6'
                }]
            }, 
            options:{
                responsive:true, 
                maintainAspectRatio:false, 
                scales: {
                    r: {
                        angleLines: { color: '#e2e8f0' },
                        grid: { color: '#e2e8f0' },
                        pointLabels: { font: { size: 11, weight: '700' }, color: '#64748b' },
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { display: false } // ëˆˆê¸ˆ ìˆ«ì ìˆ¨ê¹€
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        if(portfolioChart) portfolioChart.destroy();
        portfolioChart = new Chart(document.getElementById('portfolioChart'), { type:'pie', data:{labels:Object.keys(holdings), datasets:[{data:Object.values(holdings), backgroundColor:['#ef4444','#3b82f6','#22c55e','#eab308','#a855f7']}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{boxWidth:12}}}}});
    }

    function analyzeDateRange() {
        const start = document.getElementById('rangeStart').value;
        const end = document.getElementById('rangeEnd').value;
        if (!start || !end) { alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        const targetLogs = transactions.filter(t => t.date >= start && t.date <= end).sort((a,b) => new Date(a.date) - new Date(b.date));
        
        let profit = 0, wins = 0, losses = 0, count = 0;
        
        targetLogs.forEach(t => {
            if (t.type === 'sell') {
                profit += t.profit;
                if(t.profit >= 0) wins++; else losses++;
            } else if (t.type === 'other') {
                profit += t.price;
            }
        });
        count = targetLogs.length;

        document.getElementById('r_profit').innerText = profit.toLocaleString() + 'ì›';
        document.getElementById('r_profit').className = 'r-stat-val ' + (profit >= 0 ? 'text-up' : 'text-down');
        document.getElementById('r_rate').innerText = (wins + losses > 0) ? ((wins / (wins+losses)) * 100).toFixed(1) + '%' : '0%';
        document.getElementById('r_record').innerText = `${wins}ìŠ¹ ${losses}íŒ¨`;
        document.getElementById('r_count').innerText = `${count}ê±´`;

        const listHtml = targetLogs.length > 0 ? targetLogs.map(t => {
            let color = t.type === 'buy' ? 'var(--red-text)' : (t.type === 'sell' ? (t.profit >= 0 ? 'var(--red-text)' : 'var(--blue-text)') : (t.price >= 0 ? 'var(--red-text)' : 'var(--blue-text)'));
            let info = '';
            let typeLabel = '';
            
            if (t.type === 'buy') {
                info = `${t.price.toLocaleString()}ì› / ${t.qty}ì£¼ ë§¤ìˆ˜`;
                typeLabel = 'BUY';
                color = 'var(--text-main)';
            } else if (t.type === 'sell') {
                info = `${t.profit.toLocaleString()}ì› ì†ìµ (${((t.profit/(t.price*t.qty))*100).toFixed(2)}%)`;
                typeLabel = 'SELL';
                color = t.profit >= 0 ? 'var(--red-text)' : 'var(--blue-text)';
            } else {
                info = `${t.price > 0 ? '+' : ''}${t.price.toLocaleString()}ì›`;
                typeLabel = 'ETC';
                color = t.price >= 0 ? 'var(--red-text)' : 'var(--blue-text)';
            }

            return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f1f5f9; font-size:13px;">
                <div>
                    <span style="color:#94a3b8; font-size:11px; margin-right:5px;">${t.date}</span>
                    <span style="font-weight:700; color:${t.type==='buy'?'var(--red)':(t.type==='sell'?'var(--blue)':'#64748b')}">[${typeLabel}]</span>
                    <b>${t.name}</b>
                </div>
                <div style="font-weight:700; color:${color};">${info}</div>
            </div>`;
        }).join('') : '<div style="text-align:center; padding:20px; color:#94a3b8;">í•´ë‹¹ ê¸°ê°„ì— ê±°ë˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

        document.getElementById('rangeList').innerHTML = listHtml;
        document.getElementById('rangeResult').style.display = 'block';
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();
        document.getElementById('currentMonthLabel').innerText = `${y}ë…„ ${m+1}ì›”`;
        
        grid.innerHTML = `
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700; color:var(--red-text);">ì¼</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700;">ì›”</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700;">í™”</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700;">ìˆ˜</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700;">ëª©</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700;">ê¸ˆ</div>
            <div style="background:#f8fafc; padding:10px; text-align:center; font-weight:700; color:var(--blue-text);">í† </div>
        `;

        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m + 1, 0).getDate();
        for (let i = 0; i < first; i++) grid.innerHTML += `<div style="background:#f9fafb; min-height:120px;"></div>`;

        for (let i = 1; i <= last; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const logs = transactions.filter(t => t.date === dStr);
            let dayP = 0;
            let badges = '';
            let summary = {};
            
            logs.forEach(l => {
                const key = l.name + '_' + l.type;
                if (!summary[key]) summary[key] = { ...l, totalQty: 0, totalProfit: 0, count: 0 };
                summary[key].totalQty += l.qty;
                summary[key].count += 1;
                if (l.type === 'sell') {
                    summary[key].totalProfit += l.profit;
                    dayP += l.profit;
                } else if (l.type === 'other') {
                    dayP += l.price;
                }
            });

            for (const key in summary) {
                const item = summary[key];
                const countStr = item.count > 1 ? `(${item.count})` : '';
                if (item.type === 'buy') {
                    badges += `<div class="badge badge-buy"><span>${item.name}${countStr}</span><span>${item.totalQty}ì£¼</span></div>`;
                } else if (item.type === 'sell') {
                    const p = item.totalProfit;
                    badges += `<div class="badge badge-sell"><span>${item.name}${countStr}</span><span style="color: ${p>=0 ? '#ef4444' : '#1d4ed8'}">${p>=0?'+':''}${(p/10000).toFixed(1)}ë§Œ</span></div>`;
                } else {
                    const p = item.price;
                    const color = p >= 0 ? '#15803d' : '#1d4ed8'; 
                    const sign = p >= 0 ? '+' : '';
                    badges += `<div class="badge badge-other" style="color:${color}; background:${p>=0?'#dcfce7':'#eff6ff'}"><span>${item.name}</span><span>${sign}${(p/10000).toFixed(1)}ë§Œ</span></div>`;
                }
            }

            grid.innerHTML += `
                <div class="day" onclick="openModal('${dStr}')">
                    <div class="day-num">${i}</div>
                    ${badges}
                    <div style="font-size:10px; font-weight:900; text-align:right; margin-top:auto; color:${dayP>=0?'var(--blue)':'var(--red)'}">
                        ${dayP!==0 ? dayP.toLocaleString() : ''}
                    </div>
                </div>`;
        }
    }

    function openModal(dStr) { 
        editingId = null; document.getElementById('modalOverlay').style.display='flex'; 
        document.getElementById('inputDate').value=dStr; document.getElementById('inputType').value='buy';
        document.getElementById('inputName').value=''; document.getElementById('inputPrice').value=''; 
        document.getElementById('inputQty').value='1'; document.getElementById('inputMemo').value='';
        document.getElementById('sellInfoBox').style.display='none';
        handleTypeChange(); renderDayLog(dStr); renderHold(); 
    }
    
    function closeModal() { document.getElementById('modalOverlay').style.display='none'; }
    function handleTypeChange() { const t = document.getElementById('inputType').value; document.getElementById('priceLabel').innerText = (t==='buy'?'ë§¤ìˆ˜ ë‹¨ê°€':(t==='sell'?'ë§¤ë„ ë‹¨ê°€':'ê¸ˆì•¡')); calc(); }
    
    function calc() { 
        const p=Number(document.getElementById('inputPrice').value), q=Number(document.getElementById('inputQty').value), t=document.getElementById('inputType').value; 
        
        let base = p * q;
        let fee = 0;
        let tax = 0;

        if (t === 'buy') {
            fee = Math.floor(base * BUY_FEE_RATE); // 1ì›ë‹¨ìœ„ ì ˆì‚¬
        } else if (t === 'sell') {
            fee = Math.floor(base * SELL_FEE_RATE);
            tax = Math.floor(base * SELL_TAX_RATE);
        }

        document.getElementById('c_base').innerText = base.toLocaleString() + 'ì›'; 
        document.getElementById('c_fee').innerText = (fee + tax).toLocaleString() + 'ì›'; 
        document.getElementById('calcTotal').innerText = (t==='buy' ? base + fee : base - fee - tax).toLocaleString() + 'ì›'; 
    }

    function editLog(id) {
        editingId = id; const t = transactions.find(x => x.id === id);
        document.getElementById('inputDate').value = t.date; document.getElementById('inputType').value = t.type;
        document.getElementById('inputName').value = t.name; document.getElementById('inputPrice').value = t.price;
        document.getElementById('inputQty').value = t.qty; document.getElementById('inputMemo').value = t.memo || '';
        handleTypeChange();
    }

    function save() {
        const d=document.getElementById('inputDate').value, t=document.getElementById('inputType').value, n=document.getElementById('inputName').value, p=Number(document.getElementById('inputPrice').value), q=Number(document.getElementById('inputQty').value), m=document.getElementById('inputMemo').value;
        if(!n || !p) return;
        if(editingId) {
            let idx = transactions.findIndex(x=>x.id===editingId);
            transactions[idx] = {...transactions[idx], date:d, name:n, price:p, qty:q, memo:m};
            editingId = null;
        } else {
            if(t==='sell') {
                let buys = transactions.filter(x=>x.type==='buy' && x.name===n && x.remainingQty>0).sort((a,b)=>new Date(a.date)-new Date(b.date));
                if(q > buys.reduce((a,c)=>a+c.remainingQty, 0)){alert('ìˆ˜ëŸ‰ë¶€ì¡±');return;}
                let totalBuyQty = buys.reduce((a,c)=>a+c.remainingQty,0);
                let avgP = buys.reduce((a,c)=>a+(c.remainingQty*c.price),0)/totalBuyQty;
                
                // ë§¤ë„ ì •ì‚° (ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ ì ìš©)
                let baseSell = p * q;
                let sellFee = Math.floor(baseSell * SELL_FEE_RATE);
                let sellTax = Math.floor(baseSell * SELL_TAX_RATE);
                let sellNet = baseSell - sellFee - sellTax;

                // ë§¤ìˆ˜ ì›ê¸ˆ (ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ í¬í•¨)
                // ê¸°ì¡´ ë§¤ìˆ˜ë‹¨ê°€ëŠ” ìˆœìˆ˜ ê°€ê²©ì´ì§€ë§Œ, ì •í™•í•œ ì†ìµ ê³„ì‚°ì„ ìœ„í•´ ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œë„ ë¹„ìš©ìœ¼ë¡œ ì¹˜ëŠ”ê²Œ ë§ìœ¼ë‚˜
                // ë³´í†µ 'ì‹¤í˜„ì†ìµ'ì€ (ë§¤ë„ê¸ˆì•¡ - ì œë¹„ìš©) - (ë§¤ìˆ˜í‰ë‹¨ * ìˆ˜ëŸ‰) - (ë§¤ìˆ˜ì‹œ ìˆ˜ìˆ˜ë£Œ ì¶”ì •) ì‹ìœ¼ë¡œ ê³„ì‚°í•¨.
                // ì—¬ê¸°ì„  ê°„ë‹¨íˆ (ë§¤ë„ì •ì‚°ê¸ˆ) - (ë§¤ìˆ˜í‰ë‹¨ * ìˆ˜ëŸ‰)ìœ¼ë¡œ ê³„ì‚°í•˜ë˜, ë§¤ìˆ˜ìˆ˜ìˆ˜ë£ŒëŠ” ê¸° ë°˜ì˜ëœê±¸ë¡œ ê°€ì •í•˜ê±°ë‚˜ ë¬´ì‹œí•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ.
                // ì •í™•íˆ í•˜ë ¤ë©´: buyTotal = (avgP * q) + Math.floor(avgP * q * BUY_FEE_RATE);
                let buyBase = avgP * q;
                let buyFee = Math.floor(buyBase * BUY_FEE_RATE);
                let buyTotal = buyBase + buyFee;

                transactions.push({id:Date.now(), date:d, type:'sell', name:n, price:p, qty:q, profit:Math.round(sellNet-buyTotal), memo:m, holdDays:Math.ceil((new Date(d)-new Date(buys[0].date))/(1000*60*60*24))});
                let rem=q; buys.forEach(b=>{if(rem>0){let dQ=Math.min(b.remainingQty, rem); b.remainingQty-=dQ; rem-=dQ;}});
            } else transactions.push({id:Date.now(), date:d, type:t, name:n, price:p, qty:q, remainingQty:q, memo:m});
        }
        localStorage.setItem('stockData_v40', JSON.stringify(transactions)); init(); openModal(d); renderPortfolioTable();
    }

    function initiateSell(name, qty, avg) { document.getElementById('inputType').value='sell'; document.getElementById('inputName').value=name; document.getElementById('inputQty').value=qty; document.getElementById('sellInfoBox').style.display='block'; document.getElementById('infoBuyPrice').innerText=Math.round(avg).toLocaleString(); document.getElementById('infoRemQty').innerText=qty; handleTypeChange(); }
    function openHoldEdit(name, currentQty, currentAvg) {
        document.getElementById('he_name').value = name;
        document.getElementById('he_price').value = Math.round(currentAvg);
        document.getElementById('he_qty').value = currentQty;
        document.getElementById('he_date').value = new Date().toISOString().split('T')[0];
        document.getElementById('holdEditModal').style.display = 'flex';
    }

    function applyHoldCorrection() {
        const name = document.getElementById('he_name').value;
        const newPrice = Number(document.getElementById('he_price').value);
        const newQty = Number(document.getElementById('he_qty').value);
        const date = document.getElementById('he_date').value;

        if (!newPrice || !newQty) { alert("í‰ë‹¨ê°€ì™€ ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        if (!confirm(`${name}ì˜ ì”ê³ ë¥¼\ní‰ë‹¨: ${newPrice}ì›, ìˆ˜ëŸ‰: ${newQty}ì£¼ë¡œ ê°•ì œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë§¤ìˆ˜ ê¸°ë¡ì€ ëª¨ë‘ ì†Œì§„ ì²˜ë¦¬ë©ë‹ˆë‹¤.)`)) return;

        transactions.forEach(t => { if (t.type === 'buy' && t.name === name && t.remainingQty > 0) t.remainingQty = 0; });
        transactions.push({ id: Date.now(), date: date, type: 'buy', name: name, price: newPrice, qty: newQty, remainingQty: newQty, memo: 'ë³´ìœ  ì”ê³  ê°•ì œ ì •ì • (ìˆ˜ë™ ìˆ˜ì •)' });
        localStorage.setItem('stockData_v40', JSON.stringify(transactions));
        alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('holdEditModal').style.display = 'none';
        init();
        renderPortfolioTable();
        if(document.getElementById('modalOverlay').style.display === 'flex') renderHold();
    }

    function del(id) { 
        if(!confirm("ì‚­ì œ? (ë§¤ë„ ì‚­ì œì‹œ ë³´ìœ ëŸ‰ ë³µêµ¬ë¨)")) return; 
        const idx=transactions.findIndex(t=>t.id===id); if(idx===-1)return; 
        const tr=transactions[idx]; 
        if(tr.type==='sell'){let rq=tr.qty, buys=transactions.filter(t=>t.type==='buy'&&t.name===tr.name).sort((a,b)=>new Date(a.date)-new Date(b.date)); for(let b of buys){if(rq<=0)break; let lost=b.qty-b.remainingQty; if(lost>0){let r=Math.min(lost,rq); b.remainingQty+=r; rq-=r;}}} 
        transactions.splice(idx,1); localStorage.setItem('stockData_v40', JSON.stringify(transactions)); init(); closeModal(); renderPortfolioTable();
    }

    function renderDayLog(dStr) {
        const logs = transactions.filter(t => t.date === dStr);
        let groupedLogs = [], buyMap = {};

        logs.forEach(t => {
            if (t.type === 'buy') {
                if (!buyMap[t.name]) {
                    buyMap[t.name] = { ...t, totalQty: 0, totalCost: 0, count: 0, isGrouped: true };
                    groupedLogs.push(buyMap[t.name]);
                }
                buyMap[t.name].totalQty += t.qty;
                buyMap[t.name].totalCost += (t.price * t.qty);
                buyMap[t.name].count++;
                buyMap[t.name].id = t.id; 
                buyMap[t.name].price = Math.floor(buyMap[t.name].totalCost / buyMap[t.name].totalQty);
                buyMap[t.name].qty = buyMap[t.name].totalQty;
            } else {
                groupedLogs.push(t);
            }
        });

        document.getElementById('dayLogList').innerHTML = groupedLogs.map(t => {
            const isMulti = t.isGrouped && t.count > 1;
            const countLabel = isMulti ? `<span style="font-size:10px; color:#ef4444; background:#fef2f2; padding:2px 4px; border-radius:4px; margin-left:4px;">${t.count}ê±´ í†µí•©</span>` : '';
            const priceDisplay = t.type === 'sell' ? `${t.profit.toLocaleString()}ì›` : `${t.price.toLocaleString()}ì›`;

            return `<div class="item-card">
                <div>
                    <b class="item-clickable" onclick="showHistory('${t.name}')">[${t.type}] ${t.name} ${countLabel}</b><br>
                    <small>${t.qty}ì£¼ / ${priceDisplay}</small>
                </div>
                <div style="display:flex; gap:5px;"><button class="sm-btn" onclick="editLog(${t.id})">ìˆ˜ì •</button><button class="sm-btn" onclick="del(${t.id})">ì‚­ì œ</button></div>
            </div>`;
        }).join('');
    }

    function renderHold() { 
        let hMap = {}; 
        transactions.filter(x=>x.type==='buy' && x.remainingQty>0).forEach(t=>{ 
            if(!hMap[t.name]) hMap[t.name]={q:0, c:0}; 
            hMap[t.name].q+=t.remainingQty; 
            hMap[t.name].c+=(t.remainingQty*t.price); 
        });         
        document.getElementById('holdingsList').innerHTML = Object.keys(hMap).map(k=>{
            const avg = hMap[k].c/hMap[k].q;
            return `<div class="item-card">
                <div>
                    <b class="item-clickable" onclick="showHistory('${k}')">${k}</b><br>
                    <small>í‰ë‹¨ ${Math.round(avg).toLocaleString()}ì› / ${hMap[k].q}ì£¼</small>
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="sm-btn sm-btn-red" onclick="openHoldEdit('${k}', ${hMap[k].q}, ${avg})">ë³´ìœ ìˆ˜ì •</button>
                    <button class="sm-btn sm-btn-blue" onclick="initiateSell('${k}', ${hMap[k].q}, ${avg})">ë§¤ë„</button>
                </div>
            </div>`;
        }).join(''); 
    }

    function renderPortfolioTable() {
        let hMap = {}; 
        transactions.filter(x=>x.type==='buy' && x.remainingQty>0).forEach(t=>{ 
            if(!hMap[t.name]) hMap[t.name]={q:0, c:0}; 
            hMap[t.name].q+=t.remainingQty; 
            hMap[t.name].c+=(t.remainingQty*t.price); 
        });

        const list = document.getElementById('portfolioList');
        let html = '';

        Object.keys(hMap).forEach(name => {
            const avg = Math.floor(hMap[name].c / hMap[name].q);
            const qty = hMap[name].q;
            const lastPrice = savedPrices[name] || avg; 
            
            html += `
            <tr data-name="${name}" data-avg="${avg}" data-qty="${qty}">
                <td style="font-weight:700;">${name}</td>
                <td style="text-align:right;">${qty}ì£¼<br><span style="color:#94a3b8; font-size:11px;">@${avg.toLocaleString()}</span></td>
                <td style="text-align:right;">
                    <input type="number" class="pf-input" value="${lastPrice}" oninput="updateRow(this)" onchange="savePrice('${name}', this.value)">
                </td>
                <td style="text-align:right;" class="pf-val pf-yield">0.0%</td>
                <td style="text-align:right;" class="pf-val pf-profit">0</td>
            </tr>`;
        });

        if (html === '') html = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#94a3b8;">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        
        list.innerHTML = html;
        document.querySelectorAll('.pf-input').forEach(input => updateRow(input));
    }

    function updateRow(input) {
        const row = input.closest('tr');
        const avg = Number(row.dataset.avg);
        const qty = Number(row.dataset.qty);
        const curPrice = Number(input.value);

        if(!curPrice) return;

        const valuation = curPrice * qty;
        const buyVal = avg * qty;
        // ë‹¨ìˆœ í‰ê°€ì†ìµ ê³„ì‚° (ìˆ˜ìˆ˜ë£Œ ì œì™¸ëœ ìˆœìˆ˜ ë“±ë½)
        const profit = valuation - buyVal; 
        const yieldRate = ((curPrice - avg) / avg) * 100;

        const yieldEl = row.querySelector('.pf-yield');
        const profitEl = row.querySelector('.pf-profit');

        yieldEl.innerText = yieldRate.toFixed(1) + '%';
        yieldEl.style.color = yieldRate >= 0 ? 'var(--red-text)' : 'var(--blue-text)';

        profitEl.innerText = (profit/10000).toFixed(1) + 'ë§Œ'; 
        profitEl.style.color = profit >= 0 ? 'var(--red-text)' : 'var(--blue-text)';

        calcPortfolioTotal();
    }

    function calcPortfolioTotal() {
        let totalProfit = 0;
        document.querySelectorAll('#portfolioList tr').forEach(tr => {
            if(tr.querySelector('input')) {
                const qty = Number(tr.dataset.qty);
                const curPrice = Number(tr.querySelector('input').value);
                const avg = Number(tr.dataset.avg);
                totalProfit += (curPrice * qty) - (avg * qty);
            }
        });

        const tpEl = document.getElementById('pfTotalProfit');
        tpEl.innerText = totalProfit.toLocaleString() + 'ì›';
        tpEl.style.color = totalProfit >= 0 ? '#ef4444' : '#3b82f6';
    }

    function savePrice(name, price) {
        savedPrices[name] = price;
        localStorage.setItem('savedPrices_v1', JSON.stringify(savedPrices));
    }

    function showHistory(name) {
        const logs = transactions.filter(t => t.name === name && (t.type==='buy'||t.type==='sell')).sort((a,b)=>new Date(b.date)-new Date(a.date));
        if(!logs.length) return;
        document.getElementById('histTitle').innerText = `${name} ì „ì `;
        let totalP=0, wins=0, sells=0;
        let html = logs.map(t => {
            if(t.type==='sell'){ totalP+=t.profit; sells++; if(t.profit>=0) wins++; }
            return `<div style="border-bottom:1px solid #eee; padding:5px; font-size:12px; display:flex; justify-content:space-between;"><span>${t.date} [${t.type==='buy'?'ë§¤ìˆ˜':'ë§¤ë„'}]</span><span style="color:${t.profit>=0?'red':'blue'}">${t.type==='sell'?t.profit.toLocaleString()+'ì›':t.qty+'ì£¼'}</span></div>`;
        }).join('');
        document.getElementById('histProfit').innerText = totalP.toLocaleString()+'ì›';
        document.getElementById('histWinRate').innerText = sells>0 ? ((wins/sells)*100).toFixed(1)+'%' : '-';
        document.getElementById('histList').innerHTML = html;
        document.getElementById('historyModal').style.display = 'flex';
    }

    function showMonthlyReport() {
        const cmStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
        const logs = transactions.filter(t => t.date.startsWith(cmStr) && (t.type === 'sell' || t.type === 'other'));
        
        let profit=0, wins=0, totalTrades=0;
        let stockProfits = {};
        
        logs.forEach(t => {
            if(t.type === 'sell') {
                profit += t.profit;
                totalTrades++;
                if(t.profit >= 0) wins++;
                stockProfits[t.name] = (stockProfits[t.name] || 0) + t.profit;
            } else if (t.type === 'other') {
                profit += t.price;
            }
        });

        let sortedStocks = Object.keys(stockProfits).sort((a,b) => stockProfits[b] - stockProfits[a]);
        let best = sortedStocks[0], worst = sortedStocks[sortedStocks.length-1];

        document.getElementById('reportDate').innerText = cmStr;
        document.getElementById('repProfit').innerText = profit.toLocaleString() + 'ì›';
        document.getElementById('repWinRate').innerText = (totalTrades > 0) ? ((wins/totalTrades)*100).toFixed(1) + '%' : '0%';
        document.getElementById('repBest').innerText = best ? `${best} (${stockProfits[best].toLocaleString()})` : '-';
        document.getElementById('repWorst').innerText = worst && stockProfits[worst]<0 ? `${worst} (${stockProfits[worst].toLocaleString()})` : '-';
        
        let rank = 'F';
        if(profit > 10000000) rank = 'S+';
        else if(profit > 5000000) rank = 'S';
        else if(profit > 1000000) rank = 'A';
        else if(profit > 0) rank = 'B';
        document.getElementById('reportRank').innerText = rank;
        document.getElementById('reportOverlay').style.display = 'flex';
    }

    function exportCSV() {
        let csvContent = "\uFEFFDate,Type,Name,Price,Qty,Profit,Memo\n";
        transactions.forEach(t => {
            csvContent += `${t.date},${t.type},${t.name},${t.price},${t.qty},${t.profit||0},${t.memo||''}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "trading_data.csv";
        link.click();
    }

    function togglePrivacy() { document.body.classList.toggle('privacy-mode'); }
    function changeMonth(v) { currentDate.setMonth(currentDate.getMonth()+v); renderCalendar(); }
    function openCalc() { document.getElementById('calcModal').style.display='block'; }
    function closeCalc() { document.getElementById('calcModal').style.display='none'; }
    function runCalc() { const cp=Number(document.getElementById('c_curPrice').value), cq=Number(document.getElementById('c_curQty').value), ap=Number(document.getElementById('c_addPrice').value), aq=Number(document.getElementById('c_addQty').value); document.getElementById('c_resultAvg').innerText = Math.round((cp*cq + ap*aq)/(cq+aq)).toLocaleString()+'ì›'; }
    function exportData() { const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(transactions)); a.download='backup.json'; a.click(); }
    function importData(i) { const r=new FileReader(); r.onload=e=>{ transactions=JSON.parse(e.target.result); localStorage.setItem('stockData_v40', JSON.stringify(transactions)); location.reload(); }; r.readAsText(i.files[0]); }
    function captureScreen() { html2canvas(document.getElementById('captureTarget')).then(c => { const a=document.createElement('a'); a.download='TradingLog.png'; a.href=c.toDataURL(); a.click(); }); }
    function showReceipt() { const d=document.getElementById('inputDate').value, logs=transactions.filter(t=>t.date===d && t.type==='sell'); if(!logs.length){alert('ë§¤ë„ë‚´ì—­ì—†ìŒ');return;} document.getElementById('receiptDate').innerText=d; let t=0; document.getElementById('receiptItems').innerHTML=logs.map(l=>{t+=l.profit; return `<div class="receipt-item"><span>${l.name}</span><span>${l.profit.toLocaleString()}</span></div>`}).join(''); document.getElementById('receiptTotal').innerText=t.toLocaleString(); document.getElementById('receiptOverlay').style.display='flex'; }
    function downloadReceipt() { html2canvas(document.getElementById('receiptView')).then(c => { const a=document.createElement('a'); a.download='receipt.png'; a.href=c.toDataURL(); a.click(); }); }
    function downloadReport() { html2canvas(document.getElementById('reportView')).then(c => { const a=document.createElement('a'); a.download='monthly_report.png'; a.href=c.toDataURL(); a.click(); }); }
    
    init();
</script>
</body>
</html>
