<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 도징 계산기 (최종 완성 버전)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-noto-sans-kr p-6">
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6">
        <h1 class="text-2xl font-bold mb-4">해수어항 도징 계산기</h1>
        <!-- 입력 폼 -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block font-medium">날짜</label>
                <input id="dateInput" type="date" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">온도 (°C)</label>
                <input id="tempInput" type="number" step="0.1" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">염도 (ppt)</label>
                <input id="salinityInput" type="number" step="0.1" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">pH</label>
                <input id="phInput" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">Ca (ppm)</label>
                <input id="caInput" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">Mg (ppm)</label>
                <input id="mgInput" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">KH (dKH)</label>
                <input id="khInput" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">NO₂ (ppm)</label>
                <input id="no2Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">NO₃ (ppm)</label>
                <input id="no3Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">PO₄ (ppm)</label>
                <input id="po4Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
        </div>
        <div class="flex space-x-4">
            <button id="saveRecordBtn" class="px-4 py-2 bg-blue-500 text-white rounded-2xl shadow hover:bg-blue-600">기록 저장</button>
            <button id="viewGraphsBtn" class="px-4 py-2 bg-green-500 text-white rounded-2xl shadow hover:bg-green-600">그래프 보기</button>
        </div>
    </div>

    <!-- 그래프 섹션 -->
    <div id="chartContainer" class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6 mt-6 hidden">
        <h2 class="text-xl font-bold mb-4">수질 파라미터 추이</h2>
        <canvas id="trendChart" height="200"></canvas>
    </div>

    <script>
        // 저장된 레코드를 localStorage에 저장하고 불러오기
        function getRecords() {
            return JSON.parse(localStorage.getItem('records') || '[]');
        }
        function saveRecords(records) {
            localStorage.setItem('records', JSON.stringify(records));
        }

        // 기록 저장 핸들러
        document.getElementById('saveRecordBtn').addEventListener('click', () => {
            const date = document.getElementById('dateInput').value;
            if (!date) { alert('날짜를 입력해주세요.'); return; }
            const record = {
                date,
                temp: parseFloat(document.getElementById('tempInput').value) || null,
                salinity: parseFloat(document.getElementById('salinityInput').value) || null,
                ph: parseFloat(document.getElementById('phInput').value) || null,
                ca: parseFloat(document.getElementById('caInput').value) || null,
                mg: parseFloat(document.getElementById('mgInput').value) || null,
                kh: parseFloat(document.getElementById('khInput').value) || null,
                no2: parseFloat(document.getElementById('no2Input').value) || null,
                no3: parseFloat(document.getElementById('no3Input').value) || null,
                po4: parseFloat(document.getElementById('po4Input').value) || null
            };
            const records = getRecords();
            // 중복 날짜 레코드 제거
            const filtered = records.filter(r => r.date !== date);
            filtered.push(record);
            saveRecords(filtered);
            alert('기록이 저장되었습니다.');
        });

        // 그래프 보기 핸들러
        document.getElementById('viewGraphsBtn').addEventListener('click', () => {
            const records = getRecords().sort((a, b) => a.date.localeCompare(b.date));
            if (records.length === 0) { alert('저장된 기록이 없습니다.'); return; }

            // 차트 데이터 준비
            const labels = records.map(r => r.date);
            const datasets = [];
            const params = ['temp','salinity','ph','ca','mg','kh','no2','no3','po4'];
            const colors = ['red','orange','yellow','green','blue','indigo','violet','gray','black'];
            params.forEach((key, i) => {
                datasets.push({
                    label: key,
                    data: records.map(r => r[key]),
                    borderColor: colors[i],
                    fill: false,
                    spanGaps: true
                });
            });

            // 기존 차트가 있으면 삭제
            if (window.trendChart) {
                window.trendChart.destroy();
            }

            const ctx = document.getElementById('trendChart').getContext('2d');
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    stacked: false,
                    scales: {
                        x: { display: true, title: { display: true, text: '날짜' } },
                        y: { display: true, title: { display: true, text: '값' } }
                    }
                }
            });

            // 차트 영역 표시
            document.getElementById('chartContainer').classList.remove('hidden');
        });
    </script>
</body>
</html>
