<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 로그 (초간단 안정화 버전)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .input-group { display: flex; align-items: center; margin-bottom: 1rem; }
        .input-group label { width: 100px; font-weight: 600; color: #4A5568; }
        .input-group input { flex: 1; padding: 0.5rem; border: 1px solid #CBD5E0; border-radius: 0.375rem; text-align: right; }
        #log-table th, #log-table td { padding: 0.75rem; text-align: center; font-size: 0.9rem; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">해수어항 관리 로그</h1>
            <p class="text-gray-600 mt-2">수치를 입력하고 '기록 저장' 버튼을 눌러주세요.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- 입력 폼 -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="input-group"><label for="recordDate">날짜</label><input type="date" id="recordDate"></div>
                <div class="input-group"><label for="ca">칼슘 (Ca)</label><input type="number" id="ca" placeholder="420"></div>
                <div class="input-group"><label for="mg">마그네슘 (Mg)</label><input type="number" id="mg" placeholder="1350"></div>
                <div class="input-group"><label for="kh">알칼리니티 (KH)</label><input type="number" step="0.1" id="kh" placeholder="8.0"></div>
                <div class="input-group"><label for="no3">질산염 (NO3)</label><input type="number" id="no3" placeholder="5"></div>
                <div class="input-group"><label for="po4">인산염 (PO4)</label><input type="number" step="0.01" id="po4" placeholder="0.05"></div>
                <button id="save-btn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">기록 저장</button>
                <p id="status-message" class="text-center mt-2 h-5"></p>
            </div>

            <!-- 로그 표시 -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">저장된 기록</h2>
                <div class="overflow-y-auto max-h-96">
                    <table id="log-table" class="w-full">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr><th>날짜</th><th>Ca</th><th>Mg</th><th>KH</th><th>NO3</th><th>PO4</th><th>삭제</th></tr>
                        </thead>
                        <tbody id="log-table-body">
                            <!-- 로그가 여기에 표시됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyA5__GOcjGtGdCivk1mVH5Vt_Z_C_uo80M",
  authDomain: "reef-e23b5.firebaseapp.com",
  projectId: "reef-e23b5",
  storageBucket: "reef-e23b5.firebasestorage.app",
  messagingSenderId: "747921036469",
  appId: "1:747921036469:web:bb96a9ee15a7dfd5c55afc",
  measurementId: "G-6X45DZVK1G"
};

        const saveBtn = document.getElementById('save-btn');
        const statusMessage = document.getElementById('status-message');
        const logTableBody = document.getElementById('log-table-body');
        const recordDateInput = document.getElementById('recordDate');
        const inputIds = ['ca', 'mg', 'kh', 'no3', 'po4'];

        // 오늘 날짜로 기본 설정
        const today = new Date();
        recordDateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch(e) {
            console.error("Firebase 초기화 오류:", e);
            statusMessage.textContent = "Firebase 초기화 실패. Config 정보를 확인하세요.";
            statusMessage.classList.add('text-red-500');
        }

        if (db) {
            const logsCollectionRef = collection(db, 'reef-logs');

            // 실시간으로 로그 불러오기
            const q = query(logsCollectionRef, orderBy('date', 'desc'));
            onSnapshot(q, (snapshot) => {
                logTableBody.innerHTML = '';
                if (snapshot.empty) {
                    logTableBody.innerHTML = `<tr><td colspan="7" class="text-gray-500 py-4">저장된 기록이 없습니다.</td></tr>`;
                } else {
                    snapshot.forEach(doc => {
                        const log = doc.data();
                        const tr = document.createElement('tr');
                        tr.className = "border-b";
                        tr.innerHTML = `
                            <td>${log.date}</td>
                            <td>${log.ca || '-'}</td>
                            <td>${log.mg || '-'}</td>
                            <td>${log.kh || '-'}</td>
                            <td>${log.no3 || '-'}</td>
                            <td>${log.po4 || '-'}</td>
                            <td><button data-id="${doc.id}" class="delete-btn text-red-500 hover:text-red-700">X</button></td>
                        `;
                        logTableBody.appendChild(tr);
                    });
                }
            }, (error) => {
                console.error("로그 불러오기 오류: ", error);
                statusMessage.textContent = "로그를 불러오지 못했습니다. 보안 규칙을 확인하세요.";
                statusMessage.classList.add('text-red-500');
            });

            // 기록 저장 버튼 이벤트
            saveBtn.addEventListener('click', async () => {
                const logData = {
                    date: recordDateInput.value
                };
                inputIds.forEach(id => {
                    const value = parseFloat(document.getElementById(id).value);
                    if (!isNaN(value)) {
                        logData[id] = value;
                    }
                });

                if (!logData.date) {
                    statusMessage.textContent = "날짜를 선택해주세요.";
                    statusMessage.classList.add('text-red-500');
                    return;
                }

                saveBtn.disabled = true;
                statusMessage.textContent = "저장 중...";
                statusMessage.classList.remove('text-red-500', 'text-green-500');

                try {
                    await addDoc(logsCollectionRef, logData);
                    statusMessage.textContent = "저장 완료!";
                    statusMessage.classList.add('text-green-500');
                    // 입력 필드 초기화 (선택 사항)
                    // inputIds.forEach(id => document.getElementById(id).value = '');
                } catch (error) {
                    console.error("저장 오류: ", error);
                    statusMessage.textContent = "저장 실패! 보안 규칙을 확인하세요.";
                    statusMessage.classList.add('text-red-500');
                } finally {
                    saveBtn.disabled = false;
                    setTimeout(() => statusMessage.textContent = '', 3000);
                }
            });

            // 삭제 버튼 이벤트 (이벤트 위임)
            logTableBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const docId = e.target.dataset.id;
                    try {
                        await deleteDoc(doc(db, 'reef-logs', docId));
                    } catch (error) {
                        console.error("삭제 오류: ", error);
                    }
                }
            });
        }
    </script>
</body>
</html>
