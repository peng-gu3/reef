<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 도징 계산기 (최종 완성 버전)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-noto-sans-kr p-6">
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6">
        <h1 class="text-2xl font-bold mb-4">해수어항 도징 계산기</h1>
        <!-- 입력 폼 -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block font-medium">날짜</label>
                <input id="dateInput" type="date" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">온도 (°C)</label>
                <input id="tempInput" type="number" step="0.1" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">염도 (ppt)</label>
                <input id="salinityInput" type="number" step="0.1" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">pH</label>
                <input id="phInput" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">Ca (ppm)</label>
                <input id="caInput" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">Mg (ppm)</label>
                <input id="mgInput" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">KH (dKH)</label>
                <input id="khInput" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">NO₂ (ppm)</label>
                <input id="no2Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">NO₃ (ppm)</label>
                <input id="no3Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
            <div>
                <label class="block font-medium">PO₄ (ppm)</label>
                <input id="po4Input" type="number" step="0.01" class="w-full border rounded p-2" />
            </div>
        </div>
        <div class="flex space-x-4">
            <button id="saveRecordBtn" class="px-4 py-2 bg-blue-500 text-white rounded-2xl shadow hover:bg-blue-600">기록 저장</button>
            <button id="viewGraphsBtn" class="px-4 py-2 bg-green-500 text-white rounded-2xl shadow hover:bg-green-600">그래프 보기</button>
            <button id="viewRecordsBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-2xl shadow hover:bg-yellow-600">기록 보기</button>
        </div>
    </div>

    <!-- 그래프 섹션 -->
    <div id="chartContainer" class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6 mt-6 hidden">
        <h2 class="text-xl font-bold mb-4">수질 파라미터 추이</h2>
        <canvas id="trendChart" height="200"></canvas>
    </div>

    <!-- 기록 및 비교 결과 섹션 -->
    <div id="viewRecordsContainer" class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6 mt-6 hidden">
        <h2 class="text-xl font-bold mb-4">저장된 기록 및 비교 결과</h2>
        <div class="overflow-x-auto mb-4">
            <table id="recordsTable" class="w-full table-auto border-collapse text-sm">
                <thead>
                    <tr>
                        <th class="border px-2 py-1">날짜</th>
                        <th class="border px-2 py-1">온도</th>
                        <th class="border px-2 py-1">염도</th>
                        <th class="border px-2 py-1">pH</th>
                        <th class="border px-2 py-1">Ca</th>
                        <th class="border px-2 py-1">Mg</th>
                        <th class="border px-2 py-1">KH</th>
                        <th class="border px-2 py-1">NO₂</th>
                        <th class="border px-2 py-1">NO₃</th>
                        <th class="border px-2 py-1">PO₄</th>
                        <th class="border px-2 py-1">상태</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="dosagePlan" class="bg-gray-50 p-4 rounded"></div>
    </div>

    <script>
        const volume = 160; // 수조 부피 (L)
        const reference = {
            temp: {min: 25, max: 26},
            salinity: {min: 34, max: 35},
            ph: {min: 8.0, max: 8.3},
            ca: {min: 420, max: 430, unitDose: v=>v/100},
            mg: {min: 1400, max: 1440, unitDose: v=>v/100},
            kh: {min: 7.0, max: 8.0, unitDose: v=>v/10},
            no2: {min: 0, max: 0.02},
            no3: {min: 0.5, max: 2.0, unitDose: v=>v/100},
            po4: {min: 0.03, max: 0.1}
        };

        function getRecords() {
            return JSON.parse(localStorage.getItem('records') || '[]');
        }
        function saveRecords(records) {
            localStorage.setItem('records', JSON.stringify(records));
        }

        document.getElementById('saveRecordBtn').addEventListener('click', () => {
            const date = document.getElementById('dateInput').value;
            if (!date) { alert('날짜를 입력해주세요.'); return; }
            const record = {
                date,
                temp: parseFloat(document.getElementById('tempInput').value) || null,
                salinity: parseFloat(document.getElementById('salinityInput').value) || null,
                ph: parseFloat(document.getElementById('phInput').value) || null,
                ca: parseFloat(document.getElementById('caInput').value) || null,
                mg: parseFloat(document.getElementById('mgInput').value) || null,
                kh: parseFloat(document.getElementById('khInput').value) || null,
                no2: parseFloat(document.getElementById('no2Input').value) || null,
                no3: parseFloat(document.getElementById('no3Input').value) || null,
                po4: parseFloat(document.getElementById('po4Input').value) || null
            };
            const records = getRecords().filter(r => r.date !== date);
            records.push(record);
            saveRecords(records);
            alert('기록이 저장되었습니다.');
        });

        document.getElementById('viewGraphsBtn').addEventListener('click', () => {
            const records = getRecords().sort((a,b)=>a.date.localeCompare(b.date));
            if (!records.length) { alert('저장된 기록이 없습니다.'); return; }
            const labels = records.map(r=>r.date);
            const params = ['temp','salinity','ph','ca','mg','kh','no2','no3','po4'];
            const colors = ['red','orange','yellow','green','blue','indigo','violet','gray','black'];
            const datasets = params.map((key,i)=>({ label:key, data:records.map(r=>r[key]), borderColor:colors[i], fill:false, spanGaps:true }));
            if(window.trendChart) window.trendChart.destroy();
            const ctx=document.getElementById('trendChart').getContext('2d');
            window.trendChart=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{x:{title:{display:true,text:'날짜'}},y:{title:{display:true,text:'값'}}}}});
            document.getElementById('chartContainer').classList.remove('hidden');
        });

        document.getElementById('viewRecordsBtn').addEventListener('click', () => {
            const records = getRecords().sort((a,b)=>a.date.localeCompare(b.date));
            if (!records.length) { alert('저장된 기록이 없습니다.'); return; }
            const tbody = document.querySelector('#recordsTable tbody');
            tbody.innerHTML='';
            records.forEach(r=>{
n                const state = []; // 상태 요약
                // 비교
                Object.keys(reference).forEach(key=>{
                    if(r[key]!=null && reference[key].min!=null){
                        if(r[key]<reference[key].min) state.push(`${key}: 낮음`);
                        else if(r[key]>reference[key].max) state.push(`${key}: 높음`);
                        else state.push(`${key}: 정상`);
                    }
                });
                const tr=document.createElement('tr');
                ['date','temp','salinity','ph','ca','mg','kh','no2','no3','po4'].forEach(key=>{
                    const td=document.createElement('td'); td.className='border px-2 py-1 text-center'; td.textContent=r[key]!=null? r[key] : '-'; tr.appendChild(td);
                });
                const tdState=document.createElement('td'); tdState.className='border px-2 py-1 text-left'; tdState.textContent=state.join(', ');
                tr.appendChild(tdState);
                tbody.appendChild(tr);
            });
            document.getElementById('viewRecordsContainer').classList.remove('hidden');

            // 도징 계획 (최신 레코드 기준)
            const latest = records[records.length-1];
            let planHTML = '<h3 class="font-semibold mb-2">7주간 도징 계획</h3><ul class="list-disc list-inside">';
            Object.keys(reference).forEach(key=>{
                const ref = reference[key];
                const val = latest[key];
                if(ref.unitDose && val!=null){
                    let target = ref.min;
                    if(val > ref.max) return; // 과잉이면 스킵
                    const diff = target - val;
                    if(diff<=0) return;
                    const totalDose = ref.unitDose(diff * volume);
                    const weekly = totalDose/7;
                    planHTML += `<li>${key.toUpperCase()}: 주당 ${weekly.toFixed(2)}ml</li>`;
                }
            });
            planHTML += '</ul>';
            document.getElementById('dosagePlan').innerHTML = planHTML;
        });
    </script>
</body>
</html>
