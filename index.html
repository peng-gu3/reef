<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해수어항 관리일지 (클라우드 연동)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; background-color: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        h1, h2 { color: #005a9c; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; text-align: center; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="number"], input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background-color 0.3s; width: 100%; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #log-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        #log-controls button { width: auto; background-color: #6c757d; padding: 8px 15px; font-size: 0.9rem; }
        #log-controls button.active { background-color: #005a9c; }
        #log-list { list-style: none; padding: 0; }
        #log-list li { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .log-entry-content { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.9rem; line-height: 1.6; color: #333; white-space: pre-wrap; }
        .log-entry-date { font-weight: bold; color: #005a9c; margin-bottom: 8px; width: 100%; }
        .delete-btn { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .delete-btn:hover { background-color: #c82333; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #005a9c; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay" style="display: none;">로딩 중...</div>

    <div class="container">
        <h1>🐠 해수어항 관리일지 (클라우드 연동)</h1>
        <div class="input-group" style="margin-bottom: 20px;">
            <label for="water-volume">물 용량 (L)</label>
            <input type="number" id="water-volume" placeholder="예: 120">
        </div>
    </div>

    <div class="container">
        <h2>📝 새 일지 작성</h2>
        <div class="input-grid">
            <div class="input-group"> <label for="temp">🌡️ 온도 (°C)</label> <input type="number" id="temp" step="0.1"> </div>
            <div class="input-group"> <label for="salinity">💧 염도 (ppt)</label> <input type="number" id="salinity" step="0.1"> </div>
            <div class="input-group"> <label for="ph">🧪 pH</label> <input type="number" id="ph" step="0.1"> </div>
            <div class="input-group"> <label for="kh_am">💎 KH (오전)</label> <input type="number" id="kh_am" step="0.1"> </div>
            <div class="input-group"> <label for="kh_pm">💎 KH (오후)</label> <input type="number" id="kh_pm" step="0.1"> </div>
            <div class="input-group"> <label for="calcium">🦴 칼슘 (ppm)</label> <input type="number" id="calcium"> </div>
            <div class="input-group"> <label for="magnesium">🔩 마그네슘 (ppm)</label> <input type="number" id="magnesium"> </div>
            <div class="input-group"> <label for="nitrite">🚫 아질산 (ppm)</label> <input type="number" id="nitrite" step="0.01"> </div>
            <div class="input-group"> <label for="nitrate">🌿 질산염 (ppm)</label> <input type="number" id="nitrate" step="0.1"> </div>
            <div class="input-group"> <label for="phosphate">🦠 인산염 (ppm)</label> <input type="number" id="phosphate" step="0.01"> </div>
        </div>
        <button id="add-log-btn" onclick="addLog()">일지 추가</button>
    </div>

    <div class="container"> <h2>📊 수치 변화 그래프</h2> <canvas id="logChart"></canvas> </div>

    <div class="container">
        <h2>📋 전체 기록</h2>
        <div id="log-controls">
            <button onclick="filterLogs('latest')" id="btn-latest" class="active">최근 1개</button>
            <button onclick="filterLogs('today')" id="btn-today">오늘</button>
            <button onclick="filterLogs('week')" id="btn-week">최근 7일</button>
            <button onclick="filterLogs('all')" id="btn-all">전체 보기</button>
        </div>
        <ul id="log-list"></ul>
    </div>

<script>
    // ==================================================================
    // ❗️❗️ 1단계에서 복사한 웹 앱 URL을 아래에 붙여넣으세요 ❗️❗️
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzO9vweYV1Z5PExTwQipj5sP-nLke-I1k2gQ3_V2zPprysB3aMCQrGLMR05dB2B9g8BSA/exec';
    // ==================================================================

    const paramDetails = {
        temp: { label: '🌡️ 온도', unit: '°C' }, salinity: { label: '💧 염도', unit: 'ppt' }, ph: { label: '🧪 pH', unit: '' }, kh_am: { label: '💎 KH (오전)', unit: '' }, kh_pm: { label: '💎 KH (오후)', unit: '' }, calcium: { label: '🦴 칼슘', unit: 'ppm' }, magnesium: { label: '🔩 마그네슘', unit: 'ppm' }, nitrite: { label: '🚫 아질산', unit: 'ppm' }, nitrate: { label: '🌿 질산염', unit: 'ppm' }, phosphate: { label: '🦠 인산염', unit: 'ppm' }
    };
    let logChart;
    let logs = [];
    let currentFilter = 'latest';

    document.addEventListener('DOMContentLoaded', () => {
        if (WEB_APP_URL === '여기에_웹_앱_URL을_붙여넣으세요') {
            alert('HTML 파일의 스크립트에서 WEB_APP_URL 변수를 설정해야 합니다!');
            return;
        }
        loadDataFromServer();
        const savedVolume = localStorage.getItem('fishTankVolume'); // 물 용량은 로컬에 저장
        if (savedVolume) {
            document.getElementById('water-volume').value = savedVolume;
        }
        document.getElementById('water-volume').addEventListener('change', (e) => {
            localStorage.setItem('fishTankVolume', e.target.value);
        });
        initializeChart();
    });

    function toggleLoading(isLoading) {
        document.getElementById('loading').style.display = isLoading ? 'flex' : 'none';
        document.getElementById('add-log-btn').disabled = isLoading;
    }

    async function loadDataFromServer() {
        toggleLoading(true);
        try {
            const response = await fetch(WEB_APP_URL);
            const data = await response.json();
            logs = data;
            renderAll();
        } catch (error) {
            console.error('데이터 로딩 실패:', error);
            alert('데이터를 불러오는 데 실패했습니다. 콘솔을 확인해주세요.');
        } finally {
            toggleLoading(false);
        }
    }

    async function saveDataToServer() {
        toggleLoading(true);
        try {
            await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' }, // Apps Script는 text/plain을 더 잘 처리함
                body: JSON.stringify(logs)
            });
        } catch (error) {
            console.error('데이터 저장 실패:', error);
            alert('데이터를 저장하는 데 실패했습니다. 콘솔을 확인해주세요.');
        } finally {
            toggleLoading(false);
        }
    }
    
    function renderAll() {
        logs.sort((a, b) => new Date(b.date) - new Date(a.date));
        renderLogs();
        updateChart();
    }

    async function addLog() {
        const newLog = { date: new Date().toISOString() };
        let hasValue = false;
        Object.keys(paramDetails).forEach(key => {
            const value = document.getElementById(key).value;
            if (value !== '') {
                newLog[key] = parseFloat(value);
                hasValue = true;
            }
        });

        if (!hasValue) {
            alert('하나 이상의 값을 입력해주세요.');
            return;
        }

        logs.push(newLog);
        renderAll();
        await saveDataToServer();
        
        Object.keys(paramDetails).forEach(key => { document.getElementById(key).value = ''; });
    }

    async function deleteLog(index) {
        if (confirm('이 기록을 삭제하시겠습니까?')) {
            logs.splice(index, 1);
            renderAll();
            await saveDataToServer();
        }
    }
    
    function filterLogs(filter) {
        currentFilter = filter;
        document.querySelectorAll('#log-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${filter}`).classList.add('active');
        renderLogs();
    }

    function renderLogs() {
        const logList = document.getElementById('log-list');
        logList.innerHTML = '';
        const filteredLogs = getFilteredLogs();

        filteredLogs.forEach((log) => {
            const originalIndex = logs.findIndex(originalLog => originalLog.date === log.date);
            const li = document.createElement('li');
            const date = new Date(log.date);
            const formattedDate = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${date.getHours()}시 ${date.getMinutes()}분`;
            let content = `<div class="log-entry-content"><div class="log-entry-date">${formattedDate}</div>`;
            Object.keys(paramDetails).forEach(key => {
                if (log[key] !== undefined) {
                    content += `<span>${paramDetails[key].label}: ${log[key]} ${paramDetails[key].unit}</span><br>`;
                }
            });
            content += `</div>`;
            let deleteButton = `<button class="delete-btn" onclick="deleteLog(${originalIndex})">삭제</button>`;
            li.innerHTML = content + deleteButton;
            logList.appendChild(li);
        });
    }
    
    function getFilteredLogs() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 6);

        switch (currentFilter) {
            case 'latest': return logs.slice(0, 1);
            case 'today': return logs.filter(log => new Date(log.date) >= today);
            case 'week': return logs.filter(log => new Date(log.date) >= sevenDaysAgo);
            case 'all': default: return logs;
        }
    }

    function initializeChart() {
        const ctx = document.getElementById('logChart').getContext('2d');
        logChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: '🌡️ 온도', data: [], borderColor: '#ff6384', tension: 0.1, hidden: true },
                    { label: '💧 염도', data: [], borderColor: '#36a2eb', tension: 0.1, hidden: true },
                    { label: '🧪 pH', data: [], borderColor: '#cc65fe', tension: 0.1, hidden: true },
                    { label: '💎 KH (오전)', data: [], borderColor: '#ffce56', tension: 0.1 },
                    { label: '💎 KH (오후)', data: [], borderColor: '#ff9f40', tension: 0.1 },
                    { label: '🦴 칼슘', data: [], borderColor: '#4bc0c0', tension: 0.1, hidden: true },
                    { label: '🔩 마그네슘', data: [], borderColor: '#9966ff', tension: 0.1, hidden: true },
                    { label: '🚫 아질산', data: [], borderColor: '#c9cbcf', tension: 0.1, hidden: true },
                    { label: '🌿 질산염', data: [], borderColor: '#77dd77', tension: 0.1, hidden: true },
                    { label: '🦠 인산염', data: [], borderColor: '#fdfd96', tension: 0.1, hidden: true }
                ]
            },
            options: { responsive: true, scales: { x: { ticks: { maxRotation: 90, minRotation: 45 } }, y: { beginAtZero: false } }, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } } }
        });
    }

    function updateChart() {
        const sortedLogs = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
        logChart.data.labels = sortedLogs.map(log => {
            const d = new Date(log.date);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        });
        logChart.data.datasets.forEach((dataset, index) => {
            const key = Object.keys(paramDetails)[index];
            if (dataset.label.includes('KH (오후)')) {
                dataset.data = sortedLogs.map(log => log['kh_pm'] !== undefined ? log['kh_pm'] : null);
            } else {
                dataset.data = sortedLogs.map(log => log[key] !== undefined ? log[key] : null);
            }
        });
        logChart.update();
    }
</script>

</body>
</html>
