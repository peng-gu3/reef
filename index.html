<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 완제품 재고 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .table-auto th, .table-auto td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
        }
        .table-auto thead th {
            background-color: #f8fafc;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">실시간 완제품 재고 관리 시스템</h1>
            <p class="text-gray-600 mt-2">생산 및 출고 내역을 입력하면 재고가 자동으로 업데이트됩니다.</p>
            <button id="reset-data-btn" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 hidden">
                강제 초기화
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Forms Section -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Production Form -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-600">생산 등록</h2>
                    <form id="production-form" class="space-y-4">
                        <div>
                            <label for="prod-item" class="block text-sm font-medium text-gray-700">ITEM NO.</label>
                            <input type="text" id="prod-item" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: ALS910C" required>
                        </div>
                        <div>
                            <label for="prod-size" class="block text-sm font-medium text-gray-700">SIZE</label>
                            <input type="text" id="prod-size" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 1/8&quot;" required>
                        </div>
                        <div>
                            <label for="prod-lot" class="block text-sm font-medium text-gray-700">LOT NO.</label>
                            <input type="text" id="prod-lot" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 2501C321" required>
                        </div>
                        <div>
                            <label for="prod-quantity" class="block text-sm font-medium text-gray-700">수량 (LB)</label>
                            <input type="number" id="prod-quantity" min="0.1" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">생산 추가</button>
                    </form>
                </div>

                <!-- Shipping Form -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-red-600">출고 등록</h2>
                    <form id="shipping-form" class="space-y-4">
                        <div>
                            <label for="ship-item" class="block text-sm font-medium text-gray-700">ITEM NO.</label>
                             <input type="text" id="ship-item" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="예: ALS910C" required>
                        </div>
                        <div>
                            <label for="ship-size" class="block text-sm font-medium text-gray-700">SIZE</label>
                            <input type="text" id="ship-size" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="예: 1/8&quot;" required>
                        </div>
                        <div>
                            <label for="ship-lot" class="block text-sm font-medium text-gray-700">LOT NO.</label>
                            <input type="text" id="ship-lot" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="출고되는 제품 Lot No." required>
                        </div>
                        <div>
                            <label for="ship-quantity" class="block text-sm font-medium text-gray-700">수량 (LB)</label>
                            <input type="number" id="ship-quantity" min="0.1" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">출고 처리</button>
                    </form>
                </div>
            </div>

            <!-- Inventory List Section -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">완제품 재고 현황</h2>
                 <div id="loading" class="text-center py-10">
                    <p>시스템 초기화 중...</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="inventory-table" class="w-full table-auto text-sm text-left hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3">ITEM NO.</th>
                                <th class="p-3">SIZE</th>
                                <th class="p-3 text-right">현재고 (LB)</th>
                                <th class="p-3">최근 LOT NO.</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Logs Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">생산 기록</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white"><tr><th>일시</th><th>ITEM</th><th>SIZE</th><th>수량</th><th>LOT</th></tr></thead>
                        <tbody id="production-log"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">출고 기록</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white"><tr><th>일시</th><th>ITEM</th><th>SIZE</th><th>수량</th><th>LOT</th></tr></thead>
                        <tbody id="shipping-log"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for notifications -->
    <div id="modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-sm rounded-lg shadow-xl p-6 text-center transform scale-95">
            <p id="modal-message" class="text-lg"></p>
            <div class="mt-6 space-x-4">
                <button id="modal-confirm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700 transition duration-150 hidden">확인</button>
                <button id="modal-close" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-900 transition duration-150">닫기</button>
            </div>
        </div>
    </div>
    
    <script type="module">
  // Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    collection,
    onSnapshot,
    addDoc,
    getDocs,
    setDoc,
    serverTimestamp,
    query,
    orderBy,
    runTransaction,
    deleteField
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  document.addEventListener('DOMContentLoaded', () => {
    const loadingEl = document.getElementById('loading');

    function startApp() {
      // --- UI Elements ---
      const inventoryTableEl = document.getElementById('inventory-table');
      const inventoryBodyEl = document.getElementById('inventory-body');
      const productionForm = document.getElementById('production-form');
      const shippingForm = document.getElementById('shipping-form');
      const productionLogEl = document.getElementById('production-log');
      const shippingLogEl = document.getElementById('shipping-log');
      const modal = document.getElementById('modal');
      const modalMessage = document.getElementById('modal-message');
      const modalClose = document.getElementById('modal-close');
      const filterInput = document.getElementById('filter-input');
      const exportBtn = document.getElementById('export-csv');

      // --- App State ---
      let userId = null;
      let localInventory = {}; // { [itemNo]: { [size]: { quantity, lot, lots: { [lotNo]: number } } } }
      let inventoryUnsubscribe = null;
      let productionLogUnsubscribe = null;
      let shippingLogUnsubscribe = null;

      // appId: __app_id → URL ?app= → localStorage → default
      const appId = (() => {
        if (typeof __app_id !== 'undefined' && __app_id) return __app_id;
        const q = new URLSearchParams(location.search);
        const fromUrl = q.get('app');
        if (fromUrl) { localStorage.setItem('app_id', fromUrl); return fromUrl; }
        const fromLs = localStorage.getItem('app_id');
        return fromLs || 'default-app-id';
      })();

      // --- Firebase Initialization ---
      let app, auth, db;
      try {
        const firebaseConfig = (() => {
          const g = window.__firebase_config;
          if (typeof g === 'string' && g.trim()) return JSON.parse(g);
          if (g && typeof g === 'object') return g;

          // <script id="firebase-config" type="application/json">{...}</script> 지원
          const el = document.getElementById('firebase-config');
          if (el && el.textContent.trim()) return JSON.parse(el.textContent);

          // LocalStorage 지원
          const ls = localStorage.getItem('firebase_config');
          if (ls) return JSON.parse(ls);

          // URL 매개변수 지원 (?firebase=...  또는 base64/json)
          const p = new URLSearchParams(location.search).get('firebase');
          if (p) {
            try { return JSON.parse(decodeURIComponent(atob(p))); } catch {}
            try { return JSON.parse(p); } catch {}
          }
          throw new Error('Firebase config not found');
        })();

        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
      } catch (error) {
        console.error('Firebase Initialization Failed:', error);
        // 설정 입력 UI 제공
        loadingEl.innerHTML = '시스템 설정을 찾지 못했습니다. 아래에 설정(JSON)을 붙여넣고 저장하세요.' +
          '<div class="mt-3">' +
          '<textarea id="cfg-ta" class="w-full border rounded p-2" rows="8" placeholder="{...firebase config...}"></textarea>' +
          '<button id="cfg-save" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">저장</button>' +
          '</div>';
        setTimeout(() => {
          const btn = document.getElementById('cfg-save');
          btn?.addEventListener('click', () => {
            const ta = document.getElementById('cfg-ta');
            try {
              const parsed = JSON.parse(ta.value);
              localStorage.setItem('firebase_config', JSON.stringify(parsed));
              location.reload();
            } catch (e) { alert('JSON 형식이 올바르지 않습니다.'); }
          });
        }, 0);
        return;
      }

      // --- Utils ---
      const showModal = (msg) => {
        modalMessage.textContent = msg;
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        setTimeout(() => modal.querySelector('.modal-container').classList.remove('scale-95'), 10);
      };
      const hideModal = () => {
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-container').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 300);
      };
      modalClose.addEventListener('click', hideModal);

      const normItem = (v) => v.trim().toUpperCase();
      const normSize = (v) => v.trim().replace(/\s+/g, ' ');
      const normLot   = (v) => v.trim().toUpperCase();

      // --- Rendering ---
      function renderInventory(raw) {
        const keyword = filterInput.value.trim().toUpperCase();
        inventoryBodyEl.innerHTML = '';
        const items = Object.keys(raw).sort();
        if (!items.length) {
          inventoryBodyEl.innerHTML = `<tr><td colspan="5" class="text-center p-5">재고 데이터가 없습니다. 생산 등록을 시작해주세요.</td></tr>`;
          return;
        }
        for (const itemNo of items) {
          const sizes = raw[itemNo] || {};
          const sizeKeys = Object.keys(sizes).sort();
          for (const size of sizeKeys) {
            const data = sizes[size] || {};
            const lotPairs = Object.entries(data.lots || {})
              .filter(([_, q]) => typeof q === 'number' && q > 0)
              .sort(([a], [b]) => a.localeCompare(b));
            const lotsStr = lotPairs.map(([lt, q]) => `${lt}: ${q.toFixed(1)}LB`).join(', ');

            const rowText = `${itemNo} ${size} ${data.lot || ''} ${lotsStr}`.toUpperCase();
            if (keyword && !rowText.includes(keyword)) continue;

            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `
              <td class="p-3 font-medium">${itemNo}</td>
              <td class="p-3">${size}</td>
              <td class="p-3 text-right">${(data.quantity || 0).toFixed(1)}</td>
              <td class="p-3">${data.lot || ''}</td>
              <td class="p-3">${lotsStr || '-'}</td>
            `;
            inventoryBodyEl.appendChild(tr);
          }
        }
      }

      function renderLog(logEl, logs) {
        logEl.innerHTML = '';
        logs.forEach((log) => {
          const row = document.createElement('tr');
          row.className = 'border-b';
          const ts = log.timestamp?.toDate?.() ? log.timestamp.toDate() : null;
          row.innerHTML = `
            <td class="p-2">${ts ? ts.toLocaleString('ko-KR', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}</td>
            <td class="p-2">${log.itemNo}</td>
            <td class="p-2">${log.size}</td>
            <td class="p-2">${Number(log.quantity).toFixed(1)}</td>
            <td class="p-2">${log.lot}</td>
          `;
          logEl.appendChild(row);
        });
      }

      filterInput.addEventListener('input', () => renderInventory(localInventory));
      exportBtn.addEventListener('click', () => {
        // CSV Export (item,size,qty,latestLot,lotBalances)
        const rows = [['ITEM NO', 'SIZE', 'QTY(LB)', 'LATEST LOT', 'LOT BALANCES']];
        for (const [itemNo, sizes] of Object.entries(localInventory)) {
          for (const [size, data] of Object.entries(sizes)) {
            const lots = Object.entries(data.lots || {})
              .filter(([_, q]) => typeof q === 'number' && q > 0)
              .map(([lot, q]) => `${lot}:${q}`)
              .join('|');
            rows.push([itemNo, size, (data.quantity || 0).toFixed(1), data.lot || '', lots]);
          }
        }
        const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"', '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inventory_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // --- Real-time & bootstrap ---
      async function setupRealtimeListeners() {
        const base = ['artifacts', appId, 'users', userId];
        const inventoryCol = collection(db, ...base, 'inventory');
        const prodLogCol   = collection(db, ...base, 'productionLog');
        const shipLogCol   = collection(db, ...base, 'shippingLog');

        // 초기재고 자동 생성
        const initial = await getDocs(inventoryCol);
        if (initial.empty) await populateInitialData();

        inventoryUnsubscribe = onSnapshot(inventoryCol, (snap) => {
          const obj = {};
          snap.forEach((d) => { obj[d.id] = d.data(); });
          localInventory = obj;
          renderInventory(localInventory);
          loadingEl.style.display = 'none';
          inventoryTableEl.classList.remove('hidden');
        });

        productionLogUnsubscribe = onSnapshot(query(prodLogCol, orderBy('timestamp', 'desc')), (snap) => {
          const logs = snap.docs.map(d => d.data());
          renderLog(productionLogEl, logs);
        });
        shippingLogUnsubscribe = onSnapshot(query(shipLogCol, orderBy('timestamp', 'desc')), (snap) => {
          const logs = snap.docs.map(d => d.data());
          renderLog(shippingLogEl, logs);
        });
      }

      async function populateInitialData() {
        const itemNos = ["ALS910C", "ALS900G", "ALS955W", "ALS970", "ALS990", "ALS420", "ALS610", "ALS620", "ALS623S", "ALS630N", "ALS640K", "ALS350Y"];
        const sizes = ["1/8\"", "3/16\"", "1/4\"", "5/16\"", "3/8\"", "7/16\"", "1/2\"", "9/16\"", "5/8\"", "11/16\"", "3/4\"", "13/16\"", "7/8\"", "1\"", "1-1/8\"", "1-1/4\""];
        showModal('초기 재고 데이터를 설정합니다...');
        const tasks = itemNos.map((itemNo) => {
          const sizeData = {};
          sizes.forEach((s) => { sizeData[s] = { quantity: 0, lot: '', lots: {} }; });
          const ref = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
          return setDoc(ref, sizeData);
        });
        await Promise.all(tasks);
      }

      // --- Event Handlers with TRANSACTION + FIFO ---
      productionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemNo  = normItem(document.getElementById('prod-item').value);
        const size    = normSize(document.getElementById('prod-size').value);
        const lot     = normLot(document.getElementById('prod-lot').value);
        const quantity = parseFloat(document.getElementById('prod-quantity').value);
        if (!itemNo || !size || !lot || isNaN(quantity) || quantity <= 0) {
          showModal('모든 필드를 올바르게 입력해주세요.');
          return;
        }

        const invRef     = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
        const prodLogCol = collection(db, 'artifacts', appId, 'users', userId, 'productionLog');
        try {
          await runTransaction(db, async (tx) => {
            const snap = await tx.get(invRef);
            if (!snap.exists()) tx.set(invRef, {});
            const data   = snap.data() || {};
            const sizeObj = { quantity: 0, lot: '', lots: {}, ...(data[size] || {}) };
            const curQty  = Number(sizeObj.quantity || 0);
            sizeObj.quantity = +(curQty + quantity).toFixed(3);
            sizeObj.lot = lot; // 최근 LOT 갱신
            sizeObj.lots = { ...(sizeObj.lots || {}) };
            const lotQty = Number(sizeObj.lots[lot] || 0);
            sizeObj.lots[lot] = +(lotQty + quantity).toFixed(3);
            tx.set(invRef, { [size]: sizeObj }, { merge: true });
          });
          await addDoc(prodLogCol, { itemNo, size, lot, quantity, timestamp: serverTimestamp() });
          showModal('생산 등록이 완료되었습니다.');
          productionForm.reset();
        } catch (err) {
          console.error(err);
          showModal('오류가 발생했습니다: ' + err.message);
        }
      });

      shippingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemNo  = normItem(document.getElementById('ship-item').value);
        const size    = normSize(document.getElementById('ship-size').value);
        const lot     = normLot(document.getElementById('ship-lot').value);
        const quantity = parseFloat(document.getElementById('ship-quantity').value);
        if (!itemNo || !size || !lot || isNaN(quantity) || quantity <= 0) {
          showModal('모든 필드를 올바르게 입력해주세요.');
          return;
        }

        const invRef     = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
        const shipLogCol = collection(db, 'artifacts', appId, 'users', userId, 'shippingLog');

        try {
          await runTransaction(db, async (tx) => {
            const snap = await tx.get(invRef);
            if (!snap.exists()) throw new Error('해당 ITEM의 재고 문서가 없습니다.');
            const data   = snap.data() || {};
            const sizeObj = { quantity: 0, lot: '', lots: {}, ...(data[size] || {}) };
            const totalQty = Number(sizeObj.quantity || 0);
            const lotQty   = Number((sizeObj.lots || {})[lot] || 0);
            if (lotQty < quantity) throw new Error(`지정 LOT(${lot}) 재고 부족: ${lotQty.toFixed(1)} LB`);
            if (totalQty < quantity) throw new Error(`총 재고 부족: ${totalQty.toFixed(1)} LB`);

            // 차감
            const newTotal = +(totalQty - quantity).toFixed(3);
            const newLotQty = +(lotQty   - quantity).toFixed(3);
            sizeObj.quantity = newTotal;
            sizeObj.lots = { ...(sizeObj.lots || {}) };
            if (newLotQty <= 0) {
              sizeObj.lots[lot] = deleteField(); // 필드 제거 지시
            } else {
              sizeObj.lots[lot] = newLotQty;
            }

            // 잔량 있는 LOT 중 하나를 대표 LOT로 유지
            const remainLots = Object.entries(sizeObj.lots)
              .filter(([_, v]) => typeof v === 'number' && v > 0)
              .map(([k]) => k)
              .sort();
            sizeObj.lot = remainLots[remainLots.length - 1] || '';

            tx.set(invRef, { [size]: sizeObj }, { merge: true });
          });

          await addDoc(shipLogCol, { itemNo, size, lot, quantity, timestamp: serverTimestamp() });
          showModal('출고 처리가 완료되었습니다.');
          shippingForm.reset();
        } catch (err) {
          console.error(err);
          showModal('오류가 발생했습니다: ' + err.message);
        }
      });

      // --- Auth & bootstrap ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userId = user.uid;
          if (inventoryUnsubscribe) inventoryUnsubscribe();
          if (productionLogUnsubscribe) productionLogUnsubscribe();
          if (shippingLogUnsubscribe) shippingLogUnsubscribe();
          await setupRealtimeListeners();
        }
      });

      async function main() {
        try {
          // token: __initial_auth_token → URL ?token= → localStorage → ''
          const token = (() => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) return __initial_auth_token;
            const q = new URLSearchParams(location.search).get('token');
            if (q) { localStorage.setItem('auth_token', q); return q; }
            const fromLs = localStorage.getItem('auth_token');
            return fromLs || '';
          })();

          if (token) {
            await signInWithCustomToken(auth, token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error('Authentication failed:', error);
          loadingEl.textContent = '인증에 실패했습니다. 페이지를 새로고침해주세요.';
        }
      }
      main();
    }

    // --- Config 대기 로직 (객체/문자열 모두 안전) ---
    function hasFirebaseConfig() {
      const g = window.__firebase_config;
      if ((typeof g === 'string' && g.trim()) || (g && typeof g === 'object')) return true;
      const el = document.getElementById('firebase-config');
      if (el && el.textContent.trim()) return true;
      if (localStorage.getItem('firebase_config')) return true;
      const p = new URLSearchParams(location.search).get('firebase');
      return !!p;
    }

    function waitForConfig(retries = 0) {
      if (hasFirebaseConfig()) {
        startApp();
      } else if (retries < 150) { // 최대 15초 대기
        setTimeout(() => waitForConfig(retries + 1), 100);
      } else {
        // 마지막 안전그물: 붙여넣기 UI
        loadingEl.innerHTML = '시스템 설정 로딩에 실패했습니다. 아래에 설정(JSON)을 붙여넣고 저장하세요.' +
          '<div class="mt-3">' +
          '<textarea id="cfg-ta" class="w-full border rounded p-2" rows="8" placeholder="{...firebase config...}"></textarea>' +
          '<button id="cfg-save" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded">저장</button>' +
          '</div>';
        setTimeout(() => {
          const btn = document.getElementById('cfg-save');
          btn?.addEventListener('click', () => {
            const ta = document.getElementById('cfg-ta');
            try {
              const parsed = JSON.parse(ta.value);
              localStorage.setItem('firebase_config', JSON.stringify(parsed));
              location.reload();
            } catch (e) { alert('JSON 형식이 올바르지 않습니다.'); }
          });
        }, 0);
      }
    }

    waitForConfig();
  });
</script>

</body>
</html>

