<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>자동 재고관리 대장</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Pretendard", "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        --gap: 12px;
        --radius: 12px;
        --shadow: 0 6px 20px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 32px;
        background: #f5f6fb;
        color: #0f172a;
      }

      h1 {
        margin: 0 0 24px;
        font-size: clamp(1.8rem, 2.4vw + 1rem, 2.6rem);
        font-weight: 700;
      }

      h2 {
        margin: 0 0 12px;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .layout {
        display: grid;
        gap: 24px;
      }

      .card {
        background: #ffffff;
        border-radius: var(--radius);
        padding: 22px;
        box-shadow: var(--shadow);
      }

      .muted {
        margin-top: 6px;
        font-size: 0.85rem;
        color: #64748b;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: var(--gap);
        align-items: center;
      }

      .grid > * {
        min-width: 0;
      }

      label {
        font-size: 0.85rem;
        color: #334155;
        display: inline-block;
        margin-bottom: 4px;
        font-weight: 600;
      }

      input,
      select {
        width: 100%;
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        background: #f8f9ff;
        font-size: 0.95rem;
        transition: 0.2s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #6366f1;
        background: #ffffff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }

      button {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        transition: 0.2s;
      }

      button.primary {
        background: linear-gradient(135deg, #6366f1, #4338ca);
        color: #fff;
        box-shadow: 0 12px 20px rgba(79, 70, 229, 0.2);
      }

      button.secondary {
        background: #e2e8f0;
        color: #1e293b;
      }

      button.ghost {
        background: transparent;
        color: #ef4444;
        padding: 6px 10px;
        font-size: 0.85rem;
      }

      button:hover {
        filter: brightness(1.05);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
        border-radius: 16px;
        overflow: hidden;
      }

      th,
      td {
        border: 1px solid #e2e8f0;
        padding: 10px 12px;
        text-align: left;
        font-size: 0.9rem;
      }

      thead th {
        background: #eef2ff;
        color: #312e81;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .pill-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .pill {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 10px;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0f172a;
        font-weight: 600;
      }

      .pill small {
        font-weight: 500;
        color: #475569;
      }

      .empty {
        text-align: center;
        color: #cbd5f5;
        font-size: 0.8rem;
        padding: 18px 0;
      }

      .sticky-col {
        position: sticky;
        left: 0;
        background: #eef2ff;
        font-weight: 600;
        z-index: 2;
      }

      .wrap-scroll {
        overflow-x: auto;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        font-size: 0.8rem;
        background: #e0f2fe;
        color: #0f172a;
        border-radius: 999px;
      }

      @media (max-width: 960px) {
        body {
          padding: 22px;
        }

        .grid {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .wrap-scroll {
          margin-bottom: 12px;
        }

        th,
        td {
          font-size: 0.85rem;
          padding: 8px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <header>
        <h1>자동 재고관리 대장</h1>
        <p class="muted">
          생산 실적과 출고 내역을 입력하면 LOT 별 잔량을 실시간으로 계산하고, SIZE × ITEM 매트릭스로 잔량을 시각화합니다.
        </p>
      </header>

      <section class="card">
        <div class="section-title">
          <h2>재고 현황판 (실시간)</h2>
          <span class="tag">SIZE × ITEM 잔량</span>
        </div>
        <div class="wrap-scroll">
          <table id="matrixTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>생산 내역</h2>
          <span class="tag">잔량 반영</span>
        </div>
        <div class="muted">검색/필터를 적용하면 잔량이 반영된 생산 내역만 조회됩니다.</div>
        <div class="grid" style="margin: 18px 0;">
          <div>
            <label for="prodSearch">검색어 (LOT/원자재LOT/작업자/치수)</label>
            <input id="prodSearch" type="search" placeholder="검색어" />
          </div>
          <div>
            <label for="prodLot">LOT</label>
            <input id="prodLot" placeholder="예: LOT-001" />
          </div>
          <div>
            <label for="prodItem">ITEM</label>
            <select id="prodItem"></select>
          </div>
          <div>
            <label for="prodSize">SIZE</label>
            <select id="prodSize"></select>
          </div>
          <div>
            <label for="prodFrom">생산일자 FROM</label>
            <input id="prodFrom" type="date" />
          </div>
          <div>
            <label for="prodTo">생산일자 TO</label>
            <input id="prodTo" type="date" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="prodReset" class="secondary">초기화</button>
          </div>
        </div>
        <div class="wrap-scroll">
          <table>
            <thead>
              <tr>
                <th>LOT</th>
                <th>생산일자</th>
                <th>ITEM</th>
                <th>SIZE</th>
                <th>포장 (LB)</th>
                <th>출고 후 잔량 (LB)</th>
                <th>원자재 LOT</th>
                <th>치수</th>
                <th>작업자</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody id="prodBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>생산리스트 입력</h2>
        <form id="prodForm" class="grid" style="margin-top: 14px;">
          <div>
            <label for="prodInputLot">LOT</label>
            <input id="prodInputLot" required placeholder="LOT 번호" />
          </div>
          <div>
            <label for="prodInputDate">생산일자</label>
            <input id="prodInputDate" type="date" required />
          </div>
          <div>
            <label for="prodInputItem">ITEM</label>
            <select id="prodInputItem"></select>
          </div>
          <div>
            <label for="prodInputSize">SIZE</label>
            <select id="prodInputSize"></select>
          </div>
          <div>
            <label for="prodInputPack">포장 (LB)</label>
            <input id="prodInputPack" type="number" min="0" step="0.1" required />
          </div>
          <div>
            <label for="prodInputRaw">원자재 LOT</label>
            <input id="prodInputRaw" placeholder="원자재 LOT" />
          </div>
          <div>
            <label for="prodInputDim">치수</label>
            <input id="prodInputDim" placeholder="치수" />
          </div>
          <div>
            <label for="prodInputWorker">작업자</label>
            <input id="prodInputWorker" placeholder="작업자" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" type="submit">생산 저장</button>
          </div>
        </form>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>출고 내역</h2>
          <span class="tag">잔량 차감</span>
        </div>
        <div class="grid" style="margin: 18px 0;">
          <div>
            <label for="outSearch">검색어 (오더/발전소/용도/출고자/LOT)</label>
            <input id="outSearch" type="search" placeholder="검색어" />
          </div>
          <div>
            <label for="outOrder">Order No</label>
            <input id="outOrder" placeholder="Order No" />
          </div>
          <div>
            <label for="outLot">생산 LOT</label>
            <input id="outLot" placeholder="LOT" />
          </div>
          <div>
            <label for="outItem">ITEM</label>
            <select id="outItem"></select>
          </div>
          <div>
            <label for="outSize">SIZE</label>
            <select id="outSize"></select>
          </div>
          <div>
            <label for="outFrom">출고일자 FROM</label>
            <input id="outFrom" type="date" />
          </div>
          <div>
            <label for="outTo">출고일자 TO</label>
            <input id="outTo" type="date" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="outReset" class="secondary">초기화</button>
          </div>
        </div>
        <div class="wrap-scroll">
          <table>
            <thead>
              <tr>
                <th>출고일자</th>
                <th>Order No</th>
                <th>발전소</th>
                <th>호기</th>
                <th>용도</th>
                <th>ITEM</th>
                <th>SIZE</th>
                <th>출고 (LB)</th>
                <th>생산 LOT</th>
                <th>출고자</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody id="outBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>출고리스트 입력</h2>
        <form id="outForm" class="grid" style="margin-top: 14px;">
          <div>
            <label for="outInputDate">출고일자</label>
            <input id="outInputDate" type="date" required />
          </div>
          <div>
            <label for="outInputOrder">Order No</label>
            <input id="outInputOrder" placeholder="Order No" />
          </div>
          <div>
            <label for="outInputPower">발전소</label>
            <input id="outInputPower" placeholder="발전소명" />
          </div>
          <div>
            <label for="outInputUnit">호기</label>
            <input id="outInputUnit" placeholder="호기" />
          </div>
          <div>
            <label for="outInputUse">용도</label>
            <input id="outInputUse" placeholder="용도" />
          </div>
          <div>
            <label for="outInputItem">ITEM</label>
            <select id="outInputItem"></select>
          </div>
          <div>
            <label for="outInputSize">SIZE</label>
            <select id="outInputSize"></select>
          </div>
          <div>
            <label for="outInputLb">출고 (LB)</label>
            <input id="outInputLb" type="number" min="0" step="0.1" required />
          </div>
          <div>
            <label for="outInputLot">생산 LOT</label>
            <input id="outInputLot" placeholder="생산 LOT" required />
          </div>
          <div>
            <label for="outInputWorker">출고자</label>
            <input id="outInputWorker" placeholder="출고자" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" type="submit">출고 저장</button>
          </div>
        </form>
      </section>
    </div>

    <script>
      const ITEMS = [
        "ALS910C",
        "ALS900G",
        "ALS955W",
        "ALS970",
        "ALS990",
        "ALS420",
        "ALS610",
        "ALS620",
        "ALS623S",
        "ALS630N",
        "ALS640K",
        "ALS350Y"
      ];

      const SIZES = [
        '1/8"',
        '3/16"',
        '1/4"',
        '5/16"',
        '3/8"',
        '7/16"',
        '1/2"',
        '9/16"',
        '5/8"',
        '11/16"',
        '3/4"',
        '13/16"',
        '(20.6)"',
        '7/8"',
        '1"',
        '1-1/4"'
      ];

      const prodBody = document.getElementById("prodBody");
      const outBody = document.getElementById("outBody");
      const matrixHead = document.querySelector("#matrixTable thead");
      const matrixBody = document.querySelector("#matrixTable tbody");

      const selects = [
        "prodItem",
        "prodSize",
        "outItem",
        "outSize",
        "prodInputItem",
        "prodInputSize",
        "outInputItem",
        "outInputSize"
      ];

      const prodFilter = {
        q: "",
        lot: "",
        item: "",
        size: "",
        from: "",
        to: ""
      };

      const outFilter = {
        q: "",
        order: "",
        lot: "",
        item: "",
        size: "",
        from: "",
        to: ""
      };

      let prodRows = [];
      let outRows = [];

      const mapAllOption = (selectEl) => {
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "(전체)";
        selectEl.appendChild(placeholder);
      };

      const populateSelects = () => {
        selects.forEach((id) => {
          const el = document.getElementById(id);
          el.innerHTML = "";
          const isItem = id.toLowerCase().includes("item");
          if (!id.toLowerCase().includes("input")) {
            mapAllOption(el);
          }
          (isItem ? ITEMS : SIZES).forEach((item) => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            el.appendChild(opt);
          });
        });
      };

      const uid = () =>
        "id-" + Math.random().toString(36).slice(2, 7) + Date.now().toString(36);

      const toNumber = (value) => {
        const n = Number(value);
        return Number.isFinite(n) ? n : 0;
      };

      const matchDate = (value, from, to) => {
        if (!value) return false;
        if (from && value < from) return false;
        if (to && value > to) return false;
        return true;
      };

      const computeRemainingRows = (prod, out) => {
        return prod.map((p) => {
          const used = out
            .filter((o) => o.prodLot === p.lot)
            .reduce((sum, row) => sum + toNumber(row.outLB), 0);
          return {
            ...p,
            remain: toNumber(p.packLB) - used
          };
        });
      };

      const buildCellMatrix = (rows) => {
        const matrix = {};
        SIZES.forEach((size) => {
          matrix[size] = Object.fromEntries(ITEMS.map((item) => [item, []]));
        });
        rows.forEach((row) => {
          const remain = toNumber(row.remain ?? row.packLB);
          if (remain <= 0) return;
          if (!matrix[row.size] || !matrix[row.size][row.item]) return;
          matrix[row.size][row.item].push({
            lot: row.lot,
            remain,
            date: row.date || ""
          });
        });
        SIZES.forEach((size) => {
          ITEMS.forEach((item) => {
            matrix[size][item].sort((a, b) => {
              const da = new Date(a.date || 0).getTime();
              const db = new Date(b.date || 0).getTime();
              if (da !== db) return da - db;
              return a.lot.localeCompare(b.lot);
            });
          });
        });
        return matrix;
      };

      const applyProdFilter = (row) => {
        const text = `${row.lot || ""} ${row.rawLot || ""} ${row.worker || ""} ${
          row.dim || ""
        }`
          .toLowerCase()
          .trim();
        const q = prodFilter.q.toLowerCase().trim();
        if (q && !text.includes(q)) return false;
        if (prodFilter.lot && row.lot !== prodFilter.lot) return false;
        if (prodFilter.item && row.item !== prodFilter.item) return false;
        if (prodFilter.size && row.size !== prodFilter.size) return false;
        if ((prodFilter.from || prodFilter.to) && !matchDate(row.date, prodFilter.from, prodFilter.to))
          return false;
        return true;
      };

      const applyOutFilter = (row) => {
        const text = `${row.orderNo || ""} ${row.power || ""} ${row.unit || ""} ${
          row.useName || ""
        } ${row.worker || ""} ${row.prodLot || ""}`
          .toLowerCase()
          .trim();
        const q = outFilter.q.toLowerCase().trim();
        if (q && !text.includes(q)) return false;
        if (outFilter.order && row.orderNo !== outFilter.order) return false;
        if (outFilter.lot && row.prodLot !== outFilter.lot) return false;
        if (outFilter.item && row.item !== outFilter.item) return false;
        if (outFilter.size && row.size !== outFilter.size) return false;
        if ((outFilter.from || outFilter.to) && !matchDate(row.date, outFilter.from, outFilter.to))
          return false;
        return true;
      };

      const renderMatrix = (rows) => {
        const matrix = buildCellMatrix(rows);
        matrixHead.innerHTML = "";
        matrixBody.innerHTML = "";

        const headRow = document.createElement("tr");
        const first = document.createElement("th");
        first.textContent = "SIZE \\ ITEM";
        first.classList.add("sticky-col");
        headRow.appendChild(first);
        ITEMS.forEach((item) => {
          const th = document.createElement("th");
          th.textContent = item;
          headRow.appendChild(th);
        });
        matrixHead.appendChild(headRow);

        SIZES.forEach((size) => {
          const tr = document.createElement("tr");
          const firstCol = document.createElement("td");
          firstCol.className = "sticky-col";
          firstCol.textContent = size;
          tr.appendChild(firstCol);
          ITEMS.forEach((item) => {
            const td = document.createElement("td");
            const items = matrix[size][item];
            if (items.length === 0) {
              td.innerHTML = '<div class="empty">—</div>';
            } else {
              const list = document.createElement("div");
              list.className = "pill-list";
              items.forEach((entry) => {
                const pill = document.createElement("div");
                pill.className = "pill";
                pill.innerHTML = `<span>${entry.remain.toLocaleString()} LB</span><small>${entry.lot}</small>`;
                list.appendChild(pill);
              });
              td.appendChild(list);
            }
            tr.appendChild(td);
          });
          matrixBody.appendChild(tr);
        });
      };

      const renderProdRows = (rows) => {
        prodBody.innerHTML = "";
        if (rows.length === 0) {
          const empty = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 10;
          td.className = "empty";
          td.textContent = "조건에 맞는 생산 데이터가 없습니다.";
          empty.appendChild(td);
          prodBody.appendChild(empty);
          return;
        }

        rows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.lot || ""}</td>
            <td>${row.date || ""}</td>
            <td>${row.item || ""}</td>
            <td>${row.size || ""}</td>
            <td style="text-align:right">${toNumber(row.packLB).toLocaleString()}</td>
            <td style="text-align:right">${toNumber(row.remain).toLocaleString()}</td>
            <td>${row.rawLot || ""}</td>
            <td>${row.dim || ""}</td>
            <td>${row.worker || ""}</td>
            <td style="text-align:center"><button class="ghost" data-id="${row.id}" data-type="prod">삭제</button></td>
          `;
          prodBody.appendChild(tr);
        });
      };

      const renderOutRows = (rows) => {
        outBody.innerHTML = "";
        if (rows.length === 0) {
          const empty = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 11;
          td.className = "empty";
          td.textContent = "조건에 맞는 출고 데이터가 없습니다.";
          empty.appendChild(td);
          outBody.appendChild(empty);
          return;
        }

        rows.forEach((row) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.date || ""}</td>
            <td>${row.orderNo || ""}</td>
            <td>${row.power || ""}</td>
            <td>${row.unit || ""}</td>
            <td>${row.useName || ""}</td>
            <td>${row.item || ""}</td>
            <td>${row.size || ""}</td>
            <td style="text-align:right">${toNumber(row.outLB).toLocaleString()}</td>
            <td>${row.prodLot || ""}</td>
            <td>${row.worker || ""}</td>
            <td style="text-align:center"><button class="ghost" data-id="${row.id}" data-type="out">삭제</button></td>
          `;
          outBody.appendChild(tr);
        });
      };

      const renderAll = () => {
        const remaining = computeRemainingRows(prodRows, outRows);
        const prodFiltered = remaining.filter(applyProdFilter);
        const outFiltered = outRows.filter(applyOutFilter);
        renderMatrix(remaining);
        renderProdRows(prodFiltered);
        renderOutRows(outFiltered);
      };

      const bindFilters = () => {
        document.getElementById("prodSearch").addEventListener("input", (e) => {
          prodFilter.q = e.target.value;
          renderAll();
        });
        document.getElementById("prodLot").addEventListener("input", (e) => {
          prodFilter.lot = e.target.value;
          renderAll();
        });
        document.getElementById("prodItem").addEventListener("change", (e) => {
          prodFilter.item = e.target.value;
          renderAll();
        });
        document.getElementById("prodSize").addEventListener("change", (e) => {
          prodFilter.size = e.target.value;
          renderAll();
        });
        document.getElementById("prodFrom").addEventListener("change", (e) => {
          prodFilter.from = e.target.value;
          renderAll();
        });
        document.getElementById("prodTo").addEventListener("change", (e) => {
          prodFilter.to = e.target.value;
          renderAll();
        });
        document.getElementById("prodReset").addEventListener("click", () => {
          prodFilter.q = prodFilter.lot = prodFilter.item = prodFilter.size = prodFilter.from = prodFilter.to = "";
          document.getElementById("prodSearch").value = "";
          document.getElementById("prodLot").value = "";
          document.getElementById("prodItem").value = "";
          document.getElementById("prodSize").value = "";
          document.getElementById("prodFrom").value = "";
          document.getElementById("prodTo").value = "";
          renderAll();
        });

        document.getElementById("outSearch").addEventListener("input", (e) => {
          outFilter.q = e.target.value;
          renderAll();
        });
        document.getElementById("outOrder").addEventListener("input", (e) => {
          outFilter.order = e.target.value;
          renderAll();
        });
        document.getElementById("outLot").addEventListener("input", (e) => {
          outFilter.lot = e.target.value;
          renderAll();
        });
        document.getElementById("outItem").addEventListener("change", (e) => {
          outFilter.item = e.target.value;
          renderAll();
        });
        document.getElementById("outSize").addEventListener("change", (e) => {
          outFilter.size = e.target.value;
          renderAll();
        });
        document.getElementById("outFrom").addEventListener("change", (e) => {
          outFilter.from = e.target.value;
          renderAll();
        });
        document.getElementById("outTo").addEventListener("change", (e) => {
          outFilter.to = e.target.value;
          renderAll();
        });
        document.getElementById("outReset").addEventListener("click", () => {
          Object.keys(outFilter).forEach((key) => (outFilter[key] = ""));
          ["outSearch", "outOrder", "outLot", "outItem", "outSize", "outFrom", "outTo"].forEach((id) => {
            const el = document.getElementById(id);
            if (el.tagName === "SELECT") {
              el.value = "";
            } else {
              el.value = "";
            }
          });
          renderAll();
        });
      };

      const bindForms = () => {
        document.getElementById("prodForm").addEventListener("submit", (e) => {
          e.preventDefault();
          const row = {
            id: uid(),
            lot: document.getElementById("prodInputLot").value.trim(),
            date: document.getElementById("prodInputDate").value,
            item: document.getElementById("prodInputItem").value,
            size: document.getElementById("prodInputSize").value,
            packLB: toNumber(document.getElementById("prodInputPack").value),
            rawLot: document.getElementById("prodInputRaw").value.trim(),
            dim: document.getElementById("prodInputDim").value.trim(),
            worker: document.getElementById("prodInputWorker").value.trim()
          };
          if (!row.lot) {
            alert("LOT 번호를 입력해주세요.");
            return;
          }
          prodRows.push(row);
          e.target.reset();
          renderAll();
        });

        document.getElementById("outForm").addEventListener("submit", (e) => {
          e.preventDefault();
          const row = {
            id: uid(),
            date: document.getElementById("outInputDate").value,
            orderNo: document.getElementById("outInputOrder").value.trim(),
            power: document.getElementById("outInputPower").value.trim(),
            unit: document.getElementById("outInputUnit").value.trim(),
            useName: document.getElementById("outInputUse").value.trim(),
            item: document.getElementById("outInputItem").value,
            size: document.getElementById("outInputSize").value,
            outLB: toNumber(document.getElementById("outInputLb").value),
            prodLot: document.getElementById("outInputLot").value.trim(),
            worker: document.getElementById("outInputWorker").value.trim()
          };
          if (!row.prodLot) {
            alert("생산 LOT을 입력해주세요.");
            return;
          }
          outRows.push(row);
          e.target.reset();
          renderAll();
        });
      };

      const bindDeletion = () => {
        document.body.addEventListener("click", (e) => {
          const target = e.target.closest("button[data-id]");
          if (!target) return;
          const { id, type } = target.dataset;
          if (!confirm("정말로 삭제하시겠습니까?")) return;
          if (type === "prod") {
            prodRows = prodRows.filter((row) => row.id !== id);
          } else {
            outRows = outRows.filter((row) => row.id !== id);
          }
          renderAll();
        });
      };

      const runDiagnostics = () => {
        const sampleProd = [
          { id: "p1", lot: "L1", packLB: 10, item: "ALS910C", size: '1/2"', date: "2025-09-20" },
          { id: "p2", lot: "L2", packLB: 5, item: "ALS910C", size: '1/2"', date: "2025-09-21" },
          { id: "p3", lot: "L3", packLB: 8, item: "ALS900G", size: '3/4"', date: "2025-09-19" }
        ];
        const sampleOut = [
          { id: "o1", prodLot: "L1", outLB: 7, date: "2025-09-22" },
          { id: "o2", prodLot: "L2", outLB: 3, date: "2025-09-23" }
        ];
        const result = computeRemainingRows(sampleProd, sampleOut);
        console.assert(result.find((r) => r.lot === "L1").remain === 3, "L1 remain should be 3");
        console.assert(result.find((r) => r.lot === "L2").remain === 2, "L2 remain should be 2");
        console.assert(result.find((r) => r.lot === "L3").remain === 8, "L3 remain should be 8");
        const matrix = buildCellMatrix(result);
        console.assert(Array.isArray(matrix['1/2"']["ALS910C"]) && matrix['1/2"']["ALS910C"].length === 2, "Matrix count mismatch");
        console.log("✅ Diagnostics passed");
      };

      const init = () => {
        populateSelects();
        bindFilters();
        bindForms();
        bindDeletion();
        runDiagnostics();
        renderAll();
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
