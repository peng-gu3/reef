<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>해수어항 관리 도징 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #F0F4F8; }
    .container { max-width: 1200px; margin: auto; padding: 1rem; }
    .input-container, .output-container { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .grid-cols-2 { display: grid; grid-template-columns: repeat(2,1fr); gap: 1rem; }
    .flex-col { display: flex; flex-direction: column; }
    .mb-2 { margin-bottom: 0.5rem; }
    .rounded { border-radius: 0.375rem; }
    .border { border: 1px solid #CBD5E0; }
    .p-2 { padding: 0.5rem; }
    .button { padding: 0.75rem; font-weight: 600; border-radius: 0.375rem; cursor: pointer; }
    .bg-blue { background: #3B82F6; color: white; }
    .bg-green { background: #10B981; color: white; }
    .flex { display: flex; }
    .space-x-4 > * + * { margin-left: 1rem; }
    #graph-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 1rem; border-radius: 0.5rem; max-width: 600px; width: 90%; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-bold text-center mb-6">해수어항 관리 도징 계산기</h1>
    <div class="grid grid-cols-2 gap-6">
      <!-- 입력 영역 -->
      <div class="input-container">
        <h2 class="text-xl font-semibold mb-4">어항 정보 입력</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="flex-col mb-2"><label>날짜</label><input type="date" id="date" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>용량 (L)</label><input type="number" id="volume" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>온도 (°C)</label><input type="number" step="0.1" id="temp" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>염도 (ppt)</label><input type="number" step="0.1" id="salinity" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>pH</label><input type="number" step="0.1" id="ph" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>Ca (ppm)</label><input type="number" id="ca" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>Mg (ppm)</label><input type="number" id="mg" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>KH (dKH)</label><input type="number" step="0.1" id="kh" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>NO₂ (ppm)</label><input type="number" step="0.01" id="no2" class="border p-2 rounded w-full"></div>
          <div class="flex-col mb-2"><label>NO₃ (ppm)</label><input type="number" step="0.01" id="no3" class="border p-2 rounded w-full"></div>
          <div class="flex-col col-span-2 mb-2"><label>PO₄ (ppm)</label><input type="number" step="0.01" id="po4" class="border p-2 rounded w-full"></div>
        </div>
        <div class="flex space-x-4 mt-4">
          <button id="calc-btn" class="button bg-blue flex-1">계산하기</button>
          <button id="save-btn" class="button bg-green flex-1">기록 저장</button>
        </div>
        <p id="status" class="text-center mt-2"></p>
      </div>
      <!-- 결과 영역 -->
      <div class="output-container" id="results" style="display:none;">
        <h2 class="text-xl font-semibold mb-4">계산 결과</h2>
        <div id="results-list"></div>
      </div>
    </div>

    <!-- 기록 및 조작 -->
    <div class="input-container mt-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">저장된 기록</h2>
        <div class="space-x-2">
          <button id="show-chart" class="button bg-blue">그래프 보기</button>
          <button id="reset-logs" class="button bg-green">기록 초기화</button>
        </div>
      </div>
      <div style="overflow-x:auto;"><table id="log-table" class="w-full text-sm"><thead><tr><th>날짜</th><th>온도</th><th>염도</th><th>pH</th><th>Ca</th><th>Mg</th><th>KH</th><th>NO₂</th><th>NO₃</th><th>PO₄</th><th>삭제</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>

  <!-- 차트 모달 -->
  <div id="graph-modal" class="flex hidden" style="display:none;">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <h2 class="text-xl font-semibold mb-4">기록 그래프</h2>
      <canvas id="chart"></canvas>
      <button id="close-modal" class="button bg-blue mt-4">닫기</button>
    </div>
  </div>

  <script>
    // 기준값
    const targets = { temp:[25.5,26.5], sal:[34,35], ph:[8.0,8.3], ca:[400,440,420], mg:[1250,1440,1350], kh:[7.5,8.5,8.0], no2:[0], no3:[0.5,2.0,1.0], po4:[0.03,0.08,0.05] };
    let logs = JSON.parse(localStorage.getItem('logs')||'[]');
    const elems = ['date','volume','temp','salinity','ph','ca','mg','kh','no2','no3','po4'].reduce((o,id)=>{o[id]=document.getElementById(id);return o;},{});
    const statusP = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const resultsList = document.getElementById('results-list');
    const logTableBody = document.querySelector('#log-table tbody');

    // 계산
    document.getElementById('calc-btn').addEventListener('click',()=>{
      resultsList.innerHTML='';
      let has=false;
      Object.keys(targets).forEach(key=>{
        const val=parseFloat(elems[key].value);
        const t=targets[key];
        if(isNaN(val))return;
        has=true;
        let txt,cls='';
        if(key==='ca'||key==='mg'||key==='kh'||key==='no3'||key==='po4'){
          if(val<t[0]){txt=`${key} 낮음: ${t[2]-val}ml 도징 필요.`;cls='low';}
          else if(val>t[1]){txt=`${key} 높음: 환수 권장.`;cls='high';}
          else{txt=`${key} 안정적.`;cls='good';}
        } else if(key==='no2'){txt=val>0?`NO₂ 검출: 교체 필요.`:`NO₂ 안정.`;cls=val>0?'high':'good';}
        else{if(val<t[0]){txt=`${key} 낮음.`;cls='low';}else if(val>t[1]){txt=`${key} 높음.`;cls='high';}else{txt=`${key} 안정.`;cls='good';}}
        const div=document.createElement('div');div.className=`result-item ${'result-'+cls}`;div.textContent=txt;
        resultsList.appendChild(div);
      });
      resultsDiv.style.display=has?'block':'none';
    });

    // 기록 저장
    document.getElementById('save-btn').addEventListener('click',()=>{
      const entry={date:elems.date.value, temp:elems.temp.value, sal:elems.salinity.value, ph:elems.ph.value, ca:elems.ca.value, mg:elems.mg.value, kh:elems.kh.value, no2:elems.no2.value, no3:elems.no3.value, po4:elems.po4.value};
      logs.push(entry);
      localStorage.setItem('logs',JSON.stringify(logs));
      statusP.textContent='저장 완료!';setTimeout(()=>statusP.textContent='',2000);
      renderLogs();
    });

    // 테이블 렌더
    function renderLogs(){logTableBody.innerHTML='';
      logs.forEach((l,i)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${l.date}</td><td>${l.temp}</td><td>${l.sal}</td><td>${l.ph}</td><td>${l.ca}</td><td>${l.mg}</td><td>${l.kh}</td><td>${l.no2}</td><td>${l.no3}</td><td>${l.po4}</td><td><button data-i="${i}">X</button></td>`;logTableBody.append(tr);});}
    logTableBody.addEventListener('click',e=>{if(e.target.dataset.i){logs.splice(e.target.dataset.i,1);localStorage.setItem('logs',JSON.stringify(logs));renderLogs();}});

    // 그래프 모달
    const modal=document.getElementById('graph-modal');
    document.getElementById('show-chart').addEventListener('click',()=>{
      modal.style.display='flex';
      const ctx=document.getElementById('chart').getContext('2d');
      const labels=logs.map(l=>l.date);
      const dataCa=logs.map(l=>l.ca), dataMg=logs.map(l=>l.mg);
      new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Ca',data:dataCa},{label:'Mg',data:dataMg}]}});
    });
    document.getElementById('close-modal').addEventListener('click',()=>modal.style.display='none');

    // 초기화
    document.getElementById('reset-logs').addEventListener('click',()=>{if(confirm('초기화?')){logs=[];localStorage.removeItem('logs');renderLogs();}});

    // 초기 로드
    elems.date.valueAsDate=new Date();renderLogs();
  </script>
</body>
</html>
