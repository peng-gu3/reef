<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 완제품 재고 관리 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .table-auto th, .table-auto td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
        }
        .table-auto thead th {
            background-color: #f8fafc;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">실시간 완제품 재고 관리 시스템</h1>
            <p class="text-gray-600 mt-2">생산 및 출고 내역을 입력하면 재고가 자동으로 업데이트됩니다.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Forms Section -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Production Form -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-600">생산 등록</h2>
                    <form id="production-form" class="space-y-4">
                        <div>
                            <label for="prod-item" class="block text-sm font-medium text-gray-700">ITEM NO.</label>
                            <input type="text" id="prod-item" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: ALS910C" required>
                        </div>
                        <div>
                            <label for="prod-size" class="block text-sm font-medium text-gray-700">SIZE</label>
                            <input type="text" id="prod-size" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 1/8&quot;" required>
                        </div>
                        <div>
                            <label for="prod-lot" class="block text-sm font-medium text-gray-700">LOT NO.</label>
                            <input type="text" id="prod-lot" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="예: 2501C321" required>
                        </div>
                        <div>
                            <label for="prod-quantity" class="block text-sm font-medium text-gray-700">수량 (LB)</label>
                            <input type="number" id="prod-quantity" min="0.1" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">생산 추가</button>
                    </form>
                </div>

                <!-- Shipping Form -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-red-600">출고 등록</h2>
                    <form id="shipping-form" class="space-y-4">
                        <div>
                            <label for="ship-item" class="block text-sm font-medium text-gray-700">ITEM NO.</label>
                             <input type="text" id="ship-item" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="예: ALS910C" required>
                        </div>
                        <div>
                            <label for="ship-size" class="block text-sm font-medium text-gray-700">SIZE</label>
                            <input type="text" id="ship-size" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="예: 1/8&quot;" required>
                        </div>
                        <div>
                            <label for="ship-lot" class="block text-sm font-medium text-gray-700">LOT NO.</label>
                            <input type="text" id="ship-lot" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="출고되는 제품 Lot No." required>
                        </div>
                        <div>
                            <label for="ship-quantity" class="block text-sm font-medium text-gray-700">수량 (LB)</label>
                            <input type="number" id="ship-quantity" min="0.1" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        </div>
                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">출고 처리</button>
                    </form>
                </div>
            </div>

            <!-- Inventory List Section -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">완제품 재고 현황</h2>
                 <div id="loading" class="text-center py-10">
                    <p>데이터를 불러오는 중입니다...</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="inventory-table" class="w-full table-auto text-sm text-left hidden">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3">ITEM NO.</th>
                                <th class="p-3">SIZE</th>
                                <th class="p-3 text-right">현재고 (LB)</th>
                                <th class="p-3">최근 LOT NO.</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <!-- Inventory rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Logs Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">생산 기록</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white"><tr><th>일시</th><th>ITEM</th><th>SIZE</th><th>수량</th><th>LOT</th></tr></thead>
                        <tbody id="production-log"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">출고 기록</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white"><tr><th>일시</th><th>ITEM</th><th>SIZE</th><th>수량</th><th>LOT</th></tr></thead>
                        <tbody id="shipping-log"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for notifications -->
    <div id="modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-sm rounded-lg shadow-xl p-6 text-center transform scale-95">
            <p id="modal-message" class="text-lg"></p>
            <button id="modal-close" class="mt-6 bg-gray-800 text-white font-bold py-2 px-6 rounded-md hover:bg-gray-900 transition duration-150">확인</button>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDK scripts
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, getDocs, setDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            const loadingEl = document.getElementById('loading');

            function startApp() {
                // --- UI Elements ---
                const inventoryTableEl = document.getElementById('inventory-table');
                const inventoryBodyEl = document.getElementById('inventory-body');
                const productionForm = document.getElementById('production-form');
                const shippingForm = document.getElementById('shipping-form');
                const productionLogEl = document.getElementById('production-log');
                const shippingLogEl = document.getElementById('shipping-log');
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modal-message');
                const modalClose = document.getElementById('modal-close');

                // --- App State ---
                let userId = null;
                let localInventory = {};
                let inventoryUnsubscribe = null;
                let productionLogUnsubscribe = null;
                let shippingLogUnsubscribe = null;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // --- Firebase Initialization ---
                let app, auth, db;
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                } catch (error) {
                    console.error("Firebase Initialization Failed:", error);
                    loadingEl.textContent = "시스템 설정 파일이 올바르지 않습니다.";
                    return; // Stop execution
                }

                // --- Utility Functions ---
                function showModal(message) {
                    modalMessage.textContent = message;
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                    setTimeout(() => modal.querySelector('.modal-container').classList.remove('scale-95'), 10);
                }

                function hideModal() {
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-container').classList.add('scale-95');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
                
                modalClose.addEventListener('click', hideModal);

                // --- Rendering Functions ---
                function renderInventory(inventory) {
                    inventoryBodyEl.innerHTML = '';
                    if (Object.keys(inventory).length === 0) {
                         inventoryBodyEl.innerHTML = `<tr><td colspan="4" class="text-center p-5">재고 데이터가 없습니다. 생산 등록을 시작해주세요.</td></tr>`;
                         return;
                    }
                    
                    const sortedItems = Object.keys(inventory).sort();
                    
                    for (const itemNo of sortedItems) {
                        const sizes = inventory[itemNo];
                        if (!sizes) continue;
                        const sortedSizes = Object.keys(sizes).sort();

                        for (const size of sortedSizes) {
                            const data = sizes[size];
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="font-medium">${itemNo}</td>
                                <td>${size}</td>
                                <td class="text-right">${(data.quantity || 0).toFixed(1)}</td>
                                <td>${data.lot || ''}</td>
                            `;
                            inventoryBodyEl.appendChild(row);
                        }
                    }
                }
                
                function renderLog(logEl, logs) {
                    logEl.innerHTML = '';
                    logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="p-2">${log.timestamp?.toDate().toLocaleString('ko-KR', { year:'2-digit', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) || ''}</td>
                            <td class="p-2">${log.itemNo}</td>
                            <td class="p-2">${log.size}</td>
                            <td class="p-2">${log.quantity}</td>
                            <td class="p-2">${log.lot}</td>
                        `;
                        logEl.appendChild(row);
                    });
                }

                // --- Data Fetching and Real-time Updates ---
                async function setupRealtimeListeners() {
                    const inventoryCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'inventory');
                    const productionLogCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'productionLog');
                    const shippingLogCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'shippingLog');
                    
                    const initialCheck = await getDocs(inventoryCollectionRef);
                    if (initialCheck.empty) {
                        await populateInitialData();
                    }

                    inventoryUnsubscribe = onSnapshot(inventoryCollectionRef, (snapshot) => {
                        localInventory = {};
                        snapshot.forEach(doc => {
                            localInventory[doc.id] = doc.data();
                        });
                        renderInventory(localInventory);
                        loadingEl.style.display = 'none';
                        inventoryTableEl.classList.remove('hidden');
                    });
                    
                    productionLogUnsubscribe = onSnapshot(query(productionLogCollectionRef, orderBy('timestamp', 'desc')), (snapshot) => {
                        const logs = snapshot.docs.map(doc => doc.data());
                        renderLog(productionLogEl, logs);
                    });

                    shippingLogUnsubscribe = onSnapshot(query(shippingLogCollectionRef, orderBy('timestamp', 'desc')), (snapshot) => {
                        const logs = snapshot.docs.map(doc => doc.data());
                        renderLog(shippingLogEl, logs);
                    });
                }
                
                async function populateInitialData() {
                    const initialInventory = {
                        "ALS910C": { "1/8\"": { quantity: 10, lot: "181c321" }, "1/4\"": { quantity: 22, lot: "2402C601" } },
                        "ALS900G": { "1/8\"": { quantity: 2, lot: "2301G321" }, "3/4\"": { quantity: 20, lot: "2109G1751" } },
                        "ALS955W": { "3/4\"": { quantity: 22, lot: "2507W19110" } },
                        "ALS610": { "3/4\"": { quantity: 40, lot: "2505A1915" } },
                        "ALS623S": { "1/2\"": { quantity: 51, lot: "2501S1271" } },
                        "ALS630N": { "3/4\"": { quantity: 71, lot: "2509N1915" } },
                    };
                    
                    showModal("초기 재고 데이터를 설정합니다...");
                    const promises = Object.keys(initialInventory).map(itemNo => {
                        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
                        return setDoc(docRef, initialInventory[itemNo]);
                    });

                    await Promise.all(promises);
                }

                // --- Event Handlers ---
                productionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const itemNo = document.getElementById('prod-item').value.trim().toUpperCase();
                    const size = document.getElementById('prod-size').value.trim();
                    const lot = document.getElementById('prod-lot').value.trim();
                    const quantity = parseFloat(document.getElementById('prod-quantity').value);

                    if (!itemNo || !size || !lot || isNaN(quantity) || quantity <= 0) {
                        showModal('모든 필드를 올바르게 입력해주세요.');
                        return;
                    }

                    const inventoryDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
                    const productionLogCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'productionLog');

                    try {
                        await addDoc(productionLogCollectionRef, { itemNo, size, lot, quantity, timestamp: serverTimestamp() });
                        
                        const currentItemData = localInventory[itemNo] || {};
                        const currentSizeData = currentItemData[size] || { quantity: 0 };
                        const currentQuantity = parseFloat(currentSizeData.quantity || 0);
                        const newQuantity = currentQuantity + quantity;
                        
                        await setDoc(inventoryDocRef, { [size]: { quantity: newQuantity, lot: lot } }, { merge: true });

                        showModal('생산 등록이 완료되었습니다.');
                        productionForm.reset();
                    } catch (error) {
                        console.error("Error adding production record: ", error);
                        showModal('오류가 발생했습니다: ' + error.message);
                    }
                });

                shippingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const itemNo = document.getElementById('ship-item').value.trim().toUpperCase();
                    const size = document.getElementById('ship-size').value.trim();
                    const lot = document.getElementById('ship-lot').value.trim();
                    const quantity = parseFloat(document.getElementById('ship-quantity').value);
                    
                    if (!itemNo || !size || !lot || isNaN(quantity) || quantity <= 0) {
                        showModal('모든 필드를 올바르게 입력해주세요.');
                        return;
                    }

                    const inventoryDocRef = doc(db, 'artifacts', appId, 'users', userId, 'inventory', itemNo);
                    const shippingLogCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'shippingLog');
                    
                    const currentItemData = localInventory[itemNo] || {};
                    const currentSizeData = currentItemData[size] || { quantity: 0 };
                    const currentQuantity = parseFloat(currentSizeData.quantity || 0);

                    if (currentQuantity < quantity) {
                        showModal(`재고가 부족합니다. (현재고: ${currentQuantity.toFixed(1)} LB)`);
                        return;
                    }

                    try {
                        await addDoc(shippingLogCollectionRef, { itemNo, size, lot, quantity, timestamp: serverTimestamp() });
                        
                        const newQuantity = currentQuantity - quantity;
                        const existingLot = currentSizeData.lot || '';
                        
                        await setDoc(inventoryDocRef, { [size]: { quantity: newQuantity, lot: existingLot } }, { merge: true });

                        showModal('출고 처리가 완료되었습니다.');
                        shippingForm.reset();
                    } catch (error) {
                        console.error("Error processing shipping: ", error);
                        showModal('오류가 발생했습니다: ' + error.message);
                    }
                });

                // --- App Authentication and Initialization ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (inventoryUnsubscribe) inventoryUnsubscribe();
                        if (productionLogUnsubscribe) productionLogUnsubscribe();
                        if (shippingLogUnsubscribe) shippingLogUnsubscribe();
                        await setupRealtimeListeners();
                    }
                });

                async function main() {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
                        if (token && token.trim() !== '') {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        loadingEl.textContent = "인증에 실패했습니다. 페이지를 새로고침해주세요.";
                    }
                }
                
                main();
            }

            function waitForConfig(retries = 0) {
                if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '') {
                    startApp();
                } else if (retries < 50) { // Wait up to 5 seconds
                    setTimeout(() => waitForConfig(retries + 1), 100);
                } else {
                    loadingEl.textContent = "시스템 설정 로딩에 실패했습니다. 새로고침 해주세요.";
                    console.error("Could not find __firebase_config after 5 seconds.");
                }
            }

            waitForConfig();
        });
    </script>
</body>
</html>

