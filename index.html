import React, { useState, useMemo, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Plus, Trash2 } from "lucide-react";

const ITEMS = [
  "ALS910C","ALS900G","ALS955W","ALS970","ALS990","ALS420","ALS610","ALS620","ALS623S","ALS630N","ALS640K","ALS350Y"
];
const SIZES = [
  '1/8"','3/16"','1/4"','5/16"','3/8"','7/16"','1/2"','9/16"','5/8"','11/16"','3/4"','13/16"','(20.6)"','7/8"','1"','1-1/4"'
];

// ===== Helpers =====
const uid = () => Math.random().toString(36).slice(2,9);
const ALL = "__ALL__"; // placeholder value for SelectItem (non-empty)
const mapAllToEmpty = (v) => (v === ALL ? "" : v);

// Pure helper for tests and state derivations
function computeRemainingRows(prodRows, outRows){
  return prodRows.map(p=>{
    const used = outRows
      .filter(o=>o.prodLot===p.lot)
      .reduce((s,o)=>s+(Number(o.outLB)||0),0);
    const remain = (Number(p.packLB)||0) - used;
    return { ...p, remain };
  });
}

export default function InventoryDashboard(){
  // data states
  const [prodRows, setProdRows] = useState([]);
  const [outRows, setOutRows] = useState([]);

  // single-line input states
  const [prodInput, setProdInput] = useState({lot:"", date:"", item:ITEMS[0], size:SIZES[0], packLB:"", rawLot:"", dim:"", worker:""});
  const [outInput, setOutInput] = useState({date:"", orderNo:"", power:"", unit:"", useName:"", item:ITEMS[0], size:SIZES[0], outLB:"", prodLot:"", worker:""});

  // filter states (검색/필터)
  const [prodFilter, setProdFilter] = useState({q:"", lot:"", item:"", size:"", from:"", to:""});
  const [outFilter, setOutFilter] = useState({q:"", lot:"", item:"", size:"", from:"", to:"", order:""});

  // 출고 반영 잔량 계산 (LOT 기준 차감)
  const remainingRows = useMemo(()=> computeRemainingRows(prodRows, outRows), [prodRows, outRows]);

  // ====== 재고 현황판(실시간)용 셀 매트릭스 ======
  function buildCellMatrix(rows){
    // size -> item -> [{lot, remain, date}]
    const m = {};
    for(const s of SIZES){ m[s] = Object.fromEntries(ITEMS.map(i=>[i,[]])); }
    for(const r of rows){
      const remain = Number(r.remain ?? r.packLB) || 0;
      if(remain <= 0) continue; // 0 이하는 표시 안함
      if(!m[r.size] || !m[r.size][r.item]) continue;
      m[r.size][r.item].push({ lot: r.lot, remain, date: r.date || "" });
    }
    // 정렬: 날짜 오름차순 -> LOT 문자열
    for(const s of SIZES){
      for(const it of ITEMS){
        m[s][it].sort((a,b)=>{
          const da = new Date(a.date||0).getTime();
          const db = new Date(b.date||0).getTime();
          if(da!==db) return da-db; return a.lot.localeCompare(b.lot);
        });
      }
    }
    return m;
  }
  const cellMatrix = useMemo(()=>buildCellMatrix(remainingRows),[remainingRows]);

  // ===== Filters =====
  const matchDate = (d, from, to) => {
    if(!d) return false; // 빈 날짜는 기본적으로 검색에서 제외
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  };

  const prodFiltered = useMemo(()=>{
    return remainingRows.filter(r=>{
      const q = prodFilter.q.trim().toLowerCase();
      const text = `${r.lot||""} ${r.rawLot||""} ${r.worker||""} ${r.dim||""}`.toLowerCase();
      if(q && !text.includes(q)) return false;
      if(prodFilter.lot && (r.lot||"") !== prodFilter.lot) return false;
      if(prodFilter.item && r.item !== prodFilter.item) return false;
      if(prodFilter.size && r.size !== prodFilter.size) return false;
      if(prodFilter.from || prodFilter.to){
        if(!matchDate(r.date, prodFilter.from, prodFilter.to)) return false;
      }
      return true;
    });
  },[remainingRows, prodFilter]);

  const outFiltered = useMemo(()=>{
    return outRows.filter(r=>{
      const q = outFilter.q.trim().toLowerCase();
      const text = `${r.orderNo||""} ${r.power||""} ${r.unit||""} ${r.useName||""} ${r.worker||""} ${r.prodLot||""}`.toLowerCase();
      if(q && !text.includes(q)) return false;
      if(outFilter.order && r.orderNo !== outFilter.order) return false;
      if(outFilter.lot && r.prodLot !== outFilter.lot) return false;
      if(outFilter.item && r.item !== outFilter.item) return false;
      if(outFilter.size && r.size !== outFilter.size) return false;
      if(outFilter.from || outFilter.to){
        if(!matchDate(r.date, outFilter.from, outFilter.to)) return false;
      }
      return true;
    });
  },[outRows, outFilter]);

  // ===== Actions =====
  const addProd = () => {
    setProdRows(v=>[...v,{id:uid(),...prodInput}]);
    setProdInput({lot:"", date:"", item:ITEMS[0], size:SIZES[0], packLB:"", rawLot:"", dim:"", worker:""});
  };
  const delProd = (id) => setProdRows(v=>v.filter(r=>r.id!==id));

  const addOut = () => {
    setOutRows(v=>[...v,{id:uid(),...outInput}]);
    setOutInput({date:"", orderNo:"", power:"", unit:"", useName:"", item:ITEMS[0], size:SIZES[0], outLB:"", prodLot:"", worker:""});
  };
  const delOut = (id) => setOutRows(v=>v.filter(r=>r.id!==id));

  const resetProdFilter = () => setProdFilter({q:"", lot:"", item:"", size:"", from:"", to:""});
  const resetOutFilter = () => setOutFilter({q:"", lot:"", item:"", size:"", from:"", to:"", order:""});

  // ===== Lightweight tests (pure, no state mutation) =====
  useEffect(()=>{
    console.assert(mapAllToEmpty(ALL)==="", "TEST FAIL: mapAllToEmpty(ALL) !== ''");
    console.assert(mapAllToEmpty("ALS910C")==="ALS910C", "TEST FAIL: mapAllToEmpty passthrough failed");
    const p = [
      {id:"p1", lot:"L1", packLB:10, item:"ALS910C", size:'1/2"', date:"2025-09-20"},
      {id:"p2", lot:"L2", packLB:5, item:"ALS910C", size:'1/2"', date:"2025-09-21"},
      {id:"p3", lot:"L3", packLB:8, item:"ALS900G", size:'3/4"', date:"2025-09-19"},
    ];
    const o = [
      {id:"o1", prodLot:"L1", outLB:7, date:"2025-09-22"},
      {id:"o2", prodLot:"L2", outLB:3, date:"2025-09-23"},
    ];
    const res = computeRemainingRows(p,o);
    console.assert(res.find(r=>r.lot==="L1").remain===3, "TEST FAIL: L1 remain !== 3");
    console.assert(res.find(r=>r.lot==="L2").remain===2, "TEST FAIL: L2 remain !== 2");
    console.assert(res.find(r=>r.lot==="L3").remain===8, "TEST FAIL: L3 remain !== 8");
    const m = buildCellMatrix(res);
    console.assert(Array.isArray(m['1/2"']["ALS910C"]) && m['1/2"']["ALS910C"].length===2, "TEST FAIL: cellMatrix count for 1/2 × ALS910C");
    console.log("✅ TESTS PASSED (mapping, remaining, date, matrix)");
  },[]);

  return (
    <div className="min-h-screen p-6 grid gap-6 bg-gray-50">
      <h1 className="text-2xl font-semibold">예스폼 스타일 재고관리 대시보드</h1>

      {/* 재고 현황판 (실시간) : SIZE × ITEM, 각 셀에 LOT별 잔량 개별 표시 */}
<Card className="shadow">
  <CardContent className="p-4 space-y-3">
    <div className="text-lg font-medium">재고 현황판 (실시간)</div>
    <div className="overflow-auto">
      <table className="min-w-full border text-sm">
        <thead>
          <tr>
            <th className="sticky left-0 bg-gray-100 border px-2 py-1">SIZE \ ITEM</th>
            {ITEMS.map(it=> (
              <th key={it} className="border px-2 py-1 text-center text-gray-700">{it}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {SIZES.map((sz, idx)=> (
            <tr key={sz} className={idx%2?"bg-gray-50":"bg-white"}>
              <td className="sticky left-0 bg-gray-100 border px-2 py-1 font-medium">{sz}</td>
              {ITEMS.map(it=> (
                <td key={it+sz} className="border px-2 py-1 align-top min-w-[160px]">
                  {cellMatrix[sz]?.[it]?.length ? (
                    <ul className="space-y-1">
                      {cellMatrix[sz][it].map((e, i)=> (
                        <li key={e.lot+"_"+i} className="px-2 py-1 rounded-xl bg-gray-100 flex items-center justify-between">
                          <span className="font-medium">{e.remain} LB</span>
                          <span className="text-xs text-gray-600">{e.lot}</span>
                        </li>
                      ))}
                    </ul>
                  ) : (
                    <div className="text-gray-300 text-center">—</div>
                  )}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </CardContent>
</Card>

{/* 재고관리대장 (생산 내역 + 출고 반영 잔량) */}
<Card className="shadow">
  <CardContent className="p-4 space-y-3">
    <div className="flex items-center justify-between">
      <div className="text-lg font-medium">재고관리대장 (검색/필터 가능)</div>
    </div>

    {/* 생산 내역 검색바 */}
    <div className="grid grid-cols-12 gap-2">
      <Input className="col-span-3" placeholder="검색어(LOT/원자재LOT/작업자/치수)" value={prodFilter.q} onChange={e=>setProdFilter({...prodFilter,q:e.target.value})}/>
      <Input className="col-span-2" placeholder="LOT" value={prodFilter.lot} onChange={e=>setProdFilter({...prodFilter,lot:e.target.value})}/>
      <Select value={prodFilter.item || undefined} onValueChange={val=>setProdFilter({...prodFilter,item:mapAllToEmpty(val)})}>
        <SelectTrigger className="col-span-2"><SelectValue placeholder="ITEM 선택"/></SelectTrigger>
        <SelectContent>
          <SelectItem value={ALL}>(전체)</SelectItem>
          {ITEMS.map(i=> <SelectItem key={i} value={i}>{i}</SelectItem>)}
        </SelectContent>
      </Select>
      <Select value={prodFilter.size || undefined} onValueChange={val=>setProdFilter({...prodFilter,size:mapAllToEmpty(val)})}>
        <SelectTrigger className="col-span-2"><SelectValue placeholder="SIZE 선택"/></SelectTrigger>
        <SelectContent>
          <SelectItem value={ALL}>(전체)</SelectItem>
          {SIZES.map(s=> <SelectItem key={s} value={s}>{s}</SelectItem>)}
        </SelectContent>
      </Select>
      <Input type="date" className="col-span-1" value={prodFilter.from} onChange={e=>setProdFilter({...prodFilter,from:e.target.value})}/>
      <Input type="date" className="col-span-1" value={prodFilter.to} onChange={e=>setProdFilter({...prodFilter,to:e.target.value})}/>
      <Button variant="secondary" className="col-span-1" onClick={resetProdFilter}>초기화</Button>
    </div>

    {/* 생산 내역 표 (잔량 반영) */}
    <div className="overflow-auto">
      <table className="min-w-full border text-sm">
        <thead>
          <tr>
            <th className="border px-2 py-1">LOT</th>
            <th className="border px-2 py-1">생산일자</th>
            <th className="border px-2 py-1">ITEM</th>
            <th className="border px-2 py-1">SIZE</th>
            <th className="border px-2 py-1">포장(LB)</th>
            <th className="border px-2 py-1">출고후 잔량(LB)</th>
            <th className="border px-2 py-1">원자재 LOT</th>
            <th className="border px-2 py-1">치수</th>
            <th className="border px-2 py-1">작업자</th>
            <th className="border px-2 py-1">삭제</th>
          </tr>
        </thead>
        <tbody>
          {prodFiltered.map(p=> (
            <tr key={p.id}>
              <td className="border px-2 py-1">{p.lot}</td>
              <td className="border px-2 py-1">{p.date}</td>
              <td className="border px-2 py-1">{p.item}</td>
              <td className="border px-2 py-1">{p.size}</td>
              <td className="border px-2 py-1 text-right">{p.packLB}</td>
              <td className="border px-2 py-1 text-right">{p.remain}</td>
              <td className="border px-2 py-1">{p.rawLot}</td>
              <td className="border px-2 py-1">{p.dim}</td>
              <td className="border px-2 py-1">{p.worker}</td>
              <td className="border px-2 py-1"><Button variant="ghost" onClick={()=>delProd(p.id)}><Trash2 className="w-4 h-4"/></Button></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </CardContent>
</Card>

      {/* 생산리스트 입력 (단일 입력줄) */}
      <Card className="shadow">
        <CardContent className="p-4 space-y-3">
          <div className="text-lg font-medium">생산리스트 입력</div>
          <div className="grid grid-cols-12 gap-2 items-center p-2 rounded-xl bg-white shadow-sm">
            <Input className="col-span-2" placeholder="LOT. NO" value={prodInput.lot} onChange={e=>setProdInput({...prodInput,lot:e.target.value})}/>
            <Input type="date" className="col-span-2" value={prodInput.date} onChange={e=>setProdInput({...prodInput,date:e.target.value})}/>
            <Select value={prodInput.item} onValueChange={val=>setProdInput({...prodInput,item:val})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="ITEM"/></SelectTrigger>
              <SelectContent>{ITEMS.map(i=> <SelectItem key={i} value={i}>{i}</SelectItem>)}</SelectContent>
            </Select>
            <Select value={prodInput.size} onValueChange={val=>setProdInput({...prodInput,size:val})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="SIZE"/></SelectTrigger>
              <SelectContent>{SIZES.map(s=> <SelectItem key={s} value={s}>{s}</SelectItem>)}</SelectContent>
            </Select>
            <Input type="number" className="col-span-1" placeholder="포장(LB)" value={prodInput.packLB} onChange={e=>setProdInput({...prodInput,packLB:e.target.value})}/>
            <Input className="col-span-2" placeholder="원자재 LOT" value={prodInput.rawLot} onChange={e=>setProdInput({...prodInput,rawLot:e.target.value})}/>
            <Input className="col-span-1" placeholder="치수" value={prodInput.dim} onChange={e=>setProdInput({...prodInput,dim:e.target.value})}/>
            <Input className="col-span-2" placeholder="작업자" value={prodInput.worker} onChange={e=>setProdInput({...prodInput,worker:e.target.value})}/>
            <Button onClick={addProd}><Plus className="w-4 h-4 mr-1"/>저장</Button>
          </div>
        </CardContent>
      </Card>

      {/* 출고리스트 입력 (단일 입력줄) + 검색/필터 + 내역표 */}
      <Card className="shadow">
        <CardContent className="p-4 space-y-3">
          <div className="text-lg font-medium">출고리스트 입력</div>
          <div className="grid grid-cols-12 gap-2 items-center p-2 rounded-xl bg-white shadow-sm">
            <Input type="date" className="col-span-2" placeholder="출고일자" value={outInput.date} onChange={e=>setOutInput({...outInput,date:e.target.value})}/>
            <Input className="col-span-2" placeholder="Order No." value={outInput.orderNo} onChange={e=>setOutInput({...outInput,orderNo:e.target.value})}/>
            <Input className="col-span-2" placeholder="발전소명" value={outInput.power} onChange={e=>setOutInput({...outInput,power:e.target.value})}/>
            <Input className="col-span-1" placeholder="호기명" value={outInput.unit} onChange={e=>setOutInput({...outInput,unit:e.target.value})}/>
            <Input className="col-span-2" placeholder="용도명" value={outInput.useName} onChange={e=>setOutInput({...outInput,useName:e.target.value})}/>
            <Select value={outInput.item} onValueChange={val=>setOutInput({...outInput,item:val})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="ITEM"/></SelectTrigger>
              <SelectContent>{ITEMS.map(i=> <SelectItem key={i} value={i}>{i}</SelectItem>)}</SelectContent>
            </Select>
            <Select value={outInput.size} onValueChange={val=>setOutInput({...outInput,size:val})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="SIZE"/></SelectTrigger>
              <SelectContent>{SIZES.map(s=> <SelectItem key={s} value={s}>{s}</SelectItem>)}</SelectContent>
            </Select>
            <Input type="number" className="col-span-1" placeholder="출고(LB)" value={outInput.outLB} onChange={e=>setOutInput({...outInput,outLB:e.target.value})}/>
            <Input className="col-span-2" placeholder="생산 LOT" value={outInput.prodLot} onChange={e=>setOutInput({...outInput,prodLot:e.target.value})}/>
            <Input className="col-span-2" placeholder="출고자" value={outInput.worker} onChange={e=>setOutInput({...outInput,worker:e.target.value})}/>
            <Button onClick={addOut}><Plus className="w-4 h-4 mr-1"/>저장</Button>
          </div>

          {/* 출고 검색바 */}
          <div className="grid grid-cols-12 gap-2">
            <Input className="col-span-3" placeholder="검색어(오더/발전소/용도/출고자/LOT)" value={outFilter.q} onChange={e=>setOutFilter({...outFilter,q:e.target.value})}/>
            <Input className="col-span-2" placeholder="Order No" value={outFilter.order} onChange={e=>setOutFilter({...outFilter,order:e.target.value})}/>
            <Input className="col-span-2" placeholder="생산 LOT" value={outFilter.lot} onChange={e=>setOutFilter({...outFilter,lot:e.target.value})}/>
            <Select value={outFilter.item || undefined} onValueChange={val=>setOutFilter({...outFilter,item:mapAllToEmpty(val)})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="ITEM 선택"/></SelectTrigger>
              <SelectContent>
                <SelectItem value={ALL}>(전체)</SelectItem>
                {ITEMS.map(i=> <SelectItem key={i} value={i}>{i}</SelectItem>)}
              </SelectContent>
            </Select>
            <Select value={outFilter.size || undefined} onValueChange={val=>setOutFilter({...outFilter,size:mapAllToEmpty(val)})}>
              <SelectTrigger className="col-span-2"><SelectValue placeholder="SIZE 선택"/></SelectTrigger>
              <SelectContent>
                <SelectItem value={ALL}>(전체)</SelectItem>
                {SIZES.map(s=> <SelectItem key={s} value={s}>{s}</SelectItem>)}
              </SelectContent>
            </Select>
            <Input type="date" className="col-span-1" value={outFilter.from} onChange={e=>setOutFilter({...outFilter,from:e.target.value})}/>
            <Input type="date" className="col-span-1" value={outFilter.to} onChange={e=>setOutFilter({...outFilter,to:e.target.value})}/>
            <Button variant="secondary" className="col-span-1" onClick={resetOutFilter}>초기화</Button>
          </div>

          {/* 출고 내역 표 */}
          <div className="overflow-auto">
            <table className="min-w-full border text-sm">
              <thead>
                <tr>
                  <th className="border px-2 py-1">출고일자</th>
                  <th className="border px-2 py-1">Order No</th>
                  <th className="border px-2 py-1">발전소</th>
                  <th className="border px-2 py-1">호기</th>
                  <th className="border px-2 py-1">용도</th>
                  <th className="border px-2 py-1">ITEM</th>
                  <th className="border px-2 py-1">SIZE</th>
                  <th className="border px-2 py-1">출고(LB)</th>
                  <th className="border px-2 py-1">생산 LOT</th>
                  <th className="border px-2 py-1">출고자</th>
                  <th className="border px-2 py-1">삭제</th>
                </tr>
              </thead>
              <tbody>
                {outFiltered.map(o=> (
                  <tr key={o.id}>
                    <td className="border px-2 py-1">{o.date}</td>
                    <td className="border px-2 py-1">{o.orderNo}</td>
                    <td className="border px-2 py-1">{o.power}</td>
                    <td className="border px-2 py-1">{o.unit}</td>
                    <td className="border px-2 py-1">{o.useName}</td>
                    <td className="border px-2 py-1">{o.item}</td>
                    <td className="border px-2 py-1">{o.size}</td>
                    <td className="border px-2 py-1 text-right">{o.outLB}</td>
                    <td className="border px-2 py-1">{o.prodLot}</td>
                    <td className="border px-2 py-1">{o.worker}</td>
                    <td className="border px-2 py-1"><Button variant="ghost" onClick={()=>delOut(o.id)}><Trash2 className="w-4 h-4"/></Button></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
