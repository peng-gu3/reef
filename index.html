<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì¼ì§€ ë‚´êº¼!!!!!!!!!!</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --red: #ef4444; --red-bg: #fef2f2; --red-text: #b91c1c;
            --blue: #3b82f6; --blue-bg: #eff6ff; --blue-text: #1d4ed8;
            --green: #22c55e; --green-bg: #dcfce7; --green-text: #15803d;
            --gray: #64748b; --gray-bg: #f1f5f9; --gray-text: #334155;
            --bg: #f1f5f9; --surface: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 30px 15px; line-height: 1.4; font-size: 14px; }
        
        /* ìº¡ì²˜ ì‹œ ë°°ê²½ì´ í°ìƒ‰ì´ ë˜ë„ë¡ ì»¨í…Œì´ë„ˆ ì„¤ì • */
        .container { max-width: 1200px; margin: 0 auto; background: var(--surface); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        
        /* í—¤ë” & ì»¨íŠ¸ë¡¤ */
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .main-title { font-size: 24px; font-weight: 900; margin: 0; letter-spacing: -0.5px; display:flex; align-items:center; gap:10px; }
        .control-group { display:flex; gap:8px; align-items:center; }
        .util-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 700; color: var(--text-sub); font-size: 13px; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display:flex; align-items:center; gap:5px; }
        .util-btn:hover { background: #f8fafc; color: var(--text-main); transform: translateY(-1px); }
        .util-btn.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }

        /* ê²€ìƒ‰ ë°” */
        .search-bar { width: 100%; margin-bottom: 20px; position:relative; }
        .search-bar input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border); font-size: 14px; box-shadow: var(--shadow); outline:none; transition:0.2s; }
        .search-bar input:focus { border-color: var(--blue); }

        /* ì‹œí¬ë¦¿ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        body.privacy-mode .summary-wrapper, 
        body.privacy-mode .dashboard-row,
        body.privacy-mode .search-bar { display: none !important; }
        body.privacy-mode .day .profit-val { display: none !important; } /* ìˆ˜ìµê¸ˆ í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        body.privacy-mode .day-emoji { display:none !important; } /* ì´ëª¨ì§€ ìˆ¨ê¹€ */

        .summary-wrapper { transition: all 0.3s ease; }        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 11px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; }
        .stat-card p { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; z-index: 1; }
        .stat-card .sub-stat { font-size: 11px; color: #94a3b8; font-weight: 500; margin-top: 2px; }
        .text-up { color: var(--red-text); } .text-down { color: var(--blue-text); } .text-neutral { color: var(--text-main); }
        
        /* ì°¨íŠ¸ ì˜ì—­ */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }
        .chart-card { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid var(--border); height: 250px; position: relative; }
        
        /* ëŒ€ì‹œë³´ë“œ (ë¦¬ìŠ¤íŠ¸) */
        .dashboard-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        @media (max-width: 768px) { .dashboard-row { grid-template-columns: 1fr; } }
        .panel { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid var(--border); height: 300px; overflow-y: auto; display: flex; flex-direction: column; }
        .panel-header { font-size: 14px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }
        
        .history-list { flex: 1; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .item-info { display: flex; flex-direction: column; gap: 1px; }
        .item-name { font-weight: 700; font-size: 13px; }
        .item-date { font-size: 10px; color: var(--text-sub); }
        .item-memo { font-size: 11px; color: var(--text-sub); background:#f8fafc; padding:2px 4px; border-radius:4px; margin-top:2px; width:fit-content; }
        .item-val { font-weight: 700; text-align: right; }
        
        /* ë±ƒì§€ ë¯¸ë‹ˆ */
        .badge-mini { font-size: 10px; padding: 2px 5px; border-radius: 4px; margin-right: 5px; font-weight: 700; display: inline-block; min-width: 24px; text-align: center; }
        .badge-red { background: var(--red-bg); color: var(--red-text); }
        .badge-blue { background: var(--blue-bg); color: var(--blue-text); }
        .badge-green { background: var(--green-bg); color: var(--green-text); }

        /* ë‹¬ë ¥ */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--bg); padding: 10px 15px; border-radius: 12px; }
        .calendar-header h2 { margin: 0; font-size: 18px; font-weight: 800; }
        .btn-nav { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; color: var(--text-sub); }
        .btn-nav:hover { background: #f1f5f9; color: var(--text-main); }

        .calendar-wrapper { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 15px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-header { text-align: center; font-weight: 700; color: var(--text-sub); padding-bottom: 5px; font-size: 12px; }
        .day { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; min-height: 110px; padding: 6px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; position: relative; transition: 0.1s; }
        .day:hover { border-color: var(--blue); z-index: 10; transform: scale(1.02); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .day.today { border-color: var(--blue); border-width: 2px; }
        
        .day-num-wrapper { display:flex; justify-content:space-between; align-items:center; margin-bottom:2px; }
        .day-num { font-size: 12px; font-weight: 700; color: var(--text-sub); }
        .day.today .day-num { background: var(--blue); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; }
        .day-emoji { font-size:14px; } 

        /* ë‹¬ë ¥ ë±ƒì§€ ìƒì„¸ ìŠ¤íƒ€ì¼ */
        .badge { font-size: 10px; padding: 4px 5px; border-radius: 6px; font-weight: 600; display:flex; flex-direction:column; gap:1px; margin-bottom:2px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .badge.red-theme { background: var(--red-bg); color: var(--red-text); border: 1px solid rgba(248,113,113,0.2); }
        .badge.blue-theme { background: var(--blue-bg); color: var(--blue-text); border: 1px solid rgba(59,130,246,0.2); }
        .badge.green-theme { background: var(--green-bg); color: var(--green-text); border: 1px solid rgba(34,197,94,0.2); }
        .badge.sold-out { opacity: 0.6; text-decoration: line-through; background:#f1f5f9; color:#94a3b8; border-color:#e2e8f0; }
        
        .badge-header { display:flex; justify-content:space-between; align-items:center; }
        .badge-title { font-weight:800; font-size:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .badge-days { font-size:9px; background:rgba(255,255,255,0.6); padding:0 3px; border-radius:3px; }
        .badge-detail { display:flex; justify-content:space-between; font-size:9px; opacity:0.85; margin-top:2px; font-family:'Roboto', sans-serif; }

        /* ê³„ì‚°ê¸° ëª¨ë‹¬ */
        .calc-modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:300px; background:var(--surface); padding:20px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:3000; border:1px solid var(--border); }
        .calc-row { display:flex; justify-content:space-between; margin-bottom:10px; align-items:center; font-size:13px; font-weight:600; }
        .calc-input { width:60% !important; padding:8px !important; text-align:right; font-weight:700; }
        .calc-result-box { background:var(--bg); padding:15px; border-radius:8px; text-align:center; margin-top:15px; border:1px solid var(--border); }
        .calc-result-val { font-size:20px; font-weight:800; color:var(--blue-text); }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 2000; justify-content: center; align-items: center; }
        .modal { background: white; border-radius: 16px; width: 450px; max-width: 95%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background:#f8fafc; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 12px; font-weight: 700; color: var(--text-sub); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; box-sizing: border-box; outline: none; }
        .form-group input:focus, .form-group select:focus { border-color: var(--blue); }
        .btn-group { display: flex; gap: 8px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
        .btn-save { background: var(--text-main); color: white; }
        .btn-close { background: #e2e8f0; color: var(--text-sub); }
        
        .list-header { font-size: 12px; font-weight: 800; color: var(--text-sub); margin: 0 0 8px 0; display:flex; justify-content:space-between; }
        .log-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .btn-row button { margin-left: 4px; padding: 3px 6px; font-size: 11px; cursor: pointer; border-radius: 4px; border: 1px solid #cbd5e1; background: #fff; font-weight:600; }
        
        .profit-pos { color: #ef4444; font-weight:800; }
        .profit-neg { color: #3b82f6; font-weight:800; }
    </style>
</head>
<body>
<div class="container" id="captureTarget">
    <div class="main-header">í•˜ë£¨ 20ë§Œ  ë²Œì–´ë³´ì!        <h1 class="main-title">h1<
        <div class="control-group">
            <button class="util-btn" onclick="captureScreen()">ğŸ“· ìŠ¤í¬ë¦°ìƒ·</button>
            <button class="util-btn" onclick="openCalc()">ğŸ§® ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°</button>
            <button class="util-btn active" id="togglePrivacyBtn" onclick="togglePrivacy()">ğŸ”’ ë‹¬ë ¥ë§Œ ë³´ê¸°</button>
            <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
            <button class="util-btn" onclick="exportData()">ğŸ’¾ ë°±ì—…</button>
            <button class="util-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ë³µêµ¬</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)" accept=".json">
        </div>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” ì¢…ëª©ëª… ê²€ìƒ‰" oninput="handleSearch()">
    </div>

    <div class="summary-wrapper">
        <div class="summary-grid">
            <div class="stat-card"><h3>ğŸ’° ì´ ëˆ„ì  ì†ìµ</h3><p id="totalProfit">0ì›</p></div>
            <div class="stat-card"><h3>ğŸ“‰ ì´ë²ˆ ë‹¬ ìˆ˜ìµ</h3><p id="monthProfit">0ì›</p></div>
            <div class="stat-card"><h3>ğŸŒ ê¸ˆì¼ ìˆ˜ìµ</h3><p id="todayProfit">0ì›</p></div>
            <div class="stat-card"><h3>ğŸ¯ ìŠ¹ë¥  (Win Rate)</h3><p id="winRate">0%</p><div class="sub-stat" id="winLossCnt">0ìŠ¹ 0íŒ¨</div></div>
            <div class="stat-card"><h3>ğŸ§® Profit Factor</h3><p id="profitFactor">0.0</p><div class="sub-stat">ì´ìˆ˜ìµ/ì´ì†ì‹¤</div></div>
            <div class="stat-card"><h3>âš–ï¸ í‰ê·  ì†ìµë¹„</h3><p id="avgRatio">0:0</p><div class="sub-stat">í‰ê· ìµ:í‰ê· ì†</div></div>
            <div class="stat-card"><h3>â±ï¸ í‰ê·  ë³´ìœ ì¼</h3><p id="avgHold">0ì¼</p></div>
        </div>
        <div class="charts-row">
            <div class="chart-card"><canvas id="assetChart"></canvas></div>
            <div class="chart-card"><canvas id="winLossChart"></canvas></div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="panel">
            <div class="panel-header">ğŸ“ ìµœê·¼ ë§¤ë§¤ ë‚´ì—­</div>
            <div id="recentHistoryList" class="history-list"></div>
        </div>
        <div class="panel">
            <div class="panel-header">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (ìˆ˜ìµ TOP 5)</div>
            <div id="top5List" class="history-list"></div>
        </div>
    </div>

    <div class="calendar-header">
        <button class="btn-nav" onclick="changeMonth(-1)">â—€ ì´ì „</button>
        <h2 id="currentMonthLabel"></h2>
        <button class="btn-nav" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
    </div>
    <div class="calendar-wrapper"><div class="calendar" id="calendarGrid"></div></div>
</div>

<div id="calcModal" class="calc-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h3 style="margin:0; font-size:16px;">ğŸ§® í‰ë‹¨ê°€(ë¬¼íƒ€ê¸°) ê³„ì‚°</h3>
        <span onclick="closeCalc()" style="cursor:pointer; font-size:20px;">&times;</span>
    </div>
    <div class="calc-row"><label>í˜„ì¬ ë‹¨ê°€</label><input type="number" id="c_curPrice" class="calc-input" placeholder="0"></div>
    <div class="calc-row"><label>í˜„ì¬ ìˆ˜ëŸ‰</label><input type="number" id="c_curQty" class="calc-input" placeholder="0"></div>
    <div style="height:1px; background:var(--border); margin:10px 0;"></div>
    <div class="calc-row"><label style="color:var(--red-text)">ì¶”ê°€ ë‹¨ê°€</label><input type="number" id="c_addPrice" class="calc-input" placeholder="0"></div>
    <div class="calc-row"><label style="color:var(--red-text)">ì¶”ê°€ ìˆ˜ëŸ‰</label><input type="number" id="c_addQty" class="calc-input" placeholder="0"></div>
    <button class="btn" style="background:var(--blue); color:white; margin-top:10px;" onclick="runCalc()">ê³„ì‚°í•˜ê¸°</button>
    <div class="calc-result-box">
        <div style="font-size:12px; color:var(--text-sub);">ì˜ˆìƒ í‰ë‹¨ê°€</div>
        <div id="c_resultAvg" class="calc-result-val">-</div>
        <div style="font-size:11px; margin-top:5px; color:var(--text-sub);">ì´ ìˆ˜ëŸ‰: <span id="c_resultQty">0</span>ì£¼ / ì´ì•¡: <span id="c_resultAmt">0</span></div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle" style="margin:0; font-size:16px; font-weight:800;">ê±°ë˜ ì…ë ¥</h2>
            <button onclick="closeModal()" style="border:none; background:none; font-size:20px; color:#999; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-section">
                <div id="sellInfoBox" style="background:#eff6ff; border:1px solid #dbeafe; color:#1e40af; padding:10px; border-radius:8px; font-size:12px; margin-bottom:10px; display:none; align-items:center; gap:5px;">
                    <strong>â„¹ï¸ í†µí•© ë³´ìœ :</strong> í‰ë‹¨ <span id="infoBuyPrice">0</span>ì› / ì´ ì”ì—¬ <span id="infoRemQty">0</span>ì£¼
                </div>
                <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="inputDate"></div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 10px;">
                    <div class="form-group"><label>êµ¬ë¶„</label>
                        <select id="inputType" onchange="handleTypeChange()">
                            <option value="buy">ë§¤ìˆ˜ (Buy)</option>
                            <option value="sell">ë§¤ë„ (Sell)</option>
                            <option value="other">ê¸°íƒ€ (ì˜ˆìˆ˜ê¸ˆ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="nameLabel">ì¢…ëª©ëª…</label>
                        <input type="text" id="inputName" placeholder="ì¢…ëª©ëª… ì…ë ¥">
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label id="priceLabel">ë‹¨ê°€</label><input type="number" id="inputPrice" placeholder="ì›" oninput="calc()"></div>
                    <div class="form-group"><label>ìˆ˜ëŸ‰</label><input type="number" id="inputQty" value="1" placeholder="ì£¼" oninput="calc()"></div>
                </div>
                <div class="form-group"><label>ğŸ“ ë§¤ë§¤ ë©”ëª¨ (ë³µê¸°)</label><textarea id="inputMemo" rows="2" placeholder="ì§„ì…/ì²­ì‚° ì´ìœ ..."></textarea></div>
                
                <div style="text-align: right; font-size: 13px; color: var(--text-sub); margin-top:5px;">í•©ê³„: <strong id="calcTotal" style="color:var(--text-main); font-size:15px;">0</strong> ì›</div>
                <div class="btn-group">
                    <button class="btn btn-close" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn btn-save" onclick="save()">ì €ì¥</button>
                </div>
            </div>
            <div id="logSection">
                <div class="list-header"><span>ğŸ“… ë‹¹ì¼ ê¸°ë¡</span></div>
                <div id="dayLogList"></div>
                <div class="list-header" style="margin-top:15px; color:#3b82f6;"><span>ğŸ“¦ í†µí•© ë³´ìœ  ëª©ë¡ (í‰ë‹¨ê°€ ì ìš©)</span></div>
                <div id="holdingsList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentDate=new Date(), transactions=JSON.parse(localStorage.getItem('stockData_v7'))||[], currentMode='new', editingId=null, sellTargetName=null;
    let assetChart=null, winLossChart=null;

    function init(){ renderCalendar(); updateSummary(); renderDashboard(); }
    function formatMoney(n){ return n.toLocaleString()+'ì›'; }
    function getHoldingDays(d){ return Math.ceil((new Date().setHours(0,0,0,0) - new Date(d).setHours(0,0,0,0))/(1000*60*60*24)); }

    // --- ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ---
    function captureScreen() {
        const target = document.getElementById('captureTarget');
        html2canvas(target, { backgroundColor: "#ffffff", scale: 2 }).then(canvas => {
            let link = document.createElement('a');
            link.download = 'trading_journal.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }

    // --- ì‹œí¬ë¦¿ ëª¨ë“œ ---
    function togglePrivacy() {
        document.body.classList.toggle('privacy-mode');
        const btn = document.getElementById('togglePrivacyBtn');
        if (document.body.classList.contains('privacy-mode')) {
            btn.innerText = 'ğŸ”“ ì „ì²´ ë³´ê¸°'; btn.classList.remove('active');
        } else {
            btn.innerText = 'ğŸ”’ ë‹¬ë ¥ë§Œ ë³´ê¸°'; btn.classList.add('active');
        }
    }

    // --- ê³„ì‚°ê¸° ---
    function openCalc() { document.getElementById('calcModal').style.display='block'; }
    function closeCalc() { document.getElementById('calcModal').style.display='none'; }
    function runCalc() {
        let cp=Number(document.getElementById('c_curPrice').value);
        let cq=Number(document.getElementById('c_curQty').value);
        let ap=Number(document.getElementById('c_addPrice').value);
        let aq=Number(document.getElementById('c_addQty').value);
        if(!cp||!cq||!ap||!aq){ alert("ê°’ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }
        
        let tAmt = (cp*cq)+(ap*aq);
        let tQty = cq+aq;
        let avg = tAmt/tQty;
        document.getElementById('c_resultAvg').innerText = Math.round(avg).toLocaleString()+'ì›';
        document.getElementById('c_resultQty').innerText = tQty.toLocaleString();
        document.getElementById('c_resultAmt').innerText = (Math.round(tAmt/10000)).toLocaleString()+'ë§Œ';
    }

    // --- í†µê³„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
    function updateSummary() {
        let tp=0, mp=0, dp=0, sc=0, lc=0, totalWinAmt=0, totalLossAmt=0;
        let totalHoldDays=0, holdCount=0;
        let todayStr = new Date().toISOString().split('T')[0];
        let cm = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
        
        let dateMap = new Map();
        let runningTotal = 0;
        let sorted = [...transactions].sort((a,b)=>new Date(a.date)-new Date(b.date));

        sorted.forEach(t => {
            if(t.type==='sell'){
                let p = t.profit || 0;
                tp += p;
                if(t.date.startsWith(cm)) mp += p;
                if(t.date === todayStr) dp += p;
                if(p >= 0) { sc++; totalWinAmt += p; } else { lc++; totalLossAmt += Math.abs(p); }
                
                // ë³´ìœ ì¼ìˆ˜ í†µê³„ (ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°ë§Œ)
                if(t.holdDays) { totalHoldDays+=t.holdDays; holdCount++; }
                runningTotal += p;
            } else if(t.type==='other'){
                tp += t.price;
                if(t.date.startsWith(cm)) mp += t.price;
                if(t.date === todayStr) dp += t.price;
                runningTotal += t.price;
            }
            dateMap.set(t.date, runningTotal);
        });

        document.getElementById('totalProfit').innerText = formatMoney(tp);
        document.getElementById('totalProfit').className = tp>=0 ? 'text-up':'text-down';
        document.getElementById('monthProfit').innerText = formatMoney(mp);
        document.getElementById('monthProfit').className = mp>=0 ? 'text-up':'text-down';
        document.getElementById('todayProfit').innerText = formatMoney(dp);
        document.getElementById('todayProfit').className = dp>=0 ? 'text-up':'text-down';

        let totalTrades = sc + lc;
        let winRate = totalTrades > 0 ? ((sc / totalTrades) * 100).toFixed(1) : 0;
        document.getElementById('winRate').innerText = `${winRate}%`;
        document.getElementById('winLossCnt').innerText = `${sc}ìŠ¹ ${lc}íŒ¨`;

        let pf = totalLossAmt > 0 ? (totalWinAmt / totalLossAmt).toFixed(2) : (totalWinAmt>0 ? 'âˆ' : '0.0');
        document.getElementById('profitFactor').innerText = pf;
        
        let avgWin = sc > 0 ? Math.round(totalWinAmt / sc) : 0;
        let avgLoss = lc > 0 ? Math.round(totalLossAmt / lc) : 0;
        document.getElementById('avgRatio').innerText = `${(avgWin/10000).toFixed(1)} : ${(avgLoss/10000).toFixed(1)}`;
        
        let ah = holdCount > 0 ? Math.round(totalHoldDays/holdCount) : 0;
        document.getElementById('avgHold').innerText = `${ah}ì¼`;
        
        // ì°¨íŠ¸ ë Œë”ë§
        renderCharts(dateMap, sc, lc);
    }

    function renderCharts(dateMap, sc, lc){
        const ctx1 = document.getElementById('assetChart').getContext('2d');
        if(assetChart) assetChart.destroy();
        assetChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: Array.from(dateMap.keys()),
                datasets: [{
                    label: 'ëˆ„ì  ì†ìµ',
                    data: Array.from(dateMap.values()),
                    borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 2, tension: 0.3, fill: true, pointRadius: 2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {display:false} } }
        });

        const ctx2 = document.getElementById('winLossChart').getContext('2d');
        if(winLossChart) winLossChart.destroy();
        winLossChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['ìˆ˜ìµ', 'ì†ì‹¤'],
                datasets: [{ data: [sc, lc], backgroundColor: ['#ef4444', '#3b82f6'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom'} } }
        });
    }

    function handleSearch(){
        let query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = transactions.filter(t => t.name.toLowerCase().includes(query));
        renderDashboard(filtered);
        if(query === '') renderDashboard();
    }

    function renderDashboard(sourceData = transactions) {
        const recentBox = document.getElementById('recentHistoryList');
        let sorted = [...sourceData].sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id).slice(0, 15);
        let html = '';
        if(sorted.length === 0) html = '<div style="text-align:center; color:#ccc; padding:20px;">ê¸°ë¡ ì—†ìŒ</div>';
        else {
            sorted.forEach(t => {
                let badgeClass='', badgeText='', valText='';
                if(t.type === 'buy') { badgeClass='badge-red'; badgeText='ë§¤ìˆ˜'; valText=`${t.qty}ì£¼`; }
                else if(t.type === 'sell') { badgeClass = (t.profit>=0) ? 'badge-red' : 'badge-blue'; badgeText='ë§¤ë„'; valText=`${(t.profit||0).toLocaleString()}ì›`; } 
                else { badgeClass='badge-green'; badgeText='ê¸°íƒ€'; valText=`${t.price.toLocaleString()}ì›`; }
                
                let memoHtml = t.memo ? `<div class="item-memo">ğŸ“ ${t.memo}</div>` : '';
                let holdHtml = (t.type==='sell' && t.holdDays) ? `<span style="font-size:10px; color:#94a3b8; margin-left:5px;">(D+${t.holdDays})</span>` : '';

                html += `<div class="history-item">
                    <div class="item-info"><div><span class="badge-mini ${badgeClass}">${badgeText}</span> <span class="item-name">${t.name}</span>${holdHtml}</div><span class="item-date">${t.date}</span>${memoHtml}</div>
                    <div class="item-val" style="color:${(t.type==='sell' && t.profit<0)?'var(--blue-text)':'inherit'}">${valText}</div>
                </div>`;
            });
        }
        recentBox.innerHTML = html;

        const topBox = document.getElementById('top5List');
        let best = transactions.filter(t=>t.type==='sell' && t.profit>0).sort((a,b)=>b.profit-a.profit).slice(0,5);
        let html2 = '';
        if(best.length===0) html2 = '<div style="text-align:center; color:#ccc; padding:20px;">ìˆ˜ìµ ê¸°ë¡ ì—†ìŒ</div>';
        else {
            best.forEach((t,i) => {
                html2 += `<div class="history-item"><div class="item-info"><span class="item-name">${i+1}. ${t.name}</span><span class="item-date">${t.date}</span></div><div class="item-val text-up">+${t.profit.toLocaleString()}</div></div>`;
            });
        }
        topBox.innerHTML = html2;
    }

    // --- ë‹¬ë ¥ ---
    function renderCalendar(){
        const grid=document.getElementById('calendarGrid'), y=currentDate.getFullYear(), m=currentDate.getMonth();
        document.getElementById('currentMonthLabel').innerText=`${y}ë…„ ${m+1}ì›”`;
        grid.innerHTML=`<div class="day-header" style="color:#ef4444">ì¼</div><div class="day-header">ì›”</div><div class="day-header">í™”</div><div class="day-header">ìˆ˜</div><div class="day-header">ëª©</div><div class="day-header">ê¸ˆ</div><div class="day-header" style="color:#3b82f6">í† </div>`;
        const first=new Date(y,m,1).getDay(), last=new Date(y,m+1,0).getDate();
        for(let i=0;i<first;i++) grid.innerHTML+=`<div class="day" style="opacity:0; pointer-events:none;"></div>`;

        let maxProfitInMonth = 0;
        for(let i=1; i<=last; i++) {
            const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            let dailySum = 0;
            transactions.filter(t=>t.date===dStr && t.type==='sell').forEach(l=> dailySum += (l.profit||0));
            if(Math.abs(dailySum) > maxProfitInMonth) maxProfitInMonth = Math.abs(dailySum);
        }

        for(let i=1;i<=last;i++){
            const dStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const isToday=new Date().toISOString().split('T')[0]===dStr;
            const logs=transactions.filter(t=>t.date===dStr);
            let prof=0, hasSell=false, hasBuy=false;
            logs.forEach(l=>{ 
                if(l.type==='sell'){ hasSell=true; prof+=(l.profit||0); }
                if(l.type==='buy') hasBuy=true;
            });

            let emoji = '';
            if(hasSell) emoji += (prof > 0 ? 'ğŸ˜„' : 'ğŸ˜­');
            if(hasBuy) emoji += 'ğŸ”¥';

            let textColor = '';
            if(hasSell && maxProfitInMonth > 0) {
                let ratio = Math.abs(prof) / maxProfitInMonth;
                let alpha = 0.4 + (ratio * 0.6); 
                if(prof >= 0) textColor = `rgba(239, 68, 68, ${alpha})`;
                else textColor = `rgba(59, 130, 246, ${alpha})`;
            } else if(hasSell) {
                textColor = prof >= 0 ? '#ef4444' : '#3b82f6';
            }

            let html=`<div class="day ${isToday?'today':''}" onclick="openModal('${dStr}')">
                <div class="day-num-wrapper">
                    <span class="day-num">${i}</span>
                    <span class="day-emoji">${emoji}</span>
                </div>`;
            
            logs.forEach(l=>{
                if(l.type==='buy'){
                    let so=l.remainingQty===0;
                    html+=`<div class="badge red-theme ${so?'sold-out':''}">
                        <div class="badge-header"><span class="badge-title">${l.name}</span></div>
                        <div class="badge-detail"><span>${l.qty}ì£¼</span><span>@${l.price.toLocaleString()}</span></div>
                    </div>`;
                }else if(l.type==='sell'){
                    let w=l.profit>=0;
                    let daysInfo = l.holdDays ? `<span class="badge-days">D+${l.holdDays}</span>` : '';
                    html+=`<div class="badge ${w?'red-theme':'blue-theme'}">
                        <div class="badge-header"><span class="badge-title">${l.name}</span>${daysInfo}</div>
                        <div class="badge-detail"><span>${l.qty}ì£¼</span><span>${w?'+':''}${l.profit.toLocaleString()}</span></div>
                    </div>`;
                }else{ 
                    html+=`<div class="badge green-theme">
                        <div class="badge-header"><span class="badge-title">${l.name}</span></div>
                        <div class="badge-detail"><span>${l.price.toLocaleString()}</span></div>
                    </div>`; 
                }
            });

            if(hasSell) html+=`<div class="profit-val" style="margin-top:auto; font-size:11px; font-weight:800; text-align:right; color:${textColor};">${prof>=0?'+':''}${prof.toLocaleString()}</div>`;
            grid.innerHTML+=html+`</div>`;
        }
    }

    function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); renderCalendar(); }
    
    // --- ëª¨ë‹¬ & ë¡œì§ ---
    function openModal(dStr){
        currentMode='new'; sellTargetName=null; editingId=null;
        document.getElementById('modalOverlay').style.display='flex';
        document.getElementById('inputDate').value=dStr;
        document.getElementById('inputType').disabled=false; document.getElementById('inputType').value='buy';
        document.getElementById('inputName').readOnly=false; document.getElementById('inputName').value='';
        document.getElementById('inputPrice').value=''; document.getElementById('inputQty').value=''; document.getElementById('inputMemo').value='';
        document.getElementById('sellInfoBox').style.display='none';
        handleTypeChange(); renderLog(dStr); renderHold();
    }
    
    function closeModal(){ document.getElementById('modalOverlay').style.display='none'; }
    
    function editLog(id){
        let t=transactions.find(x=>x.id===id); if(!t)return;
        editingId=id; currentMode='edit';
        document.getElementById('inputDate').value=t.date;
        document.getElementById('inputType').value=t.type; document.getElementById('inputType').disabled=true;
        document.getElementById('inputName').value=t.name; document.getElementById('inputPrice').value=t.price; document.getElementById('inputQty').value=t.qty; document.getElementById('inputMemo').value=t.memo||'';
        handleTypeChange();
        if(t.type==='sell'){ document.getElementById('inputName').readOnly=true; } 
        else { document.getElementById('inputName').readOnly=false; }
        calc();
    }

    function initiateSell(nameStr, totalQty, avgPrice){
        currentMode='sell_new'; sellTargetName=nameStr; editingId=null;
        document.getElementById('inputType').value='sell'; document.getElementById('inputType').disabled=true;
        document.getElementById('inputName').value=nameStr; document.getElementById('inputName').readOnly=true;
        document.getElementById('inputPrice').value=''; 
        document.getElementById('inputQty').value=totalQty;
        document.getElementById('inputQty').disabled=false; 
        document.getElementById('inputMemo').value='';
        
        document.getElementById('sellInfoBox').style.display='flex'; 
        document.getElementById('infoBuyPrice').innerText=Math.round(avgPrice).toLocaleString(); 
        document.getElementById('infoRemQty').innerText=totalQty;
        
        handleTypeChange(); calc();
    }

    function handleTypeChange(){
        let t=document.getElementById('inputType').value, pl=document.getElementById('priceLabel'), qi=document.getElementById('inputQty');
        if(t==='buy'){ pl.innerText="ë§¤ìˆ˜ ë‹¨ê°€"; qi.disabled=false; } else if(t==='sell'){ pl.innerText="ë§¤ë„ ë‹¨ê°€"; qi.disabled=false; }
        else{ pl.innerText="ê¸ˆì•¡ (+/-)"; qi.value=1; qi.disabled=true; }
        calc();
    }
    
    function calc(){ document.getElementById('calcTotal').innerText = (Number(document.getElementById('inputPrice').value)*Number(document.getElementById('inputQty').value)).toLocaleString(); }
    
    function save(){
        let d=document.getElementById('inputDate').value, t=document.getElementById('inputType').value, n=document.getElementById('inputName').value, p=Number(document.getElementById('inputPrice').value), q=Number(document.getElementById('inputQty').value), m=document.getElementById('inputMemo').value;
        if(!n||(!p && p!==0)||!q){ alert("ì…ë ¥ í™•ì¸"); return; }
        
        if(editingId){
            let tg=transactions.find(x=>x.id===editingId);
            if(tg){
                tg.date=d; tg.name=n; tg.price=p; tg.memo=m;
                editingId=null;
            }
        } else {
            if(t==='sell'){
                let targets = transactions.filter(x => x.type === 'buy' && x.name === n && x.remainingQty > 0)
                                          .sort((a,b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
                
                let totalAvailable = targets.reduce((acc,cur)=>acc+cur.remainingQty, 0);
                if(q > totalAvailable){ alert(`ë³´ìœ  ìˆ˜ëŸ‰ ë¶€ì¡±! (ìµœëŒ€: ${totalAvailable}ì£¼)`); return; }

                // ë³´ìœ ì¼ìˆ˜ ê³„ì‚° (ê°€ì¥ ë¨¼ì € ì‚° ì£¼ì‹ì˜ ë‚ ì§œ ê¸°ì¤€)
                let firstBuyDate = targets.length > 0 ? targets[0].date : d;
                let hDays = Math.ceil((new Date(d) - new Date(firstBuyDate))/(1000*60*60*24));

                let totalCost = targets.reduce((acc,cur) => acc + (cur.remainingQty * cur.price), 0);
                let avgPrice = totalCost / totalAvailable;
                
                let remainingSellQty = q;
                targets.forEach(buyItem => {
                    if(remainingSellQty > 0) {
                        let deduct = Math.min(buyItem.remainingQty, remainingSellQty);
                        buyItem.remainingQty -= deduct;
                        remainingSellQty -= deduct;
                    }
                });

                let profit = Math.round((p - avgPrice) * q);
                transactions.push({
                    id: Date.now(), date: d, type: 'sell', name: n, price: p, qty: q, 
                    profit: profit, memo: m, holdDays: hDays
                });

            } else if(t==='buy'){
                transactions.push({id:Date.now(), date:d, type:'buy', name:n, price:p, qty:q, remainingQty:q, memo:m}); 
            } else { 
                transactions.push({id:Date.now(), date:d, type:'other', name:n, price:p, qty:1, memo:m}); 
            }
        }
        
        localStorage.setItem('stockData_v7', JSON.stringify(transactions));
        
        if(t==='sell') closeModal(); 
        else { 
            document.getElementById('inputName').value=''; document.getElementById('inputPrice').value=''; document.getElementById('inputMemo').value=''; 
            if(t==='buy') document.getElementById('inputQty').value=''; 
            renderLog(d); renderHold(); 
        }
        init();
    }

    function renderLog(dStr){
        let l=document.getElementById('dayLogList'), logs=transactions.filter(x=>x.date===dStr), h='';
        if(logs.length===0) h='<div style="text-align:center;color:#ccc;">ê¸°ë¡ ì—†ìŒ</div>';
        logs.forEach(g=>{
            let btn=`<div class="btn-row"><button onclick="editLog(${g.id})">ìˆ˜ì •</button><button onclick="del(${g.id})">ì‚­ì œ</button></div>`;
            let mH = g.memo ? `<div style="font-size:11px; color:#64748b; background:#f1f5f9; padding:2px 4px; border-radius:4px; margin-top:2px;">ğŸ“ ${g.memo}</div>`:'';
            if(g.type==='buy') h+=`<div class="log-item" style="border-left:3px solid var(--red);"><div class="item-info"><span class="item-name">[ë§¤ìˆ˜] ${g.name}</span><span style="font-size:11px; color:#64748b;">${g.qty}ì£¼ @ ${g.price}</span>${mH}</div>${btn}</div>`;
            else if(g.type==='sell') h+=`<div class="log-item" style="border-left:3px solid ${g.profit>=0?'var(--red)':'var(--blue)'};"><div class="item-info"><span class="item-name">[ë§¤ë„] ${g.name}</span><span style="font-size:11px; color:${g.profit>=0?'#ef4444':'#3b82f6'};">${g.profit>=0?'+':''}${g.profit} (${g.holdDays? 'D+'+g.holdDays : '-'})</span>${mH}</div>${btn}</div>`;
            else h+=`<div class="log-item" style="border-left:3px solid var(--green);"><div class="item-info"><span class="item-name">[ê¸°íƒ€] ${g.name}</span><span style="font-size:11px;">${g.price}</span>${mH}</div>${btn}</div>`;
        });
        l.innerHTML=h;
    }

    function renderHold(){
        let l=document.getElementById('holdingsList');
        let holdings = {};
        transactions.filter(x => x.type === 'buy' && x.remainingQty > 0).forEach(t => {
            if(!holdings[t.name]) {
                holdings[t.name] = { totalQty: 0, totalCost: 0, firstDate: t.date };
            }
            holdings[t.name].totalQty += t.remainingQty;
            holdings[t.name].totalCost += (t.remainingQty * t.price);
            if(new Date(t.date) < new Date(holdings[t.name].firstDate)) holdings[t.name].firstDate = t.date;
        });

        let h = '';
        const names = Object.keys(holdings);
        if(names.length === 0) h='<div style="text-align:center;color:#ccc;">ë³´ìœ  ì—†ìŒ</div>';
        
        names.forEach(name => {
            let item = holdings[name];
            let avgPrice = item.totalCost / item.totalQty;
            let dy = getHoldingDays(item.firstDate);
            
            h += `<div class="log-item" style="border-left:3px solid var(--blue);">
                    <div class="item-info">
                        <span class="item-name">${name}</span>
                        <span style="font-size:11px; color:#64748b;">í‰ë‹¨ ${Math.round(avgPrice).toLocaleString()}ì› / ì”ì—¬ ${item.totalQty}ì£¼ / D+${dy}</span>
                    </div>
                    <div class="btn-row">
                        <button onclick="initiateSell('${name}', ${item.totalQty}, ${avgPrice})" style="background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe;">ë§¤ë„</button>
                    </div>
                  </div>`;
        });

        l.innerHTML = h;
    }

    function del(id){
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê²½ê³ : ì—°ê²°ëœ ë§¤ìˆ˜/ë§¤ë„ ê¸°ë¡ì´ ê¼¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"))return;
        transactions=transactions.filter(x=>x.id!==id);
        localStorage.setItem('stockData_v7', JSON.stringify(transactions));
        init(); renderLog(document.getElementById('inputDate').value); renderHold();
    }
    
    function exportData(){
        const a = document.createElement('a');
        a.href = 'data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(transactions));
        a.download = 'stock_full_backup.json'; a.click();
    }
    
    function importData(input){
        const r = new FileReader();
        r.onload = e => { if(confirm("ë³µêµ¬?")){ transactions=JSON.parse(e.target.result); localStorage.setItem('stockData_v7',JSON.stringify(transactions)); location.reload(); }};
        if(input.files[0]) r.readAsText(input.files[0]);
    }

    init();
</script>
</body>
</html>
